!function(){var Ajax={};Ajax.settings={},Ajax.post=function(a){return new AjaxRequest("post",a)},Ajax.get=function(a){return new AjaxRequest("get",a)};var AjaxRequest=function(a,b){var c={method:a,url:"",before:function(){},success:function(){},error:function(){},data:!1,async:!0,headers:{}};this.p=this.extend(c,b),this.p=this.extend(this.p,Ajax.settings),this.p.method=this.p.method.toUpperCase(),this.prepareData(),this.xhr=new XMLHttpRequest,this.xhr.open(this.p.method,this.p.url,this.p.async),this.setHeaders(),!1!==("function"!=typeof this.p.before||this.p.before(this.xhr))&&this.send()};AjaxRequest.prototype={extend:function(a,b){if(b)for(var c in b)a[c]=b[c];return a},prepareData:function(){"POST"!==this.p.method||this.isFormData()||(this.p.headers["Content-Type"]="application/x-www-form-urlencoded"),"object"!=typeof this.p.data||this.isFormData()||(this.p.data=this.toParams(this.p.data)),"GET"===this.p.method&&(this.p.url=this.p.data?this.p.url+"?"+this.p.data:this.p.url)},setHeaders:function(){this.xhr.setRequestHeader("X-Requested-With",this.p.headers["X-Requested-With"]||"XMLHttpRequest");for(var a in this.p.headers)this.xhr.setRequestHeader(a,this.p.headers[a])},isFormData:function(){return void 0!==window.FormData&&this.p.data instanceof window.FormData},isComplete:function(){return!(this.xhr.status<200||this.xhr.status>=300&&304!==this.xhr.status)},send:function(){this.p.async?(this.xhr.onload=this.loaded.bind(this),this.xhr.send(this.p.data)):(this.xhr.send(this.p.data),this.loaded.call(this))},loaded:function(){if(this.isComplete()){var a=this.xhr.response,b=this.parseJson(a);a=b||a,"function"==typeof this.p.success&&this.p.success(a,this.xhr)}else"function"==typeof this.p.error&&this.p.error(this.xhr.statusText)},parseJson:function(a){try{var b=JSON.parse(a);if(b&&"object"==typeof b)return b}catch(a){}return!1},toParams:function(a){return Object.keys(a).map(function(b){return encodeURIComponent(b)+"="+encodeURIComponent(a[b])}).join("&")}};var DomCache=[0],DomExpando="data"+(new Date).getTime(),DomHClass="is-hidden",DomHMClass="is-hidden-mobile",Dom=function(a,b){return this.parse(a,b)};Dom.ready=function(a){"loading"!=document.readyState?a():document.addEventListener("DOMContentLoaded",a)},Dom.prototype={get dom(){return!0},get length(){return this.nodes.length},parse:function(a,b){var c,d=/^\s*<(\w+|!)[^>]*>/;if(a){if(a.dom)return this.nodes=a.nodes,a;c="string"!=typeof a?a.nodeType&&11===a.nodeType?a.childNodes:a.nodeType||a===window?[a]:a:d.test(a)?this.create(a):this._query(a,b)}else c=[];this.nodes=this._slice(c)},create:function(a){if(/^<(\w+)\s*\/?>(?:<\/\1>|)$/.test(a))return[document.createElement(RegExp.$1)];var b=[],c=document.createElement("div"),d=c.childNodes;c.innerHTML=a;for(var e=0,f=d.length;e<f;e++)b.push(d[e]);return b},add:function(a){this.nodes=this.nodes.concat(this._toArray(a))},get:function(a){return this.nodes[a||0]||!1},getAll:function(){return this.nodes},eq:function(a){return new Dom(this.nodes[a])},first:function(){return new Dom(this.nodes[0])},last:function(){return new Dom(this.nodes[this.nodes.length-1])},contents:function(){return this.get().childNodes},each:function(a){for(var b=this.nodes.length,c=0;c<b;c++)a.call(this,this.nodes[c].dom?this.nodes[c].get():this.nodes[c],c);return this},is:function(a){return this.filter(a).length>0},filter:function(a){var b;return void 0===a?this:(b="function"==typeof a?a:function(b){return a instanceof Node?a===b:a&&a.dom?-1!==a.nodes.indexOf(b):(b.matches=b.matches||b.msMatchesSelector||b.webkitMatchesSelector,1===b.nodeType&&b.matches(a||"*"))},new Dom(this.nodes.filter(b)))},not:function(a){return this.filter(function(b){return!new Dom(b).is(a||!0)})},find:function(a){var b=[];return this.each(function(c){for(var d=this._query(a||"*",c),e=0;e<d.length;e++)b.push(d[e])}),new Dom(b)},children:function(a){var b=[];return this.each(function(a){if(a.children)for(var c=a.children,d=0;d<c.length;d++)b.push(c[d])}),new Dom(b).filter(a)},parent:function(a){var b=[];return this.each(function(a){a.parentNode&&b.push(a.parentNode)}),new Dom(b).filter(a)},parents:function(a,b){b=this._getContext(b);var c=[];return this.each(function(d){for(var e=d.parentNode;e&&e!==b;)a?new Dom(e).is(a)&&c.push(e):c.push(e),e=e.parentNode}),new Dom(c)},closest:function(a,b){b=this._getContext(b),a=a.dom?a.get():a;var c=[],d=a&&a.nodeType;return this.each(function(e){do{if(d&&e===a||new Dom(e).is(a))return c.push(e)}while((e=e.parentNode)&&e!==b)}),new Dom(c)},next:function(a){return this._getSibling(a,"nextSibling")},nextElement:function(a){return this._getSibling(a,"nextElementSibling")},prev:function(a){return this._getSibling(a,"previousSibling")},prevElement:function(a){return this._getSibling(a,"previousElementSibling")},css:function(a,b){if(void 0===b&&"object"!=typeof a){var c=this.get();return"width"===a||"height"===a?c.style?this._getHeightOrWidth(a,c,!1)+"px":void 0:c.style?getComputedStyle(c,null)[a]:void 0}return this.each(function(c){var d={};"object"==typeof a?d=a:d[a]=b;for(var e in d)c.style&&(c.style[e]=d[e])})},attr:function(a,b,c){if(c=c?"data-":"",void 0===b&&"object"!=typeof a){var d=this.get();return d&&3!==d.nodeType?"checked"===a?d.checked:this._getBooleanFromStr(d.getAttribute(c+a)):void 0}return this.each(function(d){var e={};"object"==typeof a?e=a:e[a]=b;for(var f in e)3!==d.nodeType&&("checked"===f?d.checked=e[f]:d.setAttribute(c+f,e[f]))})},data:function(a,b){if(void 0===a){var c=/^data\-(.+)$/,d=this.get().attributes,e={},f=function(a){return a[1].toUpperCase()};for(var g in d)if(d[g]&&c.test(d[g].nodeName)){var h=d[g].nodeName.match(c)[1],i=d[g].value;h=h.replace(/-([a-z])/g,f),i=this._isObjectString(i)?this._toObject(i):this._isNumber(i)?parseFloat(i):this._getBooleanFromStr(i),e[h]=i}return e}return this.attr(a,b,!0)},val:function(a){if(void 0===a){var b=this.get();return b.type&&"checkbox"===b.type?b.checked:b.value}return this.each(function(b){b.value=a})},removeAttr:function(a){return this.each(function(b){var c=function(a){3!==b.nodeType&&b.removeAttribute(a)};a.split(" ").forEach(c)})},removeData:function(a){return this.each(function(b){var c=function(a){3!==b.nodeType&&b.removeAttribute("data-"+a)};a.split(" ").forEach(c)})},dataset:function(a,b){return this.each(function(c){DomCache[this.dataindex(c)][a]=b})},dataget:function(a){return DomCache[this.dataindex(this.get())][a]},dataindex:function(a){var b=a[DomExpando],c=DomCache.length;return b||(b=a[DomExpando]=c,DomCache[b]={}),b},addClass:function(a){return this._eachClass(a,"add")},removeClass:function(a){return this._eachClass(a,"remove")},toggleClass:function(a){return this._eachClass(a,"toggle")},hasClass:function(a){return this.nodes.some(function(b){return!!b.classList&&b.classList.contains(a)})},empty:function(){return this.each(function(a){a.innerHTML=""})},html:function(a){return void 0===a?this.get().innerHTML||"":this.empty().append(a)},text:function(a){return void 0===a?this.get().textContent||"":this.each(function(b){b.textContent=a})},after:function(a){return this._inject(a,function(a,b){if("string"==typeof a)b.insertAdjacentHTML("afterend",a);else for(var c=a instanceof Node?[a]:this._toArray(a).reverse(),d=0;d<c.length;d++)b.parentNode.insertBefore(c[d],b.nextSibling);return b})},before:function(a){return this._inject(a,function(a,b){if("string"==typeof a)b.insertAdjacentHTML("beforebegin",a);else for(var c=a instanceof Node?[a]:this._toArray(a),d=0;d<c.length;d++)b.parentNode.insertBefore(c[d],b);return b})},append:function(a){return this._inject(a,function(a,b){if("string"==typeof a||"number"==typeof a)b.insertAdjacentHTML("beforeend",a);else for(var c=a instanceof Node?[a]:this._toArray(a),d=0;d<c.length;d++)b.appendChild(c[d]);return b})},prepend:function(a){return this._inject(a,function(a,b){if("string"==typeof a||"number"==typeof a)b.insertAdjacentHTML("afterbegin",a);else for(var c=a instanceof Node?[a]:this._toArray(a).reverse(),d=0;d<c.length;d++)b.insertBefore(c[d],b.firstChild);return b})},wrap:function(a){return this._inject(a,function(a,b){var c="string"==typeof a||"number"==typeof a?this.create(a)[0]:a instanceof Node?a:this._toArray(a)[0];return b.parentNode&&b.parentNode.insertBefore(c,b),c.appendChild(b),new Dom(c)})},unwrap:function(){return this.each(function(a){var b=new Dom(a);return b.replaceWith(b.contents())})},replaceWith:function(a){return this._inject(a,function(a,b){for(var c=document.createDocumentFragment(),d="string"==typeof a||"number"==typeof a?this.create(a):a instanceof Node?[a]:this._toArray(a),e=0;e<d.length;e++)c.appendChild(d[e]);var f=c.childNodes[0];return b.parentNode.replaceChild(c,b),f})},remove:function(){return this.each(function(a){a.parentNode&&a.parentNode.removeChild(a)})},clone:function(a){var b=[];return this.each(function(c){var d=this._clone(c);a&&(d=this._cloneEvents(c,d)),b.push(d)}),new Dom(b)},show:function(){return this.each(function(a){if(a.style&&this._hasDisplayNone(a)){var b,c=a.getAttribute("domTargetShow"),d=!!a.classList&&a.classList.contains(DomHClass),e=!!a.classList&&a.classList.contains(DomHMClass);d?(b=DomHClass,a.classList.remove(DomHClass)):e?(b=DomHMClass,a.classList.remove(DomHMClass)):a.style.display=c||"block",b&&a.setAttribute("domTargetHide",b),a.removeAttribute("domTargetShow")}}.bind(this))},hide:function(){return this.each(function(a){if(a.style&&!this._hasDisplayNone(a)){var b=a.style.display,c=a.getAttribute("domTargetHide");c===DomHClass?a.classList.add(DomHClass):c===DomHMClass?a.classList.add(DomHMClass):("block"!==b&&a.setAttribute("domTargetShow",b),a.style.display="none"),a.removeAttribute("domTargetHide")}})},scrollTop:function(a){var b=this.get(),c=b===window,d=9===b.nodeType,e=d?document.scrollingElement||document.body.parentNode||document.body||document.documentElement:b;return void 0!==a?void(c?window.scrollTo(0,a):e.scrollTop=a):d?void 0!==window.pageYOffset?window.pageYOffset:document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop?document.body.scrollTop:0:c?window.pageYOffset:e.scrollTop},offset:function(){return this._getDim("Offset")},position:function(){return this._getDim("Position")},width:function(a,b){return this._getSize("width","Width",a,b)},height:function(a,b){return this._getSize("height","Height",a,b)},outerWidth:function(){return this._getInnerOrOuter("width","outer")},outerHeight:function(){return this._getInnerOrOuter("height","outer")},innerWidth:function(){return this._getInnerOrOuter("width","inner")},innerHeight:function(){return this._getInnerOrOuter("height","inner")},click:function(){return this._triggerEvent("click")},focus:function(){return this._triggerEvent("focus")},trigger:function(a){return this.each(function(b){for(var c=a.split(" "),d=0;d<c.length;d++){var e,f={bubbles:!0,cancelable:!0};try{e=new window.CustomEvent(c[d],f)}catch(a){e=document.createEvent("CustomEvent"),e.initCustomEvent(c[d],!0,!0)}b.dispatchEvent(e)}})},on:function(a,b,c){return this.each(function(d){for(var e=a.split(" "),f=0;f<e.length;f++){var g=this._getEventName(e[f]),h=this._getEventNamespace(e[f]);b=c?this._getOneHandler(b,a):b,d.addEventListener(g,b),d._e=d._e||{},d._e[h]=d._e[h]||{},d._e[h][g]=d._e[h][g]||[],d._e[h][g].push(b)}})},one:function(a,b){return this.on(a,b,!0)},off:function(a,b){var c=function(a,b,c){return a===c},d=function(a,b,c,d){return b===d},e=function(a,b,c,d){return a===c&&b===d},f=function(){return!0};return void 0===a?this.each(function(a){this._offEvent(a,!1,!1,b,f)}):this.each(function(f){for(var g=a.split(" "),h=0;h<g.length;h++){var i=this._getEventName(g[h]),j=this._getEventNamespace(g[h]);"_events"===j?this._offEvent(f,i,j,b,c):i||"_events"===j?this._offEvent(f,i,j,b,e):this._offEvent(f,i,j,b,d)}})},serialize:function(a){for(var b={},c=this.get().elements,d=0;d<c.length;d++){var e=c[d];if((!/(checkbox|radio)/.test(e.type)||e.checked)&&(e.name&&!e.disabled&&"file"!==e.type)){if("select-multiple"===e.type)for(var f=0;f<e.options.length;f++){var g=e.options[f];g.selected&&(b[e.name]=g.value)}b[e.name]=this._isNumber(e.value)?parseFloat(e.value):this._getBooleanFromStr(e.value)}}return a?b:this._toParams(b)},ajax:function(a,b){if(void 0!==AjaxRequest){var c=this.attr("method")||"post",d={url:this.attr("action"),data:this.serialize(),success:a,error:b};return new AjaxRequest(c,d)}},_queryContext:function(a,b){return b=this._getContext(b),3!==b.nodeType&&"function"==typeof b.querySelectorAll?b.querySelectorAll(a):[]},_query:function(a,b){if(b)return this._queryContext(a,b);if(/^[.#]?[\w-]*$/.test(a)){if("#"===a[0]){var c=document.getElementById(a.slice(1));return c?[c]:[]}return"."===a[0]?document.getElementsByClassName(a.slice(1)):document.getElementsByTagName(a)}return document.querySelectorAll(a)},_getContext:function(a){return a="string"==typeof a?document.querySelector(a):a,a&&a.dom?a.get():a||document},_inject:function(a,b){for(var c=this.nodes.length,d=[];c--;){var e="function"==typeof a?a.call(this,this.nodes[c]):a,f=0===c?e:this._clone(e),g=b.call(this,f,this.nodes[c]);g&&(g.dom?d.push(g.get()):d.push(g))}return new Dom(d)},_cloneEvents:function(a,b){var c=a._e;if(c){b._e=c;for(var d in c._events)for(var e=0;e<c._events[d].length;e++)b.addEventListener(d,c._events[d][e])}return b},_clone:function(a){if(void 0!==a)return"string"==typeof a?a:a instanceof Node||a.nodeType?a.cloneNode(!0):"length"in a?[].map.call(this._toArray(a),function(a){return a.cloneNode(!0)}):void 0},_slice:function(a){return a&&0!==a.length?a.length?[].slice.call(a.nodes||a):[a]:[]},_eachClass:function(a,b){return this.each(function(c){if(a){var d=function(a){c.classList&&c.classList[b](a)};a.split(" ").forEach(d)}})},_triggerEvent:function(a){var b=this.get();return b&&3!==b.nodeType&&b[a](),this},_getOneHandler:function(a,b){var c=this;return function(){a.apply(this,arguments),c.off(b)}},_getEventNamespace:function(a){var b=a.split("."),c=b[1]?b[1]:"_events";return b[2]?c+b[2]:c},_getEventName:function(a){return a.split(".")[0]},_offEvent:function(a,b,c,d,e){for(var f in a._e)for(var g in a._e[f])if(e(g,f,b,c))for(var h=a._e[f][g],i=0;i<h.length;i++)void 0!==d&&h[i].toString()!==d.toString()||(a.removeEventListener(g,h[i]),a._e[f][g].splice(i,1),0===a._e[f][g].length&&delete a._e[f][g],0===Object.keys(a._e[f]).length&&delete a._e[f])},_getInnerOrOuter:function(a,b){return this[a](void 0,b)},_getDocSize:function(a,b){var c=a.body,d=a.documentElement;return Math.max(c["scroll"+b],c["offset"+b],d["client"+b],d["scroll"+b],d["offset"+b])},_getSize:function(a,b,c,d){if(void 0===c){var e=this.get();return c=3===e.nodeType?0:9===e.nodeType?this._getDocSize(e,b):e===window?window["inner"+b]:this._getHeightOrWidth(a,e,d||"normal"),Math.round(c)}return this.each(function(b){c=parseFloat(c),c+=this._adjustResultHeightOrWidth(a,b,d||"normal"),new Dom(b).css(a,c+"px")}.bind(this))},_getHeightOrWidth:function(a,b,c){if(!b)return 0;var d=a.charAt(0).toUpperCase()+a.slice(1),e=0,f=getComputedStyle(b,null),g=new Dom(b),h=g.parents().filter(function(a){return 1===a.nodeType&&"none"===getComputedStyle(a,null).display&&a});if("none"===f.display&&h.add(b),0!==h.length){var i="visibility: hidden !important; display: block !important;",j=[];h.each(function(a){var b=new Dom(a),c=b.attr("style");null!==c&&j.push(c),b.attr("style",null!==c?c+";"+i:i)}),e=g.get()["offset"+d]-this._adjustResultHeightOrWidth(a,b,c),h.each(function(a,b){var c=new Dom(a);void 0===j[b]?c.removeAttr("style"):c.attr("style",j[b])})}else e=b["offset"+d]-this._adjustResultHeightOrWidth(a,b,c);return e},_adjustResultHeightOrWidth:function(a,b,c){if(!b||!1===c)return 0;var d=0,e=getComputedStyle(b,null),f="border-box"===e.boxSizing;return"height"===a?(("inner"===c||"normal"===c&&f)&&(d+=(parseFloat(e.borderTopWidth)||0)+(parseFloat(e.borderBottomWidth)||0)),"outer"===c&&(d-=(parseFloat(e.marginTop)||0)+(parseFloat(e.marginBottom)||0))):(("inner"===c||"normal"===c&&f)&&(d+=(parseFloat(e.borderLeftWidth)||0)+(parseFloat(e.borderRightWidth)||0)),"outer"===c&&(d-=(parseFloat(e.marginLeft)||0)+(parseFloat(e.marginRight)||0))),d},_getDim:function(a){var b=this.get();return 3===b.nodeType?{top:0,left:0}:this["_get"+a](b)},_getPosition:function(a){return{top:a.offsetTop,left:a.offsetLeft}},_getOffset:function(a){var b=a.getBoundingClientRect(),c=a.ownerDocument,d=c.documentElement,e=c.defaultView;return{top:b.top+e.pageYOffset-d.clientTop,left:b.left+e.pageXOffset-d.clientLeft}},_getSibling:function(a,b){a=a&&a.dom?a.get():a;var c,d=a&&a.nodeType;return this.each(function(e){for(;e=e[b];)if(d&&e===a||new Dom(e).is(a))return void(c=e)}),new Dom(c)},_toArray:function(a){if(a instanceof NodeList){for(var b=[],c=0;c<a.length;c++)b[c]=a[c];return b}return void 0===a?[]:a.dom?a.nodes:a},_toParams:function(a){var b="";for(var c in a)b+="&"+this._encodeUri(c)+"="+this._encodeUri(a[c]);return b.replace(/^&/,"")},_toObject:function(a){return new Function("return "+a)()},_encodeUri:function(a){return encodeURIComponent(a).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")},_isNumber:function(a){return!isNaN(a)&&!isNaN(parseFloat(a))},_isObjectString:function(a){return-1!==a.search(/^{/)},_getBooleanFromStr:function(a){return"true"===a||"false"!==a&&a},_hasDisplayNone:function(a){return"none"===a.style.display||"none"===(a.currentStyle?a.currentStyle.display:getComputedStyle(a,null).display)}};var uuid=0,$R=function(a,b){return RedactorApp(a,b,[].slice.call(arguments,2))};$R.app=[],$R.version="3.1.8",$R.options={},$R.modules={},$R.services={},$R.classes={},$R.plugins={},$R.mixins={},$R.modals={},$R.lang={},$R.dom=function(a,b){return new Dom(a,b)},$R.ajax=Ajax,$R.Dom=Dom,$R.keycodes={BACKSPACE:8,DELETE:46,UP:38,DOWN:40,ENTER:13,SPACE:32,ESC:27,TAB:9,CTRL:17,META:91,SHIFT:16,ALT:18,RIGHT:39,LEFT:37},$R.env={plugin:"plugins",module:"modules",service:"services",class:"classes",mixin:"mixins"},"undefined"!=typeof jQuery&&function(a){a.fn.redactor=function(a){return RedactorApp(this.toArray(),a,[].slice.call(arguments,1))}}(jQuery);var RedactorApp=function(a,b,c){for(var d,e=Array.isArray(a)?a:a&&a.nodeType?[a]:document.querySelectorAll(a),f="string"==typeof b||"function"==typeof b,g=[],h=0;h<e.length;h++){var i=e[h],j=$R.dom(i);if(d=j.dataget("redactor"),d||f||(d=new App(i,b,uuid),j.dataset("redactor",d),$R.app[uuid]=d,uuid++),d&&f){var k="destroy"===b;b=k?"stop":b;var l;"function"==typeof b?l=b.apply(d,c):(c.unshift(b),l=d.api.apply(d,c)),void 0!==l&&g.push(l),k&&j.dataset("redactor",!1)}}return 0===g.length||1===g.length?0===g.length?d:g[0]:g};$R.add=function(a,b,c){if(void 0!==$R.env[a])if(c.translations&&($R.lang=$R.extend(!0,{},$R.lang,c.translations)),c.modals&&($R.modals=$R.extend(!0,{},$R.modals,c.modals)),"mixin"===a)$R[$R.env[a]][b]=c;else{var d=function(){};if(d.prototype=c,c.mixins)for(var e=0;e<c.mixins.length;e++)$R.inherit(d,$R.mixins[c.mixins[e]]);$R[$R.env[a]][b]=d}},$R.addLang=function(a,b){void 0===$R.lang[a]&&($R.lang[a]={}),$R.lang[a]=$R.extend($R.lang[a],b)},$R.create=function(a){var b=a.split("."),c=[].slice.call(arguments,1),d="classes";void 0!==$R.env[b[0]]&&(d=$R.env[b[0]],a=b.slice(1).join("."));var e=new $R[d][a];if(e.init){var f=e.init.apply(e,c);return f||e}return e},$R.inherit=function(a,b){var c=function(){};c.prototype=b;var d=new c;for(var e in a.prototype)a.prototype.__lookupGetter__(e)?d.__defineGetter__(e,a.prototype.__lookupGetter__(e)):d[e]=a.prototype[e];return a.prototype=d,a.prototype.super=b,a},$R.error=function(a){throw a},$R.extend=function(){var a={},b=!1,c=0,d=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(b=arguments[0],c++);for(;c<d;c++){var e=arguments[c];!function(c){for(var d in c)Object.prototype.hasOwnProperty.call(c,d)&&(b&&"[object Object]"===Object.prototype.toString.call(c[d])?a[d]=$R.extend(!0,a[d],c[d]):a[d]=c[d])}(e)}return a},$R.opts={animation:!0,lang:"en",direction:"ltr",spellcheck:!0,structure:!1,scrollTarget:!1,styles:!0,stylesClass:"redactor-styles",placeholder:!1,source:!0,showSource:!1,inline:!1,breakline:!1,markup:"p",enterKey:!0,clickToEdit:!1,clickToSave:!1,clickToCancel:!1,focus:!1,focusEnd:!1,minHeight:!1,maxHeight:!1,maxWidth:!1,plugins:[],callbacks:{},preClass:!1,preSpaces:4,tabindex:!1,tabAsSpaces:!1,tabKey:!0,autosave:!1,autosaveName:!1,autosaveData:!1,toolbar:!0,toolbarFixed:!0,toolbarFixedTarget:document,toolbarFixedTopOffset:0,toolbarExternal:!1,toolbarContext:!0,air:!1,formatting:["p","blockquote","pre","h1","h2","h3","h4","h5","h6"],formattingAdd:!1,formattingHide:!1,buttons:["html","format","bold","italic","deleted","lists","image","file","link"],buttonsTextLabeled:!1,buttonsAdd:[],buttonsAddFirst:[],buttonsAddAfter:!1,buttonsAddBefore:!1,buttonsHide:[],buttonsHideOnMobile:[],imageUpload:!1,imageUploadParam:"file",imageData:!1,imageEditable:!0,imageCaption:!0,imageLink:!0,imagePosition:!1,imageResizable:!1,imageFloatMargin:"10px",imageFigure:!1,fileUpload:!1,fileUploadParam:"file",fileData:!1,fileAttachment:!1,uploadData:!1,dragUpload:!0,multipleUpload:!0,clipboardUpload:!0,uploadBase64:!1,linkTarget:!1,linkTitle:!1,linkNewTab:!1,linkNofollow:!1,linkSize:30,linkValidation:!0,cleanOnEnter:!0,cleanInlineOnEnter:!1,paragraphize:!0,removeScript:!0,removeNewLines:!1,removeComments:!0,replaceTags:{b:"strong",i:"em",strike:"del"},pastePlainText:!1,pasteLinkTarget:!1,pasteImages:!0,pasteLinks:!0,pasteClean:!0,pasteKeepStyle:[],pasteKeepClass:[],pasteKeepAttrs:["td","th"],pasteBlockTags:["pre","h1","h2","h3","h4","h5","h6","table","tbody","thead","tfoot","th","tr","td","ul","ol","li","blockquote","p","figure","figcaption"],pasteInlineTags:["a","img","br","strong","ins","code","del","span","samp","kbd","sup","sub","mark","var","cite","small","b","u","em","i","abbr"],activeButtons:{b:"bold",strong:"bold",i:"italic",em:"italic",del:"deleted",strike:"deleted",u:"underline"},activeButtonsAdd:{},activeButtonsObservers:{},autoparse:!0,autoparseStart:!0,autoparsePaste:!0,autoparseLinks:!0,autoparseImages:!0,autoparseVideo:!0,shortcodes:{"p.":{format:"p"},"quote.":{format:"blockquote"},"pre.":{format:"pre"},"h1.":{format:"h1"},"h2.":{format:"h2"},"h3.":{format:"h3"},"h4.":{format:"h4"},"h5.":{format:"h5"},"h6.":{format:"h6"},"*.":{format:"ul"}},shortcodesAdd:!1,shortcuts:{"ctrl+shift+m, meta+shift+m":{api:"module.inline.clearformat"},"ctrl+b, meta+b":{api:"module.inline.format",args:"b"},"ctrl+i, meta+i":{api:"module.inline.format",args:"i"},"ctrl+u, meta+u":{api:"module.inline.format",args:"u"},"ctrl+h, meta+h":{api:"module.inline.format",args:"sup"},"ctrl+l, meta+l":{api:"module.inline.format",args:"sub"},"ctrl+k, meta+k":{api:"module.link.open"},"ctrl+alt+0, meta+alt+0":{api:"module.block.format",args:"p"},"ctrl+alt+1, meta+alt+1":{api:"module.block.format",args:"h1"},"ctrl+alt+2, meta+alt+2":{api:"module.block.format",args:"h2"},"ctrl+alt+3, meta+alt+3":{api:"module.block.format",args:"h3"},"ctrl+alt+4, meta+alt+4":{api:"module.block.format",args:"h4"},"ctrl+alt+5, meta+alt+5":{api:"module.block.format",args:"h5"},"ctrl+alt+6, meta+alt+6":{api:"module.block.format",args:"h6"},"ctrl+shift+7, meta+shift+7":{api:"module.list.toggle",args:"ol"},"ctrl+shift+8, meta+shift+8":{api:"module.list.toggle",args:"ul"}},shortcutsAdd:!1,grammarly:!0,notranslate:!1,bufferLimit:100,emptyHtml:"<p></p>",markerChar:"\ufeff",imageTypes:["image/png","image/jpeg","image/gif"],inlineTags:["a","span","strong","strike","b","u","em","i","code","del","ins","samp","kbd","sup","sub","mark","var","cite","small","abbr"],blockTags:["pre","ul","ol","li","p","h1","h2","h3","h4","h5","h6","dl","dt","dd","div","table","tbody","thead","tfoot","tr","th","td","blockquote","output","figcaption","figure","address","section","header","footer","aside","article","iframe"],regex:{youtube:/https?:\/\/(?:[0-9A-Z-]+\.)?(?:youtu\.be\/|youtube\.com\S*[^\w\-\s])([\w\-]{11})((?=[^\w\-]|$)(?![?=&+%\w.-]*(?:['"][^<>]*>|<\/a>))[?=&+%\w.-]*)/gi,vimeo:/(http|https)?:\/\/(?:www.|player.)?vimeo.com\/(?:channels\/(?:\w+\/)?|groups\/(?:[^\/]*)\/videos\/|album\/(?:\d+)\/video\/|video\/|)(\d+)(?:[a-zA-Z0-9_-]+)?/gi,imageurl:/((https?|www)[^\s]+\.)(jpe?g|png|gif)(\?[^\s-]+)?/gi,url:/(https?:\/\/(?:www\.|(?!www))[^\s\.]+\.[^\s]{2,}|www\.[^\s]+\.[^\s]{2,})/gi},input:!0,zindex:!1,modes:{inline:{pastePlainText:!0,pasteImages:!1,enterKey:!1,toolbar:!1,autoparse:!1,source:!1,showSource:!1,styles:!1,air:!1},original:{styles:!1}}},$R.lang.en={format:"Format",image:"Image",file:"File",link:"Link",bold:"Bold",italic:"Italic",deleted:"Strikethrough",underline:"Underline",superscript:"Superscript",subscript:"Subscript","bold-abbr":"B","italic-abbr":"I","deleted-abbr":"S","underline-abbr":"U","superscript-abbr":"Sup","subscript-abbr":"Sub",lists:"Lists","link-insert":"Insert Link","link-edit":"Edit Link","link-in-new-tab":"Open link in new tab",unlink:"Unlink",cancel:"Cancel",close:"Close",insert:"Insert",save:"Save",delete:"Delete",text:"Text",edit:"Edit",title:"Alt",paragraph:"Normal text",quote:"Quote",code:"Code",heading1:"Heading 1",heading2:"Heading 2",heading3:"Heading 3",heading4:"Heading 4",heading5:"Heading 5",heading6:"Heading 6",filename:"Name",optional:"optional",unorderedlist:"Unordered List",orderedlist:"Ordered List",outdent:"Outdent",indent:"Indent",horizontalrule:"Line",upload:"Upload","upload-label":"Drop files here or click to upload","accessibility-help-label":"Rich text editor",caption:"Caption",bulletslist:"Bullets",numberslist:"Numbers","image-position":"Position",none:"None",left:"Left",right:"Right",center:"Center",undo:"Undo",redo:"Redo"},$R.buttons={html:{title:"HTML",icon:!0,api:"module.source.toggle"},undo:{title:"## undo ##",icon:!0,api:"module.buffer.undo"},redo:{title:"## redo ##",icon:!0,api:"module.buffer.redo"},format:{title:"## format ##",icon:!0,dropdown:{p:{title:"## paragraph ##",api:"module.block.format",args:{tag:"p"}},blockquote:{title:"## quote ##",api:"module.block.format",args:{tag:"blockquote"}},pre:{title:"## code ##",api:"module.block.format",args:{tag:"pre"}},h1:{title:"## heading1 ##",api:"module.block.format",args:{tag:"h1"}},h2:{title:"## heading2 ##",api:"module.block.format",args:{tag:"h2"}},h3:{title:"## heading3 ##",api:"module.block.format",args:{tag:"h3"}},h4:{title:"## heading4 ##",api:"module.block.format",args:{tag:"h4"}},h5:{title:"## heading5 ##",api:"module.block.format",args:{tag:"h5"}},h6:{title:"## heading6 ##",api:"module.block.format",args:{tag:"h6"}}}},bold:{title:"## bold-abbr ##",icon:!0,tooltip:"## bold ##",api:"module.inline.format",args:{tag:"b"}},italic:{title:"## italic-abbr ##",icon:!0,tooltip:"## italic ##",api:"module.inline.format",args:{tag:"i"}},deleted:{title:"## deleted-abbr ##",icon:!0,tooltip:"## deleted ##",api:"module.inline.format",args:{tag:"del"}},underline:{title:"## underline-abbr ##",icon:!0,tooltip:"## underline ##",api:"module.inline.format",args:{tag:"u"}},sup:{title:"## superscript-abbr ##",icon:!0,tooltip:"## superscript ##",api:"module.inline.format",args:{tag:"sup"}},sub:{title:"## subscript-abbr ##",icon:!0,tooltip:"## subscript ##",api:"module.inline.format",args:{tag:"sub"}},lists:{title:"## lists ##",icon:!0,observe:"list",dropdown:{observe:"list",unorderedlist:{title:"&bull; ## unorderedlist ##",api:"module.list.toggle",args:"ul"},orderedlist:{title:"1. ## orderedlist ##",api:"module.list.toggle",args:"ol"},outdent:{title:"< ## outdent ##",api:"module.list.outdent"},indent:{title:"> ## indent ##",api:"module.list.indent"}}},ul:{title:"&bull; ## bulletslist ##",icon:!0,api:"module.list.toggle",observe:"list",args:"ul"},ol:{title:"1. ## numberslist ##",icon:!0,api:"module.list.toggle",observe:"list",args:"ol"},outdent:{title:"## outdent ##",icon:!0,api:"module.list.outdent",observe:"list"},indent:{title:"## indent ##",icon:!0,api:"module.list.indent",observe:"list"},image:{title:"## image ##",icon:!0,api:"module.image.open"},file:{title:"## file ##",icon:!0,api:"module.file.open"},link:{title:"## link ##",icon:!0,observe:"link",dropdown:{observe:"link",link:{title:"## link-insert ##",api:"module.link.open"},unlink:{title:"## unlink ##",api:"module.link.unlink"}}},line:{title:"## horizontalrule ##",icon:!0,api:"module.line.insert"}};var App=function(a,b,c){this.module={},this.plugin={},this.instances={},this.started=!1,this.stopped=!1,this.uuid=c,this.rootElement=a,this.rootOpts=b,this.dragInside=!1,this.dragComponentInside=!1,this.keycodes=$R.keycodes,this.namespace="redactor",this.$win=$R.dom(window),this.$doc=$R.dom(document),this.$body=$R.dom("body"),this.editorReadOnly=!1,this.opts=$R.create("service.options",b,a),this.lang=$R.create("service.lang",this),this.buildServices(),this.buildModules(),this.buildPlugins(),this.start()};App.prototype={start:function(){this.stopped=!1,this.broadcast("start"),this.broadcast("startcode"),this.opts.clickToEdit?this.broadcast("startclicktoedit"):(this.broadcast("enable"),this.opts.showSource&&this.broadcast("startcodeshow"),this.broadcast("enablefocus")),this.broadcast("started"),this.started=!0},stop:function(){this.started=!1,this.stopped=!0,this.broadcast("stop"),this.broadcast("disable"),this.broadcast("stopped")},isStarted:function(){return this.started},isStopped:function(){return this.stopped},buildServices:function(){var a=["options","lang"],b=["uuid","keycodes","opts","lang","$win","$doc","$body"],c=[];for(var d in $R.services)-1===a.indexOf(d)&&(this[d]=$R.create("service."+d,this),c.push(d),b.push(d));for(var e=0;e<c.length;e++)for(var f=c[e],g=0;g<b.length;g++){var h=b[g];f!==h&&(this[f][h]=this[h])}},buildModules:function(){for(var a in $R.modules)this.module[a]=$R.create("module."+a,this),this.instances[a]=this.module[a]},buildPlugins:function(){for(var a=this.opts.plugins,b=0;b<a.length;b++){var c=a[b];void 0!==$R.plugins[c]&&(this.plugin[c]=$R.create("plugin."+c,this),this.instances[c]=this.plugin[c])}},isDragInside:function(){return this.dragInside},setDragInside:function(a){this.dragInside=a},isDragComponentInside:function(){return this.dragComponentInside},setDragComponentInside:function(a){this.dragComponentInside=a},getDragComponentInside:function(){return this.dragComponentInside},isReadOnly:function(){return this.editorReadOnly},enableReadOnly:function(){this.editorReadOnly=!0,this.broadcast("enablereadonly"),this.component.clearActive(),this.toolbar.disableButtons()},disableReadOnly:function(){this.editorReadOnly=!1,this.broadcast("disablereadonly"),this.toolbar.enableButtons()},callMessageHandler:function(a,b,c){var d=b.split(".");if(1===d.length)"function"==typeof a["on"+b]&&a["on"+b].apply(a,c);else{d[0]="on"+d[0];var e=this.utils.checkProperty(a,d);"function"==typeof e&&e.apply(a,c)}},broadcast:function(a){var b=[].slice.call(arguments,1);for(var c in this.instances)this.callMessageHandler(this.instances[c],a,b);return this.callback.trigger(a,b)},on:function(a,b){this.callback.add(a,b)},off:function(a,b){this.callback.remove(a,b)},api:function(a){if((this.isStarted()||"start"===a)&&(!this.isReadOnly()||"disableReadOnly"===a)){this.broadcast("state");var b=[].slice.call(arguments,1),c=a.split("."),d=1===c.length,e="on"===c[0]||"off"===c[0],f=!e&&2===c.length,g="plugin"===c[0],h="module"===c[0];if(d){if("function"==typeof this[c[0]])return this.callInstanceMethod(this,c[0],b)}else{if(e)return"on"===c[0]?this.on(c[1],b[0]):this.off(c[1],b[0]||void 0);if(f){if(this.isInstanceExists(this,c[0]))return this.callInstanceMethod(this[c[0]],c[1],b);$R.error(new Error('Service "'+c[0]+'" not found'))}else if(g){if(this.isInstanceExists(this.plugin,c[1]))return this.callInstanceMethod(this.plugin[c[1]],c[2],b);$R.error(new Error('Plugin "'+c[1]+'" not found'))}else if(h){if(this.isInstanceExists(this.module,c[1]))return this.callInstanceMethod(this.module[c[1]],c[2],b);$R.error(new Error('Module "'+c[1]+'" not found'))}}}},isInstanceExists:function(a,b){return void 0!==a[b]},callInstanceMethod:function(a,b,c){if("function"==typeof a[b])return a[b].apply(a,c)}},
$R.add("mixin","formatter",{buildArgs:function(a){this.args={class:a.class||!1,style:a.style||!1,attr:a.attr||!1},this.args.class||this.args.style||this.args.attr||(this.args=!1)},applyArgs:function(a,b){return a=this.args?this[this.type](this.args,!1,a,b):this._clearAll(a,b)},clearClass:function(a,b){this.selection.save();var c=b?$R.dom(b):this.getElements(a,!0);return c.removeAttr("class"),b=this._unwrapSpanWithoutAttr(c.getAll()),this.selection.restore(),b},clearStyle:function(a,b){this.selection.save();var c=b?$R.dom(b):this.getElements(a,!0);return c.removeAttr("style"),b=this._unwrapSpanWithoutAttr(c.getAll()),this.selection.restore(),b},clearAttr:function(a,b){this.selection.save();var c=b?$R.dom(b):this.getElements(a,!0);return this._removeAllAttr(c),b=this._unwrapSpanWithoutAttr(c.getAll()),this.selection.restore(),b},set:function(a,b,c,d){!1!==d&&this.selection.save();var e=c?$R.dom(c):this.getElements(b);return a.class&&(e.removeAttr("class"),e.addClass(a.class)),a.style&&(e.removeAttr("style"),e.css(a.style),e.each(function(a){var b=$R.dom(a);b.attr("data-redactor-style-cache",b.attr("style"))})),a.attr&&(this._removeAllAttr(e),e.attr(a.attr)),!1!==d&&this.selection.restore(),e.getAll()},toggle:function(a,b,c,d){!1!==d&&this.selection.save();var e=c?$R.dom(c):this.getElements(b);a.class&&(e.toggleClass(a.class),e.each(function(a){""===a.className&&a.removeAttribute("class")}));var f;return a.style&&(f=a.style,e.each(function(a){var b=$R.dom(a);for(var c in f){var d=f[c],e=b.css(c);e=this.utils.isRgb(e)?this.utils.rgb2hex(e):e.replace(/"/g,""),d=this.utils.isRgb(d)?this.utils.rgb2hex(d):d.replace(/"/g,""),e=this.utils.hex2long(e),d=this.utils.hex2long(d);("string"==typeof d?d.toLowerCase():d)===("string"==typeof e?e.toLowerCase():e)?b.css(c,""):b.css(c,d)}this._convertStyleQuotes(b),this.utils.removeEmptyAttr(a,"style")?b.removeAttr("data-redactor-style-cache"):b.attr("data-redactor-style-cache",b.attr("style"))}.bind(this))),a.attr&&(f=a.attr,e.each(function(a){var b=$R.dom(a);for(var c in f)b.attr(c)?b.removeAttr(c):b.attr(c,f[c])})),!1!==d&&this.selection.restore(),e.getAll()},add:function(a,b,c,d){!1!==d&&this.selection.save();var e=c?$R.dom(c):this.getElements(b);if(a.class&&e.addClass(a.class),a.style){var f=a.style;e.each(function(a){var b=$R.dom(a);b.css(f),b.attr("data-redactor-style-cache",b.attr("style")),this._convertStyleQuotes(b)}.bind(this))}return a.attr&&e.attr(a.attr),!1!==d&&this.selection.restore(),e.getAll()},remove:function(a,b,c,d){!1!==d&&this.selection.save();var e=c?$R.dom(c):this.getElements(b);if(a.class&&(e.removeClass(a.class),e.each(function(a){""===a.className&&a.removeAttribute("class")})),a.style){var f=a.style;e.each(function(a){var b=$R.dom(a);b.css(f,""),this.utils.removeEmptyAttr(a,"style")?b.removeAttr("data-redactor-style-cache"):b.attr("data-redactor-style-cache",b.attr("style"))}.bind(this))}return a.attr&&e.removeAttr(a.attr),c=this._unwrapSpanWithoutAttr(e.getAll()),!1!==d&&this.selection.restore(),c},_removeAllAttr:function(a){a.each(function(a){for(var b=a.attributes.length;b-- >0;){var c=a.attributes[b],d=c.name;"style"!==d&&"class"!==d&&a.removeAttributeNode(c)}})},_convertStyleQuotes:function(a){var b=a.attr("style");b&&a.attr("style",b.replace(/"/g,"'"))},_clearAll:function(a,b){!1!==b&&this.selection.save();for(var c=0;c<a.length;c++)for(var d=a[c];d.attributes.length>0;)d.removeAttribute(d.attributes[0].name);return a=this._unwrapSpanWithoutAttr(a),!1!==b&&this.selection.restore(),a},_unwrapSpanWithoutAttr:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];d.attributes.length<=0&&3!==d.nodeType&&"SPAN"===d.tagName?$R.dom(d).unwrap():b.push(d)}return b}}),$R.add("mixin","dom",$R.Dom.prototype),$R.add("mixin","component",{get cmnt(){return!0}}),$R.add("service","options",{init:function(a,b){var c=$R.dom(b),d=$R.extend({},$R.opts,b?c.data():{},$R.options);return d=$R.extend(!0,d,a)}}),$R.add("service","lang",{init:function(a){this.app=a,this.opts=a.opts,this.vars=this._build(this.opts.lang)},rebuild:function(a){this.opts.lang=a,this.vars=this._build(a)},extend:function(a){this.vars=$R.extend(this.vars,a)},parse:function(a){if(void 0===a)return"";var b=a.match(/## (.*?) ##/g);if(b)for(var c=0;c<b.length;c++){var d=b[c].replace(/^##\s/g,"").replace(/\s##$/g,"");a=a.replace(b[c],this.get(d))}return a},get:function(a){var b="";return void 0!==this.vars[a]?b=this.vars[a]:"en"!==this.opts.lang&&void 0!==$R.lang.en[a]&&(b=$R.lang.en[a]),b},_build:function(a){var b=$R.lang.en;return"en"!==a&&(b=void 0!==$R.lang[a]?$R.lang[a]:b),b}}),$R.add("service","callback",{init:function(a){this.app=a,this.opts=a.opts,this.callbacks={},this.opts.callbacks&&this._set(this.opts.callbacks,"")},stop:function(){this.callbacks={}},add:function(a,b){this.callbacks[a]||(this.callbacks[a]=[]),this.callbacks[a].push(b)},remove:function(a,b){if(void 0===b)delete this.callbacks[a];else{for(var c=0;c<this.callbacks[a].length;c++)this.callbacks[a].splice(c,1);0===Object.keys(this.callbacks[a]).length&&delete this.callbacks[a]}},trigger:function(a,b){var c=this._loop(a,b,this.callbacks);return void 0===c&&b&&!1!==b[0]?b[0]:c},_set:function(a,b){for(var c in a){var d=""===b?c:b+"."+c;"object"==typeof a[c]?this._set(a[c],d):(this.callbacks[d]=[],this.callbacks[d].push(a[c]))}},_loop:function(a,b,c){var d;for(var e in c)if(a===e)for(var f=0;f<c[e].length;f++)d=c[e][f].apply(this.app,b);return d}}),$R.add("service","animate",{init:function(a){this.animationOpt=a.opts.animation},start:function(a,b,c,d){var e={duration:!1,iterate:!1,delay:!1,timing:!1,prefix:"redactor-"};return e="function"==typeof c?e:$R.extend(e,c),d="function"==typeof c?c:d,new $R.AnimatePlay(a,b,e,d,this.animationOpt)},stop:function(a){this.$el=$R.dom(a),this.$el.removeClass("redactor-animated");var b=this.$el.attr("redactor-animate-effect");this.$el.removeClass(b),this.$el.removeAttr("redactor-animate-effect");var c=this.$el.attr("redactor-animate-hide");c&&this.$el.addClass(c).removeAttr("redactor-animate-hide"),this.$el.off("animationend webkitAnimationEnd")}}),$R.AnimatePlay=function(a,b,c,d,e){return this.hidableEffects=["fadeOut","flipOut","slideUp","zoomOut","slideOutUp","slideOutRight","slideOutLeft"],this.prefixes=["","-webkit-"],this.$el=$R.dom(a),this.$body=$R.dom("body"),this.callback=d,this.animation=e?b:this.buildAnimationOff(b),this.defaults=c,"slideUp"===this.animation&&this.$el.height(this.$el.height()),this.isInanimate()?this.inanimate():this.animate()},$R.AnimatePlay.prototype={buildAnimationOff:function(a){return this.isHidable(a)?"hide":"show"},buildHideClass:function(){return"redactor-animate-hide"},isInanimate:function(){return"show"===this.animation||"hide"===this.animation},isAnimated:function(){return this.$el.hasClass("redactor-animated")},isHidable:function(a){return-1!==this.hidableEffects.indexOf(a)},inanimate:function(){this.defaults.timing="linear";var a;return"show"===this.animation?(a=this.buildHideClass(),this.$el.attr("redactor-animate-hide",a),this.$el.removeClass(a)):(a=this.$el.attr("redactor-animate-hide"),this.$el.addClass(a).removeAttr("redactor-animate-hide")),"function"==typeof this.callback&&this.callback(this),this},animate:function(){var a=this.defaults.delay?this.defaults.delay:0;return setTimeout(function(){if(this.$body.addClass("no-scroll-x"),this.$el.addClass("redactor-animated"),!this.$el.attr("redactor-animate-hide")){var a=this.buildHideClass();this.$el.attr("redactor-animate-hide",a),this.$el.removeClass(a)}this.$el.addClass(this.defaults.prefix+this.animation),this.$el.attr("redactor-animate-effect",this.defaults.prefix+this.animation),this.set(this.defaults.duration+"s",this.defaults.iterate,this.defaults.timing),this.complete()}.bind(this),1e3*a),this},set:function(a,b,c){for(var d=this.prefixes.length;d--;)!1===a&&""!==a||this.$el.css(this.prefixes[d]+"animation-duration",a),!1===b&&""!==b||this.$el.css(this.prefixes[d]+"animation-iteration-count",b),!1===c&&""!==c||this.$el.css(this.prefixes[d]+"animation-timing-function",c)},clean:function(){this.$body.removeClass("no-scroll-x"),this.$el.removeClass("redactor-animated"),this.$el.removeClass(this.defaults.prefix+this.animation),this.$el.removeAttr("redactor-animate-effect"),this.set("","","")},complete:function(){this.$el.one("animationend webkitAnimationEnd",function(){if(this.$el.hasClass(this.defaults.prefix+this.animation)&&this.clean(),this.isHidable(this.animation)){var a=this.$el.attr("redactor-animate-hide");this.$el.addClass(a).removeAttr("redactor-animate-hide")}"slideUp"===this.animation&&this.$el.height(""),"function"==typeof this.callback&&this.callback(this.$el)}.bind(this))}},$R.add("service","caret",{init:function(a){this.app=a},setStart:function(a){this._setCaret("Start",a)},setEnd:function(a){this._setCaret("End",a)},setBefore:function(a){this._setCaret("Before",a)},setAfter:function(a){this._setCaret("After",a)},isStart:function(a){return this._isStartOrEnd(a,"First")},isEnd:function(a){return this._isStartOrEnd(a,"Last")},setAtEnd:function(a){var b=this.inspector.parse(a),c=b.getTag(),d=document.createRange();if(this._isInPage(a)){if("a"===c){var e=this.utils.createInvisibleChar();$R.dom(a).after(e),d.selectNodeContents(e),d.collapse(!0)}else d.selectNodeContents(a),d.collapse(!1);this.selection.setRange(d)}},setAtStart:function(a){var b=document.createRange(),c=this.inspector.parse(a);if(this._isInPage(a)){if(b.setStart(a,0),b.collapse(!0),c.isInline()||this.utils.isEmpty(a)){var d=this.utils.createInvisibleChar();b.insertNode(d),b.selectNodeContents(d),b.collapse(!1)}this.selection.setRange(b)}},setAtBefore:function(a){var b=this.inspector.parse(a),c=document.createRange();if(this._isInPage(a)){if(c.setStartBefore(a),c.collapse(!0),b.isInline()){var d=this.utils.createInvisibleChar();a.parentNode.insertBefore(d,a),c.selectNodeContents(d),c.collapse(!1)}this.selection.setRange(c)}},setAtAfter:function(a){var b=document.createRange();if(this._isInPage(a)){b.setStartAfter(a),b.collapse(!0);var c=this.utils.createInvisibleChar();b.insertNode(c),b.selectNodeContents(c),b.collapse(!1),this.selection.setRange(b)}},setAtPrev:function(a){var b=a.previousSibling;b&&(b=3===b.nodeType&&this._isEmptyTextNode(b)?b.previousElementSibling:b)&&this.setEnd(b)},setAtNext:function(a){var b=a.nextSibling;b&&(b=3===b.nodeType&&this._isEmptyTextNode(b)?b.nextElementSibling:b)&&this.setStart(b)},_setCaret:function(a,b){var c=this.inspector.parse(b),d=c.getNode();d&&(this.component.clearActive(),this["_set"+a](d,c,c.getTag()))},_setStart:function(a,b,c){if(b.isText())return this.editor.focus(),this.setAtStart(a);if("ul"===c||"ol"===c){a=b.findFirstNode("li");var d=this.utils.getFirstElement(a),e=this.inspector.parse(d);if(d&&e.isComponent())return this.setStart(e.getComponent())}else if("dl"===c)a=b.findFirstNode("dt");else{if("br"===c||"hr"===c)return this.setBefore(a);if("td"===c||"th"===c){var f=b.getFirstElement(a);if(f)return this.setStart(f)}else{if("table"===c||"tr"===c)return this.setStart(b.findFirstNode("th, td"));if(b.isComponentType("code")&&!b.isFigcaption()){var g=b.findLastNode("pre, code");return this.editor.focus(),this.setAtStart(g)}if("figure"===c&&b.isComponentType("table")){var h=b.getTable(),i=this.inspector.parse(h);return this.setStart(i.findFirstNode("th, td"))}if(!b.isComponentType("table")&&b.isComponent()&&!b.isFigcaption())return this.component.setActive(a)}}this.editor.focus(),this._setInline(a,"Start")||this.setAtStart(a)},_setEnd:function(a,b,c){if(b.isText())return this.editor.focus(),this.setAtEnd(a);if("ul"===c||"ol"===c){a=b.findLastNode("li");var d=this.utils.getLastElement(a),e=this.inspector.parse(d);if(d&&e.isComponent())return this.setEnd(e.getComponent())}else if("dl"===c)a=b.findLastNode("dd");else{if("br"===c||"hr"===c)return this.setAfter(a);if("td"===c||"th"===c){var f=b.getLastElement();if(f)return this.setEnd(f)}else{if("table"===c||"tr"===c)return this.setEnd(b.findLastNode("th, td"));if(b.isComponentType("code")&&!b.isFigcaption()){var g=b.findLastNode("pre, code");return this.editor.focus(),this.setAtEnd(g)}if("figure"===c&&b.isComponentType("table")){var h=b.getTable(),i=this.inspector.parse(h);return this.setEnd(i.findLastNode("th, td"))}if(!b.isComponentType("table")&&b.isComponent()&&!b.isFigcaption())return this.component.setActive(a)}}if(this.editor.focus(),!this._setInline(a,"End")){if(this.utils.isEmpty(a))return this.setStart(a);this.setAtEnd(a)}},_setBefore:function(a,b,c){return 3===a.nodeType?this.setAtBefore(a):b.isInline()?this.setAtBefore(a):b.isFirstTableCell()?this.setAtPrev(b.getComponent()):"td"===c||"th"===c?this.setAtPrev(a):b.isFirstListItem()?this.setAtPrev(b.getList()):b.isFigcaption()?this.setStart(b.getComponent()):!b.isComponentType("table")&&b.isComponent()?this.setAtPrev(b.getComponent()):b.isBlock()?this.setAtPrev(a):(this.editor.focus(),void this.setAtBefore(a))},_setAfter:function(a,b,c){return 3===a.nodeType?this.setAtAfter(a):b.isInline()?this.setAtAfter(a):b.isLastTableCell()?this.setAtNext(b.getComponent()):"td"===c||"th"===c?this.setAtNext(a):b.isFirstListItem()?this.setAtNext(b.getList()):!b.isComponentType("table")&&b.isComponent()?this.setAtNext(b.getComponent()):b.isBlock()?this.setAtNext(a):(this.editor.focus(),void this.setAtAfter(a))},_setInline:function(a,b){var c=this._hasInlineChild(a,"Start"===b?"first":"last");if(c)return"Start"===b?this.setStart(c):this.setEnd(c),!0},_isStartOrEnd:function(a,b){var c=this.utils.getNode(a);if(!c)return!1;var d=this.inspector.parse(c);if((c=this._getStartEndNode(c,d,b))&&3!==c.nodeType&&"LI"!==c.tagName){var e=3===c.nodeType?c.textContent:c.innerHTML;if(""===(e=this.utils.trimSpaces(e)))return!0}if(!d.isFigcaption()&&d.isComponent()&&!d.isComponentEditable())return!0;var f=this.offset.get(c,!0);return!!f&&("First"===b?0===f.start:f.end===this.offset.size(c,!0))},_isInPage:function(a){return!(!a||!a.nodeType)&&(a!==document.body&&document.body.contains(a))},_hasInlineChild:function(a,b){var c=this.inspector.parse(a),d="first"===b?c.getFirstNode():c.getLastNode(),e=$R.dom(d);if(d&&3!==d.nodeType&&this.inspector.isInlineTag(d.tagName)&&!e.hasClass("redactor-component")&&!e.hasClass("non-editable"))return d},_isEmptyTextNode:function(a){var b=a.textContent.trim().replace(/\n/,"");return""===(b=this.utils.removeInvisibleChars(b))},_getStartEndNode:function(a,b,c){return b.isFigcaption()?a=b.getFigcaption():b.isTable()?a=b["find"+c+"Node"]("th, td"):b.isList()?a=b["find"+c+"Node"]("li"):b.isComponentType("code")&&(a=b.findLastNode("pre, code")),a}}),$R.add("service","selection",{init:function(a){this.app=a},is:function(){var a=this.get();if(a){var b=a.anchorNode,c=this.inspector.parse(b);return c.isInEditor()||c.isEditor()}return!1},isCollapsed:function(){var a=this.get(),b=this.getRange();return!(!a||!a.isCollapsed)||!(!b||0!==b.toString().length)},isBackwards:function(){var a=!1,b=this.get();if(b&&!b.isCollapsed){var c=document.createRange();c.setStart(b.anchorNode,b.anchorOffset),c.setEnd(b.focusNode,b.focusOffset),a=c.collapsed,c.detach()}return a},isIn:function(a){var b=$R.dom(a).get(),c=this.getCurrent();return!(!c||!b)&&b.contains(c)},isText:function(){var a=this.get();if(a){var b=a.anchorNode,c=this.getBlock(b),d=this.getBlocks();if(c&&this.inspector.isTableCellTag(c.tagName)||!1===c&&0===d.length)return!0}return!1},isAll:function(a){var b=this.utils.getNode(a);if(!b)return!1;var c=this.editor.isEditor(b),d=this.inspector.parse(b);if(!d.isFigcaption()&&this.component.isNonEditable(b)&&this.component.isActive(b))return!0;if(c){var e=this.editor.getElement(),f=e.html().replace(/<p><\/p>$/i,"");if(this.getHtml(!1).length!==f.length)return!1}if(c&&this.editor.isEmpty()||this.isCollapsed())return!1;var g=this.offset.get(b,!0),h=this.offset.size(b,!0);return!c&&d.isComponentType("code")&&(h=this.getText().trim().length),!(!g||0!==g.start||g.end!==h)},hasNonEditable:function(){var a=this.getHtml(),b=$R.dom("<div>").html(a);return!this.isCollapsed()&&0!==b.find(".non-editable").length},setRange:function(a){var b=window.getSelection();b.removeAllRanges(),b.addRange(a)},setAll:function(a){var b=this.utils.getNode(a);if(b){var c=this.inspector.parse(b);if(this.component.clearActive(),this.editor.focus(),this.editor.saveScroll(),this.editor.disableNonEditables(),b&&"TABLE"===b.tagName){var d=c.findFirstNode("td, th"),e=c.findLastNode("td, th");$R.dom(d).prepend(this.marker.build("start")),$R.dom(e).append(this.marker.build("end")),this.restoreMarkers()}else if(!c.isFigcaption()&&this.component.isNonEditable(b))this.component.setActive(b);else{c.isComponentType("code")&&(b=c.getComponentCodeElement(),b.focus());var f=document.createRange();f.selectNodeContents(b),this.setRange(f)}this.editor.enableNonEditables(),this.editor.restoreScroll()}},get:function(){var a=window.getSelection();return a.rangeCount>0?a:null},getRange:function(){var a=this.get();return a&&a.getRangeAt(0)?a.getRangeAt(0):null},getTextBeforeCaret:function(a){a=void 0===a?1:a;var b=this.editor.getElement().get(),c=this.getRange(),d=!1;return c&&(c=c.cloneRange(),c.collapse(!0),c.setStart(b,0),d=c.toString().slice(-a)),d},getTextAfterCaret:function(a){a=void 0===a?1:a;var b=this.editor.getElement().get(),c=this.getRange(),d=!1;if(c){var e=c.cloneRange();e.selectNodeContents(b),e.setStart(c.endContainer,c.endOffset),d=e.toString().slice(0,a)}return d},getPosition:function(){var a=this.getRange(),b={top:0,left:0,width:0,height:0};if(window.getSelection&&a.getBoundingClientRect){a=a.cloneRange();var c=a.startOffset-1;a.setStart(a.startContainer,c<0?0:c);var d=a.getBoundingClientRect();b={top:d.top,left:d.left,width:d.right-d.left,height:d.bottom-d.top}}return b},getCurrent:function(){var a=!1,b=this.get(),c=this.component.getActive();if(c)a=c;else if(b&&this.is()){var d=this.inspector.parse(b.anchorNode);a=!d.isEditor()&&b.anchorNode}return a},getParent:function(){var a=!1,b=this.getCurrent();if(b){var c=b.parentNode;a=!this.inspector.parse(c).isEditor()&&c}return a},getElement:function(a){for(var b=a||this.getCurrent();b;){var c=this.inspector.parse(b);if(c.isElement()&&c.isInEditor())return b;b=b.parentNode}return!1},getInline:function(a){for(var b=a||this.getCurrent(),c=!1;b;)this._isInlineNode(b)&&(c=b),b=b.parentNode;return c},getInlineFirst:function(a){for(var b=a||this.getCurrent();b;){if(this._isInlineNode(b))return b;b=b.parentNode}return!1},getInlineAll:function(a){for(var b=a||this.getCurrent(),c=[];b;)this._isInlineNode(b)&&c.push(b),b=b.parentNode;return c},getBlock:function(a){for(var b=a||this.getCurrent();b;){var c=this.inspector.parse(b);if(this.inspector.isBlockTag(b.tagName)&&c.isInEditor(b))return b;b=b.parentNode}return!1},getInlinesAllSelected:function(a){if(this.isAll())return[];var b=this.getInlines({all:!0}),c=this.getNodes({textnodes:!0,inline:!1}),d=this.getText().replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),e=[];if(0!==c.length)return e;if(""===d)e=b;else if(b.length>1)for(var f=0;f<b.length;f++)this._isTextSelected(b[f],d)&&e.push(b[f]);else 1===b.length&&this._isTextSelected(b[0],d)&&(e=b);return e=a&&a.tags?this._filterNodesByTags(e,a.tags):e},getInlines:function(a){for(var b=this.getNodes(),c=[],d=0;d<b.length;d++){var e;if(a&&a.all)for(e=b[d];e;)this._isInlineNode(e)&&!this._isInNodesArray(c,e)&&c.push(e),e=e.parentNode;else(e=this.getInline(b[d]))&&!this._isInNodesArray(c,e)&&c.push(e)}return c=a&&a.tags?this._filterNodesByTags(c,a.tags):c,c=a&&a.inside?this._filterInlinesInside(c,a):c},getBlocks:function(a){var b=this.getNodes(),c=this.getBlock();b=0===b.length&&c?[c]:b;for(var d=[],e=0;e<b.length;e++){var f=this.getBlock(b[e]);$R.dom(f).hasClass("non-editable")||f&&!this._isInNodesArray(d,f)&&d.push(f)}return d=a&&a.tags?this._filterNodesByTags(d,a.tags):d,d=a&&a.first?this._filterBlocksFirst(d,a):d},getElements:function(a){var b=this.getNodes({textnodes:!1}),c=this.getBlock();b=0===b.length&&c?[c]:b;for(var d=[],e=0;e<b.length;e++)this._isInNodesArray(d,b[e])||d.push(b[e]);return d=a&&a.tags?this._filterNodesByTags(d,a.tags):d},getNodes:function(a){var b=[],c=this.component.getActive();if(c)b=this._getNodesComponent(c);else if(this.isCollapsed()){var d=this.getCurrent();b=d?[d]:[]}else this.is()&&!c&&(b=this._getRangeSelectedNodes());return b=this._filterServicesNodes(b),b=this._filterEditor(b),b=a&&a.tags?this._filterNodesByTags(b,a.tags):b,b=a&&a.textnodes?this._filterNodesTexts(b,a):b,b=a&&!a.textnodes?this._filterNodesElements(b):b},getText:function(){var a=this.get();return a?this.utils.removeInvisibleChars(a.toString()):""},getHtml:function(a){var b="",c=this.get();if(c){for(var d=document.createElement("div"),e=c.rangeCount,f=0;f<e;++f)d.appendChild(c.getRangeAt(f).cloneContents());b=d.innerHTML,b=!1!==a?this.cleaner.output(b):b,b=b.replace(/<p><\/p>$/i,"")}return b},clear:function(){this.component.clearActive(),this.get().removeAllRanges()},collapseToStart:function(){var a=this.get();a&&!a.isCollapsed&&a.collapseToStart()},collapseToEnd:function(){var a=this.get();a&&!a.isCollapsed&&a.collapseToEnd()},saveActiveComponent:function(){var a=this.component.getActive();return!!a&&(this.savedComponent=a,!0)},restoreActiveComponent:function(){return!!this.savedComponent&&(this.component.setActive(this.savedComponent),!0)},save:function(){this._clearSaved();var a=this.getElement(),b=["TD","TH","P","DIV","PRE","H1","H2","H3","H4","H5","H6","LI","BLOCKQUOTE"];!a||-1===b.indexOf(a.tagName)||""!==a.innerHTML&&"<br>"!==a.innerHTML?this.saveActiveComponent()||(this.saved=this.offset.get()):this.savedElement=a},restore:function(){(this.saved||this.savedComponent||this.savedElement)&&(this.editor.saveScroll(),this.savedElement?this.caret.setStart(this.savedElement):this.restoreActiveComponent()||this.offset.set(this.saved),this._clearSaved(),this.editor.restoreScroll())},saveMarkers:function(){this._clearSaved(),this.saveActiveComponent()||this.marker.insert()},restoreMarkers:function(){this.editor.saveScroll(),this.restoreActiveComponent()||this.marker.restore(),this._clearSaved(),this.editor.restoreScroll()},_getNextNode:function(a){if(a.hasChildNodes())return a.firstChild;for(;a&&!a.nextSibling;)a=a.parentNode;return a?a.nextSibling:null},_getNodesComponent:function(a){var b=this.getCurrent(),c=this.inspector.parse(b);return c.isFigcaption()?[c.getFigcaption()]:[a]},_getRangeSelectedNodes:function(){var a=[],b=this.getRange(),c=b.startContainer,d=b.startContainer,e=b.endContainer,f=this.editor.getElement();if(d===f.get()&&this.isAll())a=this.utils.getChildNodes(f);else if(c==e)a=[c];else{for(;c&&c!=e;)a.push(c=this._getNextNode(c));for(c=b.startContainer;c&&c!=b.commonAncestorContainer;)a.unshift(c),c=c.parentNode}return a},_isInNodesArray:function(a,b){return-1!==a.indexOf(b)},_filterEditor:function(a){for(var b=[],c=0;c<a.length;c++){this.inspector.parse(a[c]).isInEditor()&&b.push(a[c])}return b},_filterServicesNodes:function(a){for(var b=[],c=0;c<a.length;c++){var d=$R.dom(a[c]),e=!1;a[c]&&3===a[c].nodeType&&this.utils.isEmpty(a[c])&&(e=!0),(d.hasClass("redactor-script-tag")||d.hasClass("redactor-component-caret")||d.hasClass("redactor-selection-marker")||d.hasClass("non-editable"))&&(e=!0),e||b.push(a[c])}return b},_filterNodesTexts:function(a,b){for(var c=[],d=0;d<a.length;d++)if(3===a[d].nodeType||b.keepbr&&"BR"===a[d].tagName){var e=this.getInline(a[d]),f=e&&b&&!1===b.inline;f||c.push(a[d])}return c},_filterNodesElements:function(a){for(var b=[],c=0;c<a.length;c++)3!==a[c].nodeType&&b.push(a[c]);return b},_filterNodesByTags:function(a,b,c){for(var d=[],e=0;e<a.length;e++)if(c&&3===a[e].nodeType)d.push(a[e]);else if(3!==a[e].nodeType){var f=a[e].tagName.toLowerCase();-1!==b.indexOf(f.toLowerCase())&&d.push(a[e])}return d},_filterBlocksFirst:function(a){for(var b=[],c=0;c<a.length;c++){var d=$R.dom(a[c]),e=d.parent().get(),f=d.parent().hasClass("redactor-in"),g=e&&("TD"===e.tagName||"TH"===e.tagName);(f||g)&&b.push(a[c])}return b},_filterInlinesInside:function(a){for(var b=[],c=0;c<a.length;c++)window.getSelection().containsNode(a[c],!0)&&b.push(a[c]);return b},_isTextSelected:function(a,b){var c=this.utils.removeInvisibleChars(a.textContent);return b===c||-1!==c.search(b)||-1!==b.search(new RegExp("^"+c))||-1!==b.search(new RegExp(c+"$"))},_isInlineNode:function(a){var b=this.inspector.parse(a);return this.inspector.isInlineTag(a.tagName)&&b.isInEditor()},_clearSaved:function(){this.saved=!1,this.savedComponent=!1,this.savedElement=!1}}),$R.add("service","element",{init:function(a){this.app=a,this.rootElement=a.rootElement,this.$element={},this.type="inline"},start:function(){this._build(),this._buildType()},isType:function(a){return a===this.type},getType:function(){return this.type},getElement:function(){return this.$element},_build:function(){this.$element=$R.dom(this.rootElement)},_buildType:function(){var a=this.$element.get().tagName;this.type="TEXTAREA"===a?"textarea":this.type,this.type="DIV"===a?"div":this.type,this.type=this.opts.inline?"inline":this.type}}),$R.add("service","editor",{init:function(a){this.app=a,this.scrolltop=!1,this.pasting=!1},start:function(){this._build()},focus:function(){this.isFocus()||this._isContenteditableFocus()||(this.saveScroll(),this.$editor.focus(),this.restoreScroll())},startFocus:function(){this.caret.setStart(this.getFirstNode())},endFocus:function(){this.caret.setEnd(this.getLastNode())},isPasting:function(){return this.pasting},enablePasting:function(){this.pasting=!0},disablePasting:function(){this.pasting=!1},saveScroll:function(){this.scrolltop=this._getScrollTarget().scrollTop()},restoreScroll:function(){!1!==this.scrolltop&&(this._getScrollTarget().scrollTop(this.scrolltop),this.scrolltop=!1)},disableNonEditables:function(){this.$noneditables=this.$editor.find("[contenteditable=false]"),this.$noneditables.attr("contenteditable",!0)},enableNonEditables:function(){this.$noneditables&&setTimeout(function(){this.$noneditables.attr("contenteditable",!1)}.bind(this),1)},getFirstNode:function(){return this.$editor.contents()[0]},getLastNode:function(){var a=this.$editor.contents();return a[a.length-1]},isSourceMode:function(){return this.source.getElement().hasClass("redactor-source-open")},isEditor:function(a){return $R.dom(a).get()===this.$editor.get()},isEmpty:function(a){return this.utils.isEmptyHtml(this.$editor.html(),!1,a)},isFocus:function(){var a=$R.dom(document.activeElement);return 0!==this.$editor.find(".redactor-component-active").length||0!==a.closest(".redactor-in-"+this.uuid).length},setEmpty:function(){this.$editor.html(this.opts.emptyHtml)},getElement:function(){return this.$editor},_build:function(){var a=this.element.getElement(),b=this.element.isType("textarea")?"<div>":a.get();this.$editor=$R.dom(b)},_getScrollTarget:function(){var a=this.$doc;return a=this.opts.toolbarFixedTarget!==document?$R.dom(this.opts.toolbarFixedTarget):this.opts.scrollTarget?$R.dom(this.opts.scrollTarget):a},_isContenteditableFocus:function(){var a=this.selection.getBlock();return 0!==(a?$R.dom(a).closest("[contenteditable=true]").not(".redactor-in"):[]).length}}),$R.add("service","container",{init:function(a){this.app=a},start:function(){this._build()},getElement:function(){return this.$container},_build:function(){var a=this.element.isType("inline")?"<span>":"<div>";this.$container=$R.dom(a)}}),$R.add("service","source",{init:function(a){this.app=a,this.$source={},this.content=""},start:function(){this._build(),this._buildName(),this._buildStartedContent()},getElement:function(){return this.$source},getCode:function(){return this.$source.val()},getName:function(){return this.$source.attr("name")},getStartedContent:function(){return this.content},setCode:function(a){return this.insertion.set(a,!0,!1)},isNameGenerated:function(){return this.name},rebuildStartedContent:function(){this._buildStartedContent()},_build:function(){var a=this.element.getElement(),b=this.element.isType("textarea"),c=b?a.get():"<textarea>";this.$source=$R.dom(c)},_buildName:function(){var a=this.element.getElement();this.name=a.attr("name"),this.$source.attr("name",this.name?this.name:"content-"+this.uuid)},_buildStartedContent:function(){var a=this.element.getElement(),b=this.element.isType("textarea")?a.val():a.html();this.content=b.trim()}}),$R.add("service","statusbar",{init:function(a){this.app=a,this.$statusbar={},this.items=[]},start:function(){this.$statusbar=$R.dom("<ul>"),this.$statusbar.attr("dir",this.opts.direction)},add:function(a,b){return this.update(a,b)},update:function(a,b){var c;return void 0!==this.items[a]?c=this.items[a]:(c=$R.dom("<li>"),this.$statusbar.append(c),this.items[a]=c),c.html(b)},get:function(a){return!!this.items[a]&&this.items[a]},remove:function(a){this.items[a]&&(this.items[a].remove(),delete this.items[a])},getItems:function(){return this.items},removeItems:function(){this.items={},this.$statusbar.html("")},getElement:function(){return this.$statusbar}}),$R.add("service","toolbar",{init:function(a){this.app=a,this.buttons=[],this.dropdownOpened=!1,this.buttonsObservers={}},start:function(){this.is()&&(this.opts.activeButtons=this.opts.activeButtonsAdd?this._extendActiveButtons():this.opts.activeButtons,this.create())},stopObservers:function(){this.buttonsObservers={}},create:function(){this.$wrapper=$R.dom("<div>"),this.$toolbar=$R.dom("<div>")},observe:function(){if(this.is()){this.setButtonsInactive();var a,b;for(var c in this.buttonsObservers)b=this.buttonsObservers[c],a=this.getButton(c),this.app.broadcast("button."+b+".observe",a);var d=this.opts.activeButtons,e=this.selection.getInlinesAllSelected(),f=this.selection.getInline();this.selection.isCollapsed()&&f&&e.push(f);var g=this._inlinesToTags(e);for(var h in d)-1!==g.indexOf(h)&&(a=this.getButton(d[h]),a.setActive())}},is:function(){return!(!this.opts.toolbar||this.detector.isMobile()&&this.opts.air)},isAir:function(){return!!this.is()&&this.$toolbar.hasClass("redactor-air")},isFixed:function(){return!!this.is()&&this.$toolbar.hasClass("redactor-toolbar-fixed")},isContextBar:function(){return this.$body.find("#redactor-context-toolbar-"+this.uuid).hasClass("open")},isTarget:function(){return this.opts.toolbarFixedTarget!==document},getElement:function(){return this.$toolbar},getWrapper:function(){return this.$wrapper},getDropdown:function(){return this.dropdownOpened},getTargetElement:function(){return $R.dom(this.opts.toolbarFixedTarget)},getButton:function(a){var b=this._findButton(".re-"+a);return 0!==b.length&&b.dataget("data-button-instance")},getButtonByIndex:function(a){var b=this.$toolbar.find(".re-button").eq(a);return 0!==b.length&&b.dataget("data-button-instance")},getButtons:function(){var a=[];return this._findButtons().each(function(b){var c=$R.dom(b);a.push(c.dataget("data-button-instance"))}),a},getButtonsKeys:function(){var a=[];return this._findButtons().each(function(b){var c=$R.dom(b);a.push(c.attr("data-re-name"))}),a},addButton:function(a,b,c,d,e){c=c||"end";var f=this._getButtonIndex(a),g=$R.create("toolbar.button",this.app,a,b);if(b.observe&&(this.opts.activeButtonsObservers[a]={observe:b.observe,button:g}),!0!==e)if(0===f)c="first";else if(-1!==f){var h=this.getButtonByIndex(f-1);h&&(c="after",d=h)}return this.is()&&("first"===c?this.$toolbar.prepend(g):"after"===c?d.after(g):"before"===c?d.before(g):this.$toolbar.append(g)),g},addButtonFirst:function(a,b){return this.addButton(a,b,"first")},addButtonAfter:function(a,b,c){var d=this.getButton(a);return d?this.addButton(b,c,"after",d):this.addButton(b,c)},addButtonBefore:function(a,b,c){var d=this.getButton(a);return d?this.addButton(b,c,"before",d):this.addButton(b,c)},addButtonObserver:function(a,b){this.buttonsObservers[a]=b},setButtons:function(a){this.buttons=a},setDropdown:function(a){this.dropdownOpened=a},setButtonsInactive:function(){for(var a=this.getButtons(),b=0;b<a.length;b++)a[b].setInactive()},setButtonsActive:function(){for(var a=this.getButtons(),b=0;b<a.length;b++)a[b].setActive()},disableButtons:function(){
for(var a=this.getButtons(),b=0;b<a.length;b++)a[b].disable()},enableButtons:function(){for(var a=this.getButtons(),b=0;b<a.length;b++)a[b].enable()},_getButtonIndex:function(a){var b=this.buttons.indexOf(a);return-1!==b&&b},_findButton:function(a){return this.is()?this.$toolbar.find(a):$R.dom()},_findButtons:function(){return this.is()?this.$toolbar.find(".re-button"):$R.dom()},_extendActiveButtons:function(){return $R.extend({},this.opts.activeButtons,this.opts.activeButtonsAdd)},_inlinesToTags:function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c].tagName.toLowerCase());return b}}),$R.add("class","toolbar.button",{mixins:["dom"],init:function(a,b,c){this.app=a,this.opts=a.opts,this.lang=a.lang,this.$body=a.$body,this.toolbar=a.toolbar,this.detector=a.detector,this.obj=c,this.name=b,this.dropdown=!1,this.tooltip=!1,this._init()},isActive:function(){return this.hasClass("redactor-button-active")},isDisabled:function(){return this.hasClass("redactor-button-disabled")},hasIcon:function(){return this.obj.icon&&!this.opts.buttonsTextLabeled},setDropdown:function(a){this.obj.dropdown=a,this.obj.message=!1,this.dropdown=$R.create("toolbar.dropdown",this.app,this.name,this.obj.dropdown),this.attr("data-dropdown",!0)},setMessage:function(a,b){this.obj.message=a,this.obj.args=b,this.obj.dropdown=!1},setApi:function(a,b){this.obj.api=a,this.obj.args=b,this.obj.dropdown=!1},setTitle:function(a){this.obj.title=this.lang.parse(a),this.obj.tooltip=this.obj.title,this.attr({alt:this.obj.tooltip,"aria-label":this.obj.tooltip}),this.attr("data-re-icon")||this.html(this.obj.title)},setTooltip:function(a){this.obj.tooltip=this.lang.parse(a),this.attr({alt:this.obj.tooltip,"aria-label":this.obj.tooltip})},setIcon:function(a){this.opts.buttonsTextLabeled||(this.obj.icon=!0,this.$icon=$R.dom(a),this.html(""),this.append(this.$icon),this.attr("data-re-icon",!0),this.addClass("re-button-icon"),this.setTooltip(this.obj.title),this._buildTooltip())},setActive:function(){this.addClass("redactor-button-active")},setInactive:function(){this.removeClass("redactor-button-active")},hideTooltip:function(){this.$body.find(".re-button-tooltip").remove()},getDropdown:function(){return this.dropdown},disable:function(){this.addClass("redactor-button-disabled")},enable:function(){this.removeClass("redactor-button-disabled")},toggle:function(a){a&&a.preventDefault(),this.isDisabled()||(this.obj.dropdown?this.dropdown.toggle(a):this.obj.api?this.app.api(this.obj.api,this.obj.args,this.name):this.obj.message&&this.app.broadcast(this.obj.message,this.obj.args,this.name),this.hideTooltip())},_init:function(){this._parseTitle(),this._parseTooltip(),this._build(),this._buildCallback(),this._buildAttributes(),this._buildObserver(),this.hasIcon()?(this._buildIcon(),this._buildTooltip()):this.html(this.obj.title)},_parseTooltip:function(){this.obj.tooltip=this.obj.tooltip?this.lang.parse(this.obj.tooltip):this.obj.title},_parseTitle:function(){this.obj.title=this.lang.parse(this.obj.title)},_build:function(){this.parse("<a>"),this.addClass("re-button re-"+this.name),this.attr("data-re-name",this.name),this.dataset("data-button-instance",this),this.obj.dropdown&&this.setDropdown(this.obj.dropdown)},_buildCallback:function(){this.on("click",this.toggle.bind(this))},_buildAttributes:function(){var a={href:"#",alt:this.obj.tooltip,rel:this.name,role:"button","aria-label":this.obj.tooltip,tabindex:"-1"};this.attr(a)},_buildObserver:function(){void 0!==this.obj.observe&&this.toolbar.addButtonObserver(this.name,this.obj.observe)},_buildIcon:function(){var a=this.obj.icon,b=/(<([^>]+)>)/gi.test(a);this.$icon=b?$R.dom(a):$R.dom("<i>"),b||this.$icon.addClass("re-icon-"+this.name),this.append(this.$icon),this.attr("data-re-icon",!0),this.addClass("re-button-icon")},_buildTooltip:function(){this.detector.isDesktop()&&(this.tooltip=$R.create("toolbar.button.tooltip",this.app,this))}}),$R.add("class","toolbar.button.tooltip",{mixins:["dom"],init:function(a,b){this.app=a,this.uuid=a.uuid,this.opts=a.opts,this.$body=a.$body,this.toolbar=a.toolbar,this.$button=b,this.created=!1,this._init()},open:function(){if(!this.$button.hasClass("redactor-button-disabled")&&!this.$button.hasClass("redactor-button-active")){this.created=!0,this.parse("<span>"),this.addClass("re-button-tooltip re-button-tooltip-"+this.uuid),this.$body.append(this),this.html(this.$button.attr("alt"));var a=this.$button.offset(),b=this.$button.height(),c=this.$button.width();this.css({top:a.top+b+4+"px",left:a.left+c/2-this.width()/2+"px",position:"absolute"}),this.show()}},close:function(){this.created&&!this.$button.hasClass("redactor-button-disabled")&&(this.remove(),this.created=!1)},_init:function(){this.$button.on("mouseover",this.open.bind(this)),this.$button.on("mouseout",this.close.bind(this))}}),$R.add("class","toolbar.dropdown",{mixins:["dom"],init:function(a,b,c){this.app=a,this.uuid=a.uuid,this.opts=a.opts,this.$win=a.$win,this.$doc=a.$doc,this.$body=a.$body,this.animate=a.animate,this.toolbar=a.toolbar,this.name=b,this.started=!1,this.items=c,this.$items=[]},toggle:function(a){this.started||this._build(),this.isOpened()&&this.isActive()?this.close(!1):this.open(a)},isOpened:function(){var a=this.$body.find(".redactor-dropdown-"+this.uuid+".open");return 0!==a.length&&a.attr("data-re-name")===this.name},isActive:function(){return 0!==this.$body.find("#redactor-dropdown-"+this.uuid+"-"+this.name+".open").length},getName:function(){return this.attr("data-re-name")},getItem:function(a){return this.$items[a]},getItemsByClass:function(a){var b=[];for(var c in this.$items)"object"==typeof this.$items[c]&&this.$items[c].hasClass(a)&&b.push(this.$items[c]);return b},open:function(a){this._closeAll(),this.$btn=this.toolbar.getButton(this.name),this.app.broadcast("dropdown.open",a,this,this.$btn),this.toolbar.setDropdown(this),this.show(),this.removeClass("redactor-animate-hide"),this.addClass("open"),this._observe(),this.$btn.hideTooltip(),this.$btn.setActive(),this.$doc.on("keyup.redactor.dropdown-"+this.uuid,this._handleKeyboard.bind(this)),this.$doc.on("click.redactor.dropdown-"+this.uuid,this.close.bind(this)),this.updatePosition(),this.app.broadcast("dropdown.opened",a,this,this.$btn)},close:function(a,b){if(a){var c=$R.dom(a.target);if(this._isButton(a)||c.hasClass("redactor-dropdown-not-close")||c.hasClass("redactor-dropdown-item-disabled"))return void a.preventDefault()}this.app.broadcast("dropdown.close",this,this.$btn),this.toolbar.setDropdown(!1),this.$btn.setInactive(),!1===b?this._close():this.animate.start(this,"fadeOut",this._close.bind(this))},updatePosition:function(){var a=this.toolbar.isFixed(),b=this.$btn.offset();b.top=a?this.$btn.position().top:b.top;var c=this.$btn.height(),d=this.$btn.width(),e=a?"fixed":"absolute",f=a?2+this.opts.toolbarFixedTopOffset:2,g=b.left+0,h=parseFloat(this.css("width")),i=this.$win.width(),j=i<g+h?h-d:0,k=g-j;k=k<0?4:k,this.css({position:e,top:b.top+c+f+"px",left:k+"px"})},_build:function(){this.parse("<div>"),this.attr("dir",this.opts.direction),this.attr("id","redactor-dropdown-"+this.uuid+"-"+this.name),this.attr("data-re-name",this.name),this.addClass("redactor-dropdown redactor-dropdown-"+this.uuid+" redactor-dropdown-"+this.name),this.dataset("data-dropdown-instance",this),this.items.dom||"string"==typeof this.items?this._buildDom():this._buildItems(),this.$body.append(this),this.started=!0},_buildDom:function(){this.html("").append($R.dom(this.items))},_buildItems:function(){this.items="format"===this.name?this._buildFormattingItems():this.items;for(var a in this.items){var b=this.items[a];if("observe"===a)this.attr("data-observe",this.items[a]);else{var c=$R.create("toolbar.dropdown.item",this.app,a,b,this);this.$items[a]=c,this.append(c)}}},_buildFormattingItems:function(){for(var a in this.items)-1===this.opts.formatting.indexOf(a)&&delete this.items[a];if(this.opts.formattingHide)for(var a in this.items)-1!==this.opts.formattingHide.indexOf(a)&&delete this.items[a];if(this.opts.formattingAdd)for(var a in this.opts.formattingAdd)this.items[a]=this.opts.formattingAdd[a];return this.items},_handleKeyboard:function(a){27===a.which&&this.close()},_isButton:function(a){return $R.dom(a.target).closest(".re-button").get()===this.$btn.get()},_close:function(){this.$btn.setInactive(),this.$doc.off(".redactor.dropdown-"+this.uuid),this.removeClass("open"),this.addClass("redactor-animate-hide"),this.app.broadcast("dropdown.closed",this,this.$btn)},_closeAll:function(){this.$body.find(".redactor-dropdown-"+this.uuid+".open").each(function(a){$R.dom(a).dataget("data-dropdown-instance")._close()})},_observe:function(){var a=this.attr("data-observe");a&&this.app.broadcast("dropdown."+a+".observe",this)}}),$R.add("class","toolbar.dropdown.item",{mixins:["dom"],init:function(a,b,c,d){this.app=a,this.lang=a.lang,this.dropdown=d,this.name=b,this.obj=c,this._init()},setTitle:function(a){this.$span.html(a)},getTitle:function(){return this.$span.html()},enable:function(){this.removeClass("redactor-dropdown-item-disabled")},disable:function(){this.addClass("redactor-dropdown-item-disabled")},toggle:function(a){a&&a.preventDefault(),this.hasClass("redactor-dropdown-item-disabled")||(this.obj.message?this.app.broadcast(this.obj.message,this.obj.args,this.name):this.obj.api&&this.app.api(this.obj.api,this.obj.args,this.name))},_init:function(){this.parse("<a>"),this.attr("href","#"),this.addClass("redactor-dropdown-item-"+this.name),this.obj.classname&&this.addClass(this.obj.classname),this.attr("data-re-name",this.name),this.on("click",this.toggle.bind(this)),this.$span=$R.dom("<span>"),this.append(this.$span),this.setTitle(this.lang.parse(this.obj.title))}}),$R.add("service","cleaner",{init:function(a){this.app=a,this.opts=a.opts,this.storedComponents=[],this.storedImages=[],this.storedLinks=[],this.deniedTags=["font","html","head","link","title","body","meta","applet"],this.convertRules={},this.unconvertRules={},this.reComments=/<!--[\s\S]*?-->/g,this.reSpacedEmpty=/^(||\s||<br\s?\/?>||&nbsp;)$/i,this.reScriptTag=/<script(.*?[^>]?)>([\w\W]*?)<\/script>/gi},addConvertRules:function(a,b){this.convertRules[a]=b},addUnconvertRules:function(a,b){this.unconvertRules[a]=b},input:function(a,b,c){return a=this.encodePreCode(a),a=a.replace(/\$/g,"&#36;"),a=a.replace(/&amp;/g,"&"),a=$R.create("cleaner.figure",this.app).convert(a,this.convertRules),a=this.storeComponents(a),a=this.replaceTags(a,this.opts.replaceTags),a=this._setSpanAttr(a),a=this._setStyleCache(a),a=this.removeTags(a,this.deniedTags),a=this.opts.removeScript?this._removeScriptTag(a):a,a=this.opts.removeComments?this.removeComments(a):a,a=this._isSpacedEmpty(a)?this.opts.emptyHtml:a,a=this.restoreComponents(a),a=this._cleanWrapped(a),a=b?this.paragraphize(a):a},output:function(a,b){return a=this.removeInvisibleSpaces(a),this._isSpacedEmpty(a)?"":this._isParagraphEmpty(a)?"":(a=this.removeServiceTagsAndAttrs(a,b),a=this.storeComponents(a),a=this.removeSpanWithoutAttributes(a),a=this.removeFirstBlockBreaklineInHtml(a),a=this.opts.removeScript?a:this._unreplaceScriptTag(a),a=this.opts.preClass?this._setPreClass(a):a,a=this.opts.linkNofollow?this._setLinkNofollow(a):a,a=this.opts.removeNewLines?this.cleanNewLines(a):a,a=this.restoreComponents(a),a=$R.create("cleaner.figure",this.app).unconvert(a,this.unconvertRules),a=this.removeEmptyAttributes(a,["style","class","rel","alt","title"]),a=this.cleanSpacesInPre(a),a=this.tidy(a),a=a.replace(/&amp;/g,"&"),a=""===a.replace(/\n/g,"")?"":a)},paste:function(a){a=this.storeComponents(a);var b=this.deniedTags.concat(["iframe"]);a=this.removeTags(a,b),a=a.replace(new RegExp("<!doctype([\\s\\S]+?)>","gi"),""),a=a.replace(new RegExp("<style([\\s\\S]+?)</style>","gi"),""),a=a.replace(new RegExp("</p><br /><p","gi"),"</p><p");var c=this._isHtmlMsWord(a);if(a=this._cleanGDocs(a),a=c?this._cleanMsWord(a):a,!this.opts.pasteClean)return a=this.restoreComponents(a);if(this.opts.pastePlainText)return a=this.restoreComponents(a),this.pastePlainText(a);var d=this.opts.pasteBlockTags.concat(this.opts.pasteInlineTags);a=this.removeTagsExcept(a,d),a=this.opts.pasteLinks?a:this.removeTags(a,["a"]),a=this.opts.pasteImages?a:this.removeTags(a,["img"]);var e=this.utils.buildWrapper(a),f=e.find("*"),g=0!==this.opts.pasteKeepStyle.length?","+this.opts.pasteKeepStyle.join(","):"";f.not("[data-redactor-style-cache]"+g).removeAttr("style");var h=0!==this.opts.pasteKeepClass.length?","+this.opts.pasteKeepClass.join(","):"";f.not("[data-redactor-style-cache], span.redactor-component"+h).removeAttr("class");var i=0!==this.opts.pasteKeepAttrs.length?","+this.opts.pasteKeepAttrs.join(","):"";return f.not("img, a, span.redactor-component, [data-redactor-style-cache]"+i).each(function(a){for(;a.attributes.length>0;)a.removeAttribute(a.attributes[0].name)}),this.opts.pasteLinks&&!1!==this.opts.pasteLinkTarget&&e.find("a").attr("target",this.opts.pasteLinkTarget),e.find("[data-redactor-style-cache]").each(function(a){var b=a.getAttribute("data-redactor-style-cache");a.setAttribute("style",b)}),e.find("span").each(function(a){0===a.attributes.length&&$R.dom(a).unwrap()}),e.find(this.opts.inlineTags.join(",")).each(function(a){0===a.attributes.length&&this.utils.isEmptyHtml(a.innerHTML)&&$R.dom(a).unwrap()}.bind(this)),e.find("ul, ol").each(function(a){var b=a.previousSibling;if(b&&"LI"===b.tagName){var c=$R.dom(b);c.find("p").unwrap(),c.append(a)}}),a=this.utils.getWrapperHtml(e),a=a.replace(/<li><p>/gi,"<li>"),a=a.replace(/<\/p><\/li>/gi,"</li>"),a=a.replace(/<p>&nbsp;<\/p>/gi,"<p></p>"),a=a.replace(/<p><br\s?\/?><\/p>/gi,"<p></p>"),c&&(a=a.replace(/<p><\/p>/gi,""),a=a.replace(/<p>\s<\/p>/gi,"")),a=this.restoreComponents(a)},pastePlainText:function(a){return a=this.opts.pasteLinks?this.storeLinks(a):a,a=this.opts.pasteImages?this.storeImages(a):a,a=this.getPlainText(a),a=this._replaceNlToBr(a),a=this.opts.pasteLinks?this.restoreLinks(a):a,a=this.opts.pasteImages?this.restoreImages(a):a},tidy:function(a){return a},paragraphize:function(a){return $R.create("cleaner.paragraphize",this.app).convert(a)},getFlatText:function(a){var b=$R.dom("<div>");return a.nodeType||a.dom?b.append(a):(a=a.toString(),a=a.trim(),b.html(a)),a=b.get().textContent||b.get().innerText||"",void 0===a?"":a},getPlainText:function(a){a=a.replace(/<!--[\s\S]*?-->/gi,""),a=a.replace(/<style[\s\S]*?style>/gi,""),a=a.replace(/<p><\/p>/g,""),a=a.replace(/<\/div>|<\/li>|<\/td>/gi,"\n"),a=a.replace(/<\/p>/gi,"\n\n"),a=a.replace(/<\/H[1-6]>/gi,"\n\n");var b=document.createElement("div");return b.innerHTML=a,a=b.textContent||b.innerText,a.trim()},replaceTags:function(a,b){if(b){var c=this,d=Object.keys(b),e=this.utils.buildWrapper(a);e.find(d.join(",")).each(function(a){c.utils.replaceToTag(a,b[a.tagName.toLowerCase()])}),a=this.utils.getWrapperHtml(e)}return a},replaceNbspToSpaces:function(a){return a.replace("&nbsp;"," ")},replaceBlocksToBr:function(a){return a=a.replace(/<\/div>|<\/li>|<\/td>|<\/p>|<\/H[1-6]>/gi,"<br>")},cleanNewLines:function(a){return a.replace(/\r?\n/g,"")},cleanSpacesInPre:function(a){return a.replace("&nbsp;&nbsp;&nbsp;&nbsp;","    ")},removeInvisibleSpaces:function(a){return a=this.utils.removeInvisibleChars(a),a=a.replace(/&#65279;/gi,"")},removeNl:function(a){return a=a.replace(/\n/g," "),a=a.replace(/\s+/g,"s")},removeBrAtEnd:function(a){return a=a.replace(/<br\s?\/?>$/gi," "),a=a.replace(/<br\s?\/?><li/gi,"<li")},removeTags:function(a,b){var c=b?/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi:/(<([^>]+)>)/gi,d=b?function(a,c){return-1===b.indexOf(c.toLowerCase())?a:""}:"";return a.replace(c,d)},removeTagsExcept:function(a,b){if(void 0===b)return a.replace(/(<([^>]+)>)/gi,"");var c=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;return a.replace(c,function(a,c){return-1===b.indexOf(c.toLowerCase())?"":a})},removeComments:function(a){return a.replace(this.reComments,"")},removeServiceTagsAndAttrs:function(a,b){var c=this.utils.buildWrapper(a),d=this;return!1!==b&&c.find(".redactor-selection-marker").each(function(a){var b=$R.dom(a);return""===d.utils.removeInvisibleChars(b.text())?b.remove():b.unwrap()}),c.find("[data-redactor-style-cache]").removeAttr("data-redactor-style-cache"),this.utils.getWrapperHtml(c)},removeSpanWithoutAttributes:function(a){var b=this.utils.buildWrapper(a);return b.find("span").removeAttr("data-redactor-span data-redactor-style-cache").each(function(a){0===a.attributes.length&&$R.dom(a).unwrap()}),this.utils.getWrapperHtml(b)},removeFirstBlockBreaklineInHtml:function(a){return a.replace(new RegExp("</li><br\\s?/?>","gi"),"</li>")},removeEmptyAttributes:function(a,b){for(var c=this.utils.buildWrapper(a),d=0;d<b.length;d++)c.find("["+b[d]+'=""]').removeAttr(b[d]);return this.utils.getWrapperHtml(c)},encodeHtml:function(a){return a=a.replace(/<br\s?\/?>/g,"\n"),a=a.replace(/&nbsp;/g," "),a=a.replace(/”/g,'"'),a=a.replace(/“/g,'"'),a=a.replace(/‘/g,"'"),a=a.replace(/’/g,"'"),a=this.encodeEntities(a),a=a.replace(/\$/g,"&#36;"),this.opts.preSpaces&&(a=a.replace(/\t/g,new Array(this.opts.preSpaces+1).join(" "))),a},encodePreCode:function(a){var b=a.match(new RegExp("<code(.*?)>(.*?)<pre(.*?)>(.*?)</pre>(.*?)</code>","gi"));if(null!==b)for(var c=0;c<b.length;c++){var d=b[c].match(new RegExp("<pre(.*?)>([\\w\\W]*?)</pre>","i"));a=a.replace(d[0],this.encodeEntities(d[0]))}var e=this.utils.buildWrapper(a);return e.find("code code").replaceWith(this._encodeOuter.bind(this)),e.find("code pre").replaceWith(this._encodeOuter.bind(this)),e.find("pre pre").replaceWith(this._encodeOuter.bind(this)),e.find("code, pre").each(this._encodePreCodeLine.bind(this)),a=this.utils.getWrapperHtml(e),a=this._decodeMarkers(a)},encodeEntities:function(a){return a=this.decodeEntities(a),a=a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},encodePhpCode:function(a){return a=a.replace("<?php","&lt;?php"),a=a.replace("<?","&lt;?"),a=a.replace("?>","?&gt;")},decodeEntities:function(a){return String(a).replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&amp;/g,"&")},storeComponents:function(a){var b=this.utils.getElementsFromHtml(a,"figure","table");return this._storeMatched(a,b,"Components","figure")},restoreComponents:function(a){return this._restoreMatched(a,"Components","figure")},storeLinks:function(a){var b=this.utils.getElementsFromHtml(a,"a");return this._storeMatched(a,b,"Links","a")},storeImages:function(a){var b=this.utils.getElementsFromHtml(a,"img");return this._storeMatched(a,b,"Images","img")},restoreLinks:function(a){return this._restoreMatched(a,"Links","a")},restoreImages:function(a){return this._restoreMatched(a,"Images","img")},_cleanWrapped:function(a){return a=a.replace(new RegExp("<p><figure([\\w\\W]*?)</figure></p>","gi"),"<figure$1</figure>")},_cleanGDocs:function(a){return a=a.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2"),a=a.replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3"),a=a.replace(/<span[^>]*(font-style:\s?italic;\s?font-weight:\s?bold|font-weight:\s?bold;\s?font-style:\s?italic)[^>]*>([\w\W]*?)<\/span>/gi,"<b><i>$2</i></b>"),a=a.replace(/<span[^>]*(font-style:\s?italic;\s?font-weight:\s?600|font-weight:\s?600;\s?font-style:\s?italic)[^>]*>([\w\W]*?)<\/span>/gi,"<b><i>$2</i></b>"),a=a.replace(/<span[^>]*(font-style:\s?italic;\s?font-weight:\s?700|font-weight:\s?700;\s?font-style:\s?italic)[^>]*>([\w\W]*?)<\/span>/gi,"<b><i>$2</i></b>"),a=a.replace(/<span[^>]*font-style:\s?italic[^>]*>([\w\W]*?)<\/span>/gi,"<i>$1</i>"),a=a.replace(/<span[^>]*font-weight:\s?bold[^>]*>([\w\W]*?)<\/span>/gi,"<b>$1</b>"),a=a.replace(/<span[^>]*font-weight:\s?700[^>]*>([\w\W]*?)<\/span>/gi,"<b>$1</b>"),a=a.replace(/<span[^>]*font-weight:\s?600[^>]*>([\w\W]*?)<\/span>/gi,"<b>$1</b>")},_cleanMsWord:function(a){a=a.replace(/<!--[\s\S]+?-->/gi,""),a=a.replace(/<(!|script[^>]*>.*?<\/script(?=[>\s])|\/?(\?xml(:\w+)?|img|meta|link|style|\w:\w+)(?=[\s\/>]))[^>]*>/gi,""),a=a.replace(/<(\/?)s>/gi,"<$1strike>"),a=a.replace(/&nbsp;/gi," "),a=a.replace(/<span\s+style\s*=\s*"\s*mso-spacerun\s*:\s*yes\s*;?\s*"\s*>([\s\u00a0]*)<\/span>/gi,function(a,b){return b.length>0?b.replace(/./," ").slice(Math.floor(b.length/2)).split("").join(" "):""});var b=this.utils.buildWrapper(a);b.find("p").each(function(a){var b=$R.dom(a),c=b.attr("style"),d=/mso-list:\w+ \w+([0-9]+)/.exec(c);d&&b.data("_listLevel",parseInt(d[1],10))}),this._parseWordLists(b),b.find("[align]").removeAttr("align"),b.find("[name]").removeAttr("name"),b.find("span").each(function(a){var b=$R.dom(a);/mso-list:Ignore/.exec(b.attr("style"))?b.remove():b.unwrap()}),b.find("[style]").removeAttr("style"),b.find("[class^='Mso']").removeAttr("class"),b.find("a").filter(function(a){return!a.hasAttribute("href")}).unwrap(),a=this.utils.getWrapperHtml(b),a=a.replace(/<p[^>]*><\/p>/gi,""),a=a.replace(/<li>·/gi,"<li>"),a=a.trim(),a=a.replace(/\/(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)>\s+<(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)/gi,"/$1>\n<$2");for(var c="",d=a.split(/\n/),e=0;e<d.length;e++){var f=""!==d[e]&&-1===d[e].search(/>$/)?" ":"\n";c+=d[e]+f}return c},_parseWordLists:function(a){var b=0,c=null,d=null,e=!1;a.find("p").each(function(a){var f=$R.dom(a),g=f.data("_listLevel");if(null!==g){var h=f.text(),i="<ul></ul>";if(/^\s*\w+\./.test(h)){var j=/([0-9])\./.exec(h);if(j){var k=parseInt(j[1],10);i=k>1?'<ol start="'+k+'"></ol>':"<ol></ol>"}else i="<ol></ol>"}if(g>b)if(0===b)f.before(i),c=f.prev();else{var l=$R.dom(i);d?(d.append(l),c=l,e=!0):c.append(l)}f.find("span").first().unwrap(),d=$R.dom("<li>"+f.html().trim()+"</li>"),c.append(d),f.remove(),e&&(c=c.parent()),b=g,e=!1}else b=0})},_isSpacedEmpty:function(a){return-1!==a.search(this.reSpacedEmpty)},_isParagraphEmpty:function(a){return-1!==a.search(/^<p><\/p>$/i)},_isHtmlMsWord:function(a){return a.match(/class="?Mso|style="[^"]*\bmso-|style='[^'']*\bmso-|w:WordDocument/i)},_setSpanAttr:function(a){var b=this.utils.buildWrapper(a);return b.find("span").attr("data-redactor-span",!0),this.utils.getWrapperHtml(b)},_setStyleCache:function(a){var b=this.utils.buildWrapper(a);return b.find("[style]").each(function(a){var b=$R.dom(a);b.attr("data-redactor-style-cache",b.attr("style"))}),this.utils.getWrapperHtml(b)},_setPreClass:function(a){var b=this.utils.buildWrapper(a);return b.find("pre").addClass(this.opts.preClass),this.utils.getWrapperHtml(b)},_setLinkNofollow:function(a){var b=this.utils.buildWrapper(a);return b.find("a").attr("rel","nofollow"),this.utils.getWrapperHtml(b)},_replaceScriptTag:function(a){return a.replace(this.reScriptTag,'<pre class="redactor-script-tag" $1>$2</pre>')},_unreplaceScriptTag:function(a){return a.replace(/<pre class="redactor-script-tag"(.*?[^>]?)>([\w\W]*?)<\/pre>/gi,"<script$1>$2<\/script>")},_replaceNlToBr:function(a){return a.replace(/\n/g,"<br />")},_removeScriptTag:function(a){return a.replace(this.reScriptTag,"")},_storeMatched:function(a,b,c,d){if(this["stored"+c]=[],b)for(var e=0;e<b.length;e++)this["stored"+c][e]=b[e],a=a.replace(b[e],"####"+d+e+"####");return a},_restoreMatched:function(a,b,c){if(this["stored"+b])for(var d=0;d<this["stored"+b].length;d++)a=a.replace("####"+c+d+"####",this["stored"+b][d]);return a},_decodeMarkers:function(a){return a.replace(/&lt;span\sid="selection-marker-(start|end)"\sclass="redactor-selection-marker"&gt;(.*?[^>]?)&lt;\/span&gt;/g,'<span id="selection-marker-$1" class="redactor-selection-marker">​</span>')},_encodeOuter:function(a){return this.encodeEntities(a.outerHTML)},_encodePreCodeLine:function(a){var b=a.firstChild;if("PRE"!=a.tagName||!b||"CODE"!==b.tagName){var c=this.decodeEntities(a.innerHTML);c=c.replace(/&nbsp;/g," ").replace(/<br\s?\/?>/g,"\n"),c=this.opts.preSpaces?c.replace(/\t/g,new Array(this.opts.preSpaces+1).join(" ")):c,a.textContent=c}}}),$R.add("class","cleaner.figure",{init:function(a){this.app=a,this.opts=a.opts,this.utils=a.utils,this.detector=a.detector},convert:function(a,b){var c=this.utils.buildWrapper(a);return c.find("img").each(this._convertImage.bind(this)),c.find("hr").each(this._convertLine.bind(this)),c.find("iframe").each(this._convertIframe.bind(this)),c.find("table").each(this._convertTable.bind(this)),c.find("form").each(this._convertForm.bind(this)),c.find("figure pre").each(this._convertCode.bind(this)),c.find("[data-redactor-type=variable]").addClass("redactor-component"),c.find("figure").not(".redactor-component, .redactor-figure-code").each(this._convertWidget.bind(this)),c.find("figure pre").each(this._setContenteditableCode.bind(this)),c.find(".redactor-component, .non-editable").attr("contenteditable",!1),this.detector.isIe()&&c.find("[data-redactor-type=table]").removeAttr("contenteditable"),c.find("figcaption, td, th").attr("contenteditable",!0),c.find(".redactor-component, figcaption").attr("tabindex","-1"),this._acceptExtraRules(c,b),this.utils.getWrapperHtml(c)},unconvert:function(a,b){var c=this.utils.buildWrapper(a);return c.find("th, td, figcaption, figure, pre, code, .redactor-component").removeAttr("contenteditable tabindex"),c.find("figure").removeClass("redactor-component redactor-component-active redactor-uploaded-figure"),c.find("[data-redactor-type=variable]").removeClass("redactor-component redactor-component-active"),c.find("figure[data-redactor-type=line]").unwrap(),c.find("figure[data-redactor-type=widget]").each(this._unconvertWidget.bind(this)),c.find("figure[data-redactor-type=form]").each(this._unconvertForm.bind(this)),c.find("figure[data-redactor-type=table]").each(this._unconvertTable.bind(this)),c.find("figure[data-redactor-type=image]").removeAttr("rel").each(this._unconvertImages.bind(this)),c.find("img").removeAttr("data-redactor-type").removeClass("redactor-component"),c.find(".non-editable").removeAttr("contenteditable"),c.find("figure").each(this._removeTypes.bind(this)),c.find("span.redactor-component-caret").remove(),this.opts.breakline&&c.find('[data-redactor-tag="br"]').each(function(a){a.lastChild&&"BR"!==a.lastChild.tagName&&a.appendChild(document.createElement("br"))}).unwrap(),this._acceptExtraRules(c,b),a=this.utils.getWrapperHtml(c),a=a.replace(/<br\s?\/?>$/,"")},_convertImage:function(a){var b=$R.dom(a);if(!this._isNonEditable(b)){b.attr("data-image")||b.attr("data-image",this.utils.getRandomId());var c=b.closest("a"),d=b.closest("figure");if(0===d.children().not("a, img, br, figcaption").length){if(0===d.length){var e=0!==c.length?c.closest("p"):b.closest("p");if(!1===this.opts.imageFigure&&0!==e.length){d=this.utils.replaceToTag(e,"figure"),d.addClass("redactor-replace-figure")}else d=0!==c.length?c.wrap("<figure>"):b.wrap("<figure>")}else d.hasClass("redactor-uploaded-figure")?d.removeClass("redactor-uploaded-figure"):d.addClass("redactor-keep-figure");this._setFigure(d,"image")}}},_convertTable:function(a){if(!this._isNonEditable(a)){var b=this._wrapFigure(a);this._setFigure(b,"table")}},_convertLine:function(a){if(!this._isNonEditable(a)){var b=this._wrapFigure(a);this._setFigure(b,"line")}},_convertForm:function(a){if(!this._isNonEditable(a)){var b=this.utils.replaceToTag(a,"figure");this._setFigure(b,"form")}},_convertIframe:function(a){if(!this._isNonEditable(a)){if(0===$R.dom(a).closest(".redactor-component").length){var b=a.getAttribute("src"),c=b&&(b.match(this.opts.regex.youtube)||b.match(this.opts.regex.vimeo)),d=this._wrapFigure(a);c&&this._setFigure(d,"video")}}},_convertCode:function(a){if(!this._isNonEditable(a)){var b=this._wrapFigure(a);this._setFigure(b,"code")}},_convertWidget:function(a){if(!this._isNonEditable(a)){var b=$R.dom(a);b.addClass("redactor-component"),b.attr("data-redactor-type","widget"),b.attr("data-widget-code",encodeURI(a.innerHTML.trim()))}},_unconvertForm:function(a){this.utils.replaceToTag(a,"form")},_unconvertTable:function(a){$R.dom(a).unwrap()},_unconvertWidget:function(a){var b=$R.dom(a);b.html(decodeURI(b.attr("data-widget-code"))),b.removeAttr("data-widget-code")},_unconvertImages:function(a){var b=$R.dom(a);b.removeClass("redactor-component");var c=0!==b.closest("li").length,d=0!==b.closest("table").length,e=0!==b.find("figcaption").length,f=b.attr("style"),g=!(null===f||""===f),h=""!==b.attr("class");(c||d&&!e&&!g&&!h)&&b.unwrap()},_removeTypes:function(a){var b=$R.dom(a),c=b.attr("data-redactor-type"),d=["image","widget","line","video","code","form","table"];if(c&&-1!==d.indexOf(c)&&b.removeAttr("data-redactor-type"),b.hasClass("redactor-keep-figure"))b.removeClass("redactor-keep-figure");else if("image"===c&&!1===this.opts.imageFigure){var e=0!==b.find("figcaption").length;e||(b.hasClass("redactor-replace-figure")?(b.removeClass("redactor-replace-figure"),this.utils.replaceToTag(b,"p")):b.unwrap())}b.removeClass("redactor-replace-figure")},_wrapFigure:function(a){var b=$R.dom(a),c=b.closest("figure");return 0===c.length?b.wrap("<figure>"):c},_setFigure:function(a,b){a.addClass("redactor-component"),a.attr("data-redactor-type",b)},_setContenteditableCode:function(a){if(!this._isNonEditable(a)){var b=$R.dom(a),c=b.children("code").first();(0!==c.length?c:b).attr("contenteditable",!0).attr("tabindex","-1")}},_acceptExtraRules:function(a,b){for(var c in b)"function"==typeof b[c]&&b[c](a)},_isNonEditable:function(a){return 0!==$R.dom(a).closest(".non-editable").length}}),$R.add("class","cleaner.paragraphize",{init:function(a){this.app=a,this.opts=a.opts,this.utils=a.utils,this.element=a.element,this.stored=[],this.remStart="#####replace",this.remEnd="#####",this.paragraphizeTags=["table","div","pre","form","ul","ol","h1","h2","h3","h4","h5","h6","dl","blockquote","figcaption","address","section","header","footer","aside","article","object","style","script","iframe","select","input","textarea","button","option","map","area","math","hr","fieldset","legend","hgroup","nav","figure","details","menu","summary","p"]},convert:function(a){var b=this._isConverted(a);return!0===b?this._convert(a):b},_convert:function(a){var b=this.opts.breakline?"sdivtag":this.opts.markup;a=this._storeTags(a);var c=[],d=a.match(new RegExp("\x3c!--([\\w\\W]*?)--\x3e","gi"));if(null!==d)for(var e=0;e<d.length;e++)a=a.replace(d[e],"#####xstarthtmlcommentzz"+e+"xendhtmlcommentzz#####"),c.push(d[e]);a=a.trim(),this.opts.breakline?(a=a.replace(new RegExp("\\n#####","gi"),"xnonbreakmarkerz#####"),a=a.replace(new RegExp("#####\\n\\n","gi"),"#####\nxnonbreakmarkerz"),a=a.replace(new RegExp("#####\\n","gi"),"#####xnonbreakmarkerz"),a=a.replace(/<br\s?\/?>\n/gi,"<br>"),a=a.replace(/\n/g,"<br>"),a=a.replace(/xnonbreakmarkerz/gi,"\n")):a=a.replace(/[\n]+/g,"\n"),a=this._trimEmptyLines(a),a=this.opts.breakline?a:a.replace(/<br\s?\/?>\n/gi,"xbreakmarkerz\n"),a=a.replace(/(?:\r\n|\r|\n)/g,"xparagraphmarkerz"),a=a.replace(/xparagraphmarkerz/gi,"</"+b+">\n<"+b+">"),a=this.opts.breakline?a:a.replace(/xbreakmarkerz/gi,"<br>"),a="<"+b+">"+a+"</"+b+">",a=a.replace(new RegExp("<"+b+">#####","gi"),"#####"),a=a.replace(new RegExp("#####</"+b+">","gi"),"#####"),a=this._restoreTags(a);for(var e=0;e<c.length;e++)a=a.replace("#####xstarthtmlcommentzz"+e+"xendhtmlcommentzz#####",c[e]);return a=this.opts.breakline?a:a.replace(new RegExp("<"+b+"><br\\s?/?></"+b+">","gi"),"<"+b+"></"+b+">"),a=a.replace(new RegExp("<sdivtag>","gi"),'<div data-redactor-tag="br">'),a=a.replace(new RegExp("sdivtag","gi"),"div")},_storeTags:function(a){var b=this,c=this.utils.buildWrapper(a);return this.opts.breakline&&c.find("p").each(function(a){var b=$R.dom(a);0===b.closest("figure[data-redactor-type=widget],figure[data-redactor-type=form],.non-editable").length&&(b.append("<br><br>"),b.unwrap())}),c.find(this.paragraphizeTags.join(", ")).each(function(a,c){var d=document.createTextNode("\n"+b.remStart+c+b.remEnd+"\n");b.stored.push(a.outerHTML),a.parentNode.replaceChild(d,a)}),this.utils.getWrapperHtml(c)},_restoreTags:function(a){for(var b=0;b<this.stored.length;b++)this.stored[b]=this.stored[b].replace(/\$/g,"&#36;"),a=a.replace(this.remStart+b+this.remEnd,this.stored[b]);return a},_trimEmptyLines:function(a){for(var b="",c=a.split("\n"),d=0;d<c.length;d++)""!==c[d].trim()&&(b+=c[d]+"\n")
;return b.replace(/\n$/,"")},_isConverted:function(a){return this._isDisabled(a)?a:!this._isEmptyHtml(a)||this.opts.emptyHtml},_isDisabled:function(){return!1===this.opts.paragraphize||this.element.isType("inline")},_isEmptyHtml:function(a){return""===a||"<p></p>"===a||"<div></div>"===a}}),$R.add("service","detector",{init:function(a){this.app=a,this.userAgent=navigator.userAgent.toLowerCase()},isWebkit:function(){return/webkit/.test(this.userAgent)},isFirefox:function(){return this.userAgent.indexOf("firefox")>-1},isIe:function(a){if(document.documentMode||/Edge/.test(navigator.userAgent))return"edge";var b;return b=RegExp("msie"+(isNaN(a)?"":"\\s"+a),"i").test(navigator.userAgent),b||(b=!!navigator.userAgent.match(/Trident.*rv[ :]*11\./)),b},isMobile:function(){return/(iPhone|iPod|Android)/.test(navigator.userAgent)},isDesktop:function(){return!/(iPhone|iPod|iPad|Android)/.test(navigator.userAgent)},isIpad:function(){return/iPad/.test(navigator.userAgent)}}),$R.add("service","offset",{init:function(a){this.app=a},get:function(a,b){var c={start:0,end:0},d=this.utils.getNode(a);if(!d)return!1;var e=this.editor.isEditor(d),f=!!e||this.selection.isIn(d),g=this.selection.getRange();if(e||f){if(this.selection.is()&&f){var h=$R.dom(g.startContainer),i=h.hasClass("redactor-component")?g.startOffset:0,j=g.cloneRange();j.selectNodeContents(d),j.setEnd(g.startContainer,g.startOffset);var k=this._getString(g,b);c.start=this._getString(j,b).length-i,c.end=c.start+k.length+i}}else c=!1;return c},set:function(a,b){if(!this._setComponentOffset(b)){this.component.clearActive();var c=this.utils.getNode(b);if(c){var d=this.size(c),e=0,f=document.createRange();a.end=a.end>d?d:a.end,f.setStart(c,0),f.collapse(!0);for(var g=[c],h=!1,i=!1;!i&&(c=g.pop());)if(3==c.nodeType){var j=e+c.length;!h&&!this._isFigcaptionNext(c)&&a.start>=e&&a.start<=j&&(f.setStart(c,a.start-e),h=!0),h&&a.end>=e&&a.end<=j&&(f.setEnd(c,a.end-e),i=!0),e=j}else for(var k=c.childNodes.length;k--;)g.push(c.childNodes[k]);this.selection.setRange(f)}}},size:function(a,b){var c=this.utils.getNode(a);if(c){var d=document.createRange(),e=d.cloneRange();return e.selectNodeContents(c),this._getString(e,b).length}return 0},_getString:function(a,b){var c=a.toString();return c=this.editor.isEmpty()?c.replace(/\uFEFF/g,""):c,c=b?c.trim():c},_setComponentOffset:function(a){return!!this.component.isNonEditable(a)&&this.component.setActive(a)},_isFigcaptionNext:function(a){var b=a.nextSibling;return""===a.nodeValue.trim()&&b&&"FIGCAPTION"===b.tagName}}),$R.add("service","inspector",{init:function(a){this.app=a},parse:function(a){return $R.create("inspector.parser",this.app,this,a)},isText:function(a){if("string"==typeof a&&!/^\s*<(\w+|!)[^>]*>/.test(a))return!0;var b=$R.dom(a).get();return b&&3===b.nodeType},isInlineTag:function(a,b){var c=this._extendTags(this.opts.inlineTags,b);return this._isTag(a)&&-1!==c.indexOf(a.toLowerCase())},isBlockTag:function(a,b){var c=this._extendTags(this.opts.blockTags,b);return this._isTag(a)&&-1!==c.indexOf(a.toLowerCase())},isTableCellTag:function(a){return-1!==["td","th"].indexOf(a.toLowerCase())},isHeadingTag:function(a){return-1!==["h1","h2","h3","h4","h5","h6"].indexOf(a.toLowerCase())},_isTag:function(a){return void 0!==a&&a},_extendTags:function(a,b){if(a=a.concat(a),b)for(var c=0;c<b.length;c++)a.push(b[c]);return a}}),$R.add("class","inspector.parser",{init:function(a,b,c){this.app=a,this.uuid=a.uuid,this.opts=a.opts,this.utils=a.utils,this.editor=a.editor,this.selection=a.selection,this.inspector=b,this.el=c,this.$el=$R.dom(this.el),this.node=this.$el.get(),this.node&&8===this.node.nodeType&&(this.node=!1),this.$component=this.$el.closest(".redactor-component",".redactor-in")},isEditor:function(){return this.node===this.editor.getElement().get()},isInEditor:function(){return 0!==this.$el.parents(".redactor-in-"+this.uuid).length},isComponent:function(){return 0!==this.$component.length},isComponentType:function(a){return this.getComponentType()===a},isComponentActive:function(){return this.isComponent()&&this.$component.hasClass("redactor-component-active")},isComponentEditable:function(){var a=["code","table"],b=this.getComponentType();return this.isComponent()&&-1!==a.indexOf(b)},isFigcaption:function(){return this.getFigcaption()},isPre:function(){return this.getPre()},isCode:function(){var a=this.$el.closest("code"),b=a.parent("pre");return 0!==a.length&&0===b.length},isList:function(){return this.getList()},isFirstListItem:function(){return this._getLastOrFirstListItem("first")},isLastListItem:function(){return this._getLastOrFirstListItem("last")},isFirstTableCell:function(){return this._getLastOrFirstTableCell("first")},isLastTableCell:function(){return this._getLastOrFirstTableCell("last")},isTable:function(){return this.isComponentType("table")||this.getTable()},isHeading:function(){return this.getHeading()},isBlockquote:function(){return this.getBlockquote()},isDl:function(){return this.getDl()},isParagraph:function(){return this.getParagraph()},isLink:function(){return this.getLink()},isFile:function(){return this.getFile()},isText:function(){return this.inspector.isText(this.el)},isInline:function(){var a=this.opts.inlineTags;return!!this.isElement()&&-1!==a.indexOf(this.node.tagName.toLowerCase())},isBlock:function(){var a=this.opts.blockTags;return!!this.isElement()&&-1!==a.indexOf(this.node.tagName.toLowerCase())},isElement:function(){return this.node&&this.node.nodeType&&3!==this.node.nodeType},hasParent:function(a){return 0!==this.$el.closest(a.join(",")).length},getNode:function(){return this.node},getTag:function(){return!!this.isElement()&&this.node.tagName.toLowerCase()},getComponent:function(){return!!this.isComponent()&&this.$component.get()},getComponentType:function(){return!!this.isComponent()&&this.$component.attr("data-redactor-type")},getFirstNode:function(){return this.utils.getFirstNode(this.node)},getLastNode:function(){return this.utils.getLastNode(this.node)},getFirstElement:function(){return this.utils.getFirstElement(this.node)},getLastElement:function(){return this.utils.getLastElement(this.node)},getFigcaption:function(){return this._getClosestNode("figcaption")},getPre:function(){return this._getClosestNode("pre")},getCode:function(){return this._getClosestNode("code")},getList:function(){return this._getClosestNode("ul, ol")},getParentList:function(){return this._getClosestUpNode("ul, ol")},getListItem:function(){return this._getClosestNode("li")},getTable:function(){return this.getComponentType("table")?this.$component.find("table").get():this._getClosestNode("table")},getTableCell:function(){var a=this.$el.closest("td, th");return 0!==a.length&&a.get()},getComponentCodeElement:function(){return!!this.isComponentType("code")&&this.$component.find("pre code, pre").last().get()},getImageElement:function(){return!!this.isComponentType("image")&&this.$component.find("img").get()},getParagraph:function(){return this._getClosestNode("p")},getHeading:function(){return this._getClosestNode("h1, h2, h3, h4, h5, h6")},getDl:function(){return this._getClosestNode("dl")},getBlockquote:function(){return this._getClosestNode("blockquote")},getLink:function(){var a=this.isComponent()&&!this.isFigcaption();if(this.isComponentType("table")||!a){var b=this._getClosestElement("a");return!(!b||b.attr("data-file"))&&b.get()}return!1},getFile:function(){var a=this.isComponent();if(this.isComponentType("table")||!a){var b=this._getClosestElement("a");return!(!b||!b.attr("data-file"))&&b.get()}return!1},findFirstNode:function(a){return this.$el.find(a).first().get()},findLastNode:function(a){return this.$el.find(a).last().get()},_getLastOrFirstListItem:function(a){var b=this.getList(),c=this.getTag();if(b&&"li"===c){var d=$R.dom(b).find("li")[a]().get();if(d&&this.node===d)return!0}return!1},_getLastOrFirstTableCell:function(a){var b=this.getTable(),c=this.getTag();if(b&&("td"===c||"th"===c)){var d=$R.dom(b).find("td, th")[a]().get();if(d&&this.node===d)return!0}return!1},_getClosestUpNode:function(a){var b=this.$el.parents(a,".redactor-in").last();return 0!==b.length&&b.get()},_getClosestNode:function(a){var b=this.$el.closest(a,".redactor-in");return 0!==b.length&&b.get()},_getClosestElement:function(a){var b=this.$el.closest(a,".redactor-in");return 0!==b.length&&b}}),$R.add("service","marker",{init:function(a){this.app=a},build:function(a,b){var c=document.createElement("span");return c.id="selection-marker-"+this._getPos(a),c.className="redactor-selection-marker",c.innerHTML=this.opts.markerChar,b?c.outerHTML:c},buildHtml:function(a){return this.build(a,!0)},insert:function(a){this.remove();var b="both"!==a&&("start"===a||this.selection.isCollapsed());this.selection.is()||this.editor.focus();var c=this.selection.getRange();if(c){var d=this.build("start"),e=this.build("end"),f=c.cloneRange();return b||(f.collapse(!1),f.insertNode(e)),f.setStart(c.startContainer,c.startOffset),f.collapse(!0),f.insertNode(d),c.setStartAfter(d),b||c.setEndBefore(e),this.selection.setRange(c),d}},find:function(a,b){var c=this.editor.getElement(),d=(b||c).find("span#selection-marker-"+this._getPos(a));return 0!==d.length&&d.get()},restore:function(){var a=this.find("start"),b=this.find("end"),c=this.selection.getRange();if(c&&this.selection.is()||(this.editor.focus(),c=document.createRange()),a){var d=!!b&&b.previousSibling,e=a.nextSibling;e=(!e||3!==e.nodeType||""!==e.textContent.replace(/[\n\t]/g,""))&&e,b?e&&"selection-marker-end"===e.id?this._restoreInject(c,a):d&&e?(c.selectNodeContents(d),c.collapse(!1),c.setStart(e,0)):d&&!e?(c.selectNodeContents(d),c.collapse(!1),c.setStartAfter(a)):(c.setStartAfter(a),c.setEndBefore(b)):e?(c.selectNodeContents(e),c.collapse(!0)):this._restoreInject(c,a),this.selection.setRange(c),a&&a.parentNode.removeChild(a),b&&b.parentNode.removeChild(b)}},remove:function(){var a=this.find("start"),b=this.find("end");a&&a.parentNode.removeChild(a),b&&b.parentNode.removeChild(b)},_getPos:function(a){return void 0===a?"start":a},_restoreInject:function(a,b){var c=this.utils.createInvisibleChar();$R.dom(b).after(c),a.selectNodeContents(c),a.collapse(!1)}}),$R.add("service","component",{init:function(a){this.app=a,this.activeClass="redactor-component-active"},create:function(a,b){return $R.create(a+".component",this.app,b)},build:function(a){var b,c=$R.dom(a),d=c.attr("data-redactor-type");return d&&(b=this.create(d,a)),b||a},remove:function(a,b){var c=$R.dom(a).closest(".redactor-component"),d=c.attr("data-redactor-type"),e=c.parent(),f=this.inspector.parse(e),g=this.utils.findSiblings(c,"prev"),h=this.utils.findSiblings(c,"next");if(!1!==this.app.broadcast(d+".delete",c)){if(c.remove(),this.app.broadcast(d+".deleted",c),this.app.broadcast("contextbar.close"),this.app.broadcast("imageresizer.stop"),!1!==b){var i=f.getTableCell();i&&this.utils.isEmptyHtml(i.innerHTML)?this.caret.setStart(i):h?this.caret.setStart(h):g?this.caret.setEnd(g):this.editor.startFocus()}this.editor.isEmpty()&&(this.editor.setEmpty(),this.editor.startFocus(),this.app.broadcast("empty"))}},isNonEditable:function(a){var b=this.inspector.parse(a);return b.isComponent()&&!b.isComponentEditable()},isActive:function(a){var b;if(a){var c=this.inspector.parse(a);return b=$R.dom(c.getComponent()),b.hasClass(this.activeClass)}return b=this._find(),0!==b.length},getActive:function(a){var b=this._find();return 0!==b.length&&(a?b:b.get())},setActive:function(a){this.clearActive(),this.editor.focus();var b=this.inspector.parse(a),c=b.getComponent(),d=$R.dom(c);if(!b.isFigcaption()){var e=d.find(".redactor-component-caret");0===e.length&&(e=this._buildCaret(),d.prepend(e)),this.caret.setAtStart(e.get())}d.addClass(this.activeClass)},clearActive:function(){var a=this._find();a.removeClass(this.activeClass),a.find(".redactor-component-caret").remove(),this.app.broadcast("imageresizer.stop")},setOnEvent:function(a,b){this.clearActive();var c=this.inspector.parse(a.target);c.isFigcaption()||c.isComponentEditable()||c.isComponent()&&(this.setActive(a.target),!0!==b&&a.preventDefault())},executeScripts:function(){for(var $editor=this.editor.getElement(),scripts=$editor.find("[data-redactor-type]").find("script").getAll(),i=0;i<scripts.length;i++)if(""!==scripts[i].src){var src=scripts[i].src;this.$doc.find('head script[src="'+src+'"]').remove();var $script=$R.dom("<script>");$script.attr("src",src),$script.attr("async defer"),-1!==src.search("instagram")&&$script.attr("onload","window.instgrm.Embeds.process()");var head=document.getElementsByTagName("head")[0];head&&head.appendChild($script.get())}else eval(scripts[i].innerHTML)},_find:function(){return this.editor.getElement().find("."+this.activeClass)},_buildCaret:function(){var a=$R.dom("<span>");return a.addClass("redactor-component-caret"),a.attr("contenteditable",!0),a}}),$R.add("service","insertion",{init:function(a){this.app=a},set:function(a,b,c){return a=!1!==b?this.cleaner.input(a):a,a=!1!==b?this.cleaner.paragraphize(a):a,this.editor.getElement().html(a),!1!==c&&this.editor.endFocus(),a},insertNode:function(a,b){this.editor.focus();var c=this.utils.isFragment(a)?a:this.utils.createFragment(a);return this._collapseSelection(),this._insertFragment(c),this._setCaret(b,c),this._sendNodes(c.nodes)},insertBreakLine:function(){return this.insertNode(document.createElement("br"),"after")},insertNewline:function(){return this.insertNode(document.createTextNode("\n"),"after")},insertText:function(a){return this.insertHtml(this.cleaner.getFlatText(a))},insertChar:function(a){return this.insertNode(a,"after")},insertRaw:function(a){return this.insertHtml(a,!1)},insertToEnd:function(a,b){if(a){3===a.nodeType&&-1!==a.nodeValue.search(/^\n/)&&(a=a.previousElementSibling);var c=$R.dom(a);if(c.attr("data-redactor-type")===b){var d=this.opts.breakline?"<br>":"<p>",e=$R.dom(d);c.after(e),this.caret.setStart(e)}}},insertPoint:function(a){var b,c,d=this.marker.build("start"),e=!1,f=a.clientX,g=a.clientY;if(document.caretPositionFromPoint){var h=document.caretPositionFromPoint(f,g),i=document.getSelection();c=this.inspector.parse(h.offsetNode),c.isInEditor()&&(b=i.getRangeAt(0),b.setStart(h.offsetNode,h.offset),b.collapse(!0),b.insertNode(d),e=!0)}else document.caretRangeFromPoint&&(b=document.caretRangeFromPoint(f,g),c=this.inspector.parse(b.startContainer),c.isInEditor()&&(b.insertNode(d),e=!0));return e},insertToPoint:function(a,b,c){if(!0!==c&&!this.insertPoint(a)){var d=this.editor.getLastNode();$R.dom(d).after(this.marker.build("start"))}return this.component.clearActive(),this.selection.restoreMarkers(),this.insertHtml(b)},insertToOffset:function(a,b){return this.offset.set({start:a,end:a}),this.insertHtml(b)},insertHtml:function(a,b){if(this.opts.input){var c=this.utils.parseHtml(a);if(this.selection.isAll())return this._insertToAllSelected(c);if(!this.selection.is()){var d=$R.dom("<p>");this.editor.getElement().append(d),this.caret.setStart(d)}var e=this.selection.isCollapsed(),f=this.selection.isText(),g=this.selection.getCurrent(),h=this.inspector.parse(g);this._collapseSelection(),c=this._getCleanedInput(c,h,b);var i,j,k=this._isFigure(c.html),l=this._isComponentSpan(c.html),m=this.inspector.isText(c.html);if(this.editor.isEmpty())return this._insertToEmptyEditor(c.html);if(h.isComponent()&&!h.isComponentEditable())return this._insertToWidget(g,h,c.html);if(l)return this.insertNode(c.nodes,"end");if(k&&!f&&!h.isList())return h.isInline()?this._insertToInline(g,c):(i=this.utils.createFragment(c.html),this.utils.splitNode(g,i),this.caret.setEnd(i.last),this._sendNodes(i.nodes));if(h.isCode())return this._insertToCode(c,g,b);if(h.isPre())return this._insertToPre(c,b);if(h.isHeading()||h.isFigcaption())return c.html=!1!==b?this.cleaner.removeTagsExcept(c.html,["a"]):c.html,c.html=!1!==b?this.cleaner.replaceNbspToSpaces(c.html):c.html,i=this.utils.createFragment(c.html),this.insertNode(i,"end");if(m)return!f&&"br"!==this.opts.markup&&this._hasBlocksAndImages(c.nodes)?(c.html=!1!==b?this.cleaner.paragraphize(c.html):c.html,i=this.utils.createFragment(c.html),this.utils.splitNode(g,i),this.caret.setEnd(i.last),this._sendNodes(i.nodes)):(c.html=!1!==b?c.html.replace(/\n/g,"<br>"):c.html,i=this.utils.createFragment(c.html),this.insertNode(i.nodes,"end"));if(!e&&!k)return c.html=!1!==b?this.cleaner.paragraphize(c.html):c.html,i=this.utils.createFragment(c.html),this.insertNode(i,"end");if(h.isInline()&&!this._isPlainHtml(c.html))return this._insertToInline(g,c);if(h.isBlockquote()||h.isDl())return j=this.opts.inlineTags,j.concat(["br"]),c.html=!1!==b?this.cleaner.replaceBlocksToBr(c.html):c.html,c.html=!1!==b?this.cleaner.removeTagsExcept(c.html,j):c.html,i=this.utils.createFragment(c.html),this.insertNode(i,"end");if(h.isParagraph())return this._isPlainHtml(c.html)?this.insertNode(c.nodes,"end"):(c.html=!1!==b?this.cleaner.paragraphize(c.html):c.html,i=this.utils.createFragment(c.html),this.utils.splitNode(g,i),this.caret.setEnd(i.last),this._sendNodes(i.nodes));if(h.isList()&&(j=this.opts.inlineTags,j=j.concat(["br","li","ul","ol","img"]),c.html=!1!==b?this.cleaner.replaceBlocksToBr(c.html):c.html,c.html=!1!==b?this.cleaner.removeTagsExcept(c.html,j):c.html,c.html=!1!==b?this.cleaner.removeBrAtEnd(c.html):c.html,i=this.utils.createFragment(c.html),c.nodes=i.nodes,this._containsTags(c.html,["ul","ol","li"]))){var n=this.selection.getElement(g);if(n&&"LI"===n.tagName&&this.caret.isStart(n)){c.nodes=$R.dom(i.nodes).unwrap("ul, ol").getAll(),$R.dom(n).before(c.nodes);var o=c.nodes[c.nodes.length-1];return this.caret.setEnd(o),this._sendNodes(c.nodes)}return this._isPlainHtml(c.html)?this.insertNode(i,"end"):(i=this._buildList(c,n,i),this.utils.splitNode(g,i,!0),this.caret.setEnd(i.last),this._sendNodes(i.nodes))}return this.insertNode(c.nodes,"end")}},_insertToAllSelected:function(a){var b=this.set(a.html),c=this.utils.parseHtml(b);return this._sendNodes(c.nodes)},_insertToEmptyEditor:function(a){a=this.cleaner.paragraphize(a);var b=this.utils.createFragment(a),c=this.editor.getElement();return c.html(""),c.append(b.frag),this.caret.setEnd(b.last),this._sendNodes(b.nodes)},_insertToInline:function(a,b){var c=this.utils.createFragment(b.html);return this.utils.splitNode(a,c,!1,!0),this.caret.setEnd(c.last),this._sendNodes(c.nodes)},_insertToCode:function(a,b,c){a.html=!1!==c?this.cleaner.encodeHtml(a.html):a.html,a.html=!1!==c?this.cleaner.removeNl(a.html):a.html;var d=this.utils.createFragment(a.html),e=this.insertNode(d,"end");return this.utils.normalizeTextNodes(b),e},_insertToPre:function(a,b){a.html=!1!==b?this.cleaner.encodeHtml(a.html):a.html;var c=this.utils.createFragment(a.html);return this.insertNode(c,"end")},_insertToWidget:function(a,b,c){c=this._isComponentSpan(c)?c:this.cleaner.paragraphize(c);var d=this.utils.createFragment(c),e=b.getComponent(),f=$R.dom(e);return f.after(d.frag),f.remove(),this.caret.setEnd(d.last),this._sendNodes(d.nodes)},_insertFragment:function(a){var b=this.selection.getRange();if(b){if(this.selection.isCollapsed()){var c=b.startContainer;3!==c.nodeType&&"BR"===c.tagName&&(this.caret.setAfter(c),c.parentNode.removeChild(c))}else b.deleteContents();b.insertNode(a.frag)}},_sendNodes:function(a){for(var b=0;b<a.length;b++){var c=a[b],d=3!==c.nodeType&&"function"==typeof c.getAttribute&&c.getAttribute("data-redactor-type");d&&this.app.broadcast(d+".inserted",this.component.build(c))}return this.detector.isIe()&&this.editor.getElement().find("[data-redactor-type=table]").attr("contenteditable",!0),this.app.broadcast("inserted",a),this.component.executeScripts(),a},_setCaret:function(a,b){var c=this._isLastInline(b);a?(a=c&&"end"===a?"after":a,this.caret["set"+this.utils.ucfirst(a)](b.last)):!1!==a&&c&&this.caret.setAfter(b.last)},_isLastInline:function(a){if(a.last){return this.inspector.parse(a.last).isInline()}return!1},_getCleanedInput:function(a,b,c){var d=b.isCode()||b.isPre();return a.html=a.html.replace(/&nbsp;/g," "),a.html=d||!1===c?a.html:this.cleaner.input(a.html),a=d||!1===c?a:this.utils.parseHtml(a.html)},_getContainer:function(a){return $R.dom(this.utils.createTmpContainer(a))},_buildList:function(a,b,c){var d=a.nodes,e=d[0];if(e&&3!==e.nodeType&&"li"===e.tagName){var f=$R.dom(b),g=f.get().tagName.toLowerCase(),h=$R.dom("<"+g+" />");return h.append(c.nodes),this.utils.createFragment(h.get().outerHTML)}return c},_containsTags:function(a,b){return 0!==this._getContainer(a).find(b.join(",")).length},_collapseSelection:function(){},_hasFigureOrTable:function(a){return 0!==this._getContainer(a).find("figure, table").length},_hasBlocks:function(a){return 0!==this._getContainer(a).find(this.opts.blockTags.join(",")).length},_hasBlocksAndImages:function(a){return 0!==this._getContainer(a).find(this.opts.blockTags.join(",")+",img").length},_isPlainHtml:function(a){return 0===this._getContainer(a).find(this.opts.blockTags.join(",")+", img").length},_isFigure:function(a){if(this._isHtmlString(a))return 0!==$R.dom(a).closest("figure").length},_isComponentSpan:function(a){if(this._isHtmlString(a))return 0!==$R.dom(a).closest("span.redactor-component").length},_isHtmlString:function(a){return!("string"==typeof a&&!/^\s*<(\w+|!)[^>]*>/.test(a))}}),$R.add("service","block",{mixins:["formatter"],init:function(a){this.app=a},format:function(a){return this.type=a.type?a.type:"set",this.tag="string"==typeof a?a:a.tag,this.tag=this._prepareTag(this.tag),this.tag=this.tag.toLowerCase(),"string"==typeof a?this.args=!1:this.buildArgs(a),this._format()},getBlocks:function(a){return this.selection.getBlocks({tags:a||this._getTags(),first:!0})},getElements:function(a){var b=this.selection.getBlock();return this.selection.isCollapsed()||!b||"TD"!==b.tagName&&"TH"!==b.tagName?$R.dom(this.getBlocks(a)):this._wrapInsideTable("div")},clearFormat:function(a){this.selection.save();var b=this.getElements(a||this._getTags());return b.each(function(a){for(;a.attributes.length>0;)a.removeAttribute(a.attributes[0].name)}),this.selection.restore(),b.getAll()},_format:function(){this.selection.save();var a,b,c,d,e=this.getBlocks(),f=this.selection.getBlock(),g=[];if(1===e.length&&"DIV"===e[0].tagName){if(!(a=this._getTextNodesData())||0===a.nodes.length)return g=this._replaceBlocks(e),g=this._sendNodes(g),setTimeout(function(){this.selection.restore()}.bind(this),0),g;b=this._getReplacedTag("set"),c=$R.dom("<"+b+">"),d=a.last.nextSibling,d&&"BR"===d.tagName&&$R.dom(d).remove();for(var h=0;h<a.nodes.length;h++)c.append(a.nodes[h]);return this.utils.splitNode(e[0],[c.get()]),g=this._sendNodes([c.get()]),this.utils.isEmptyHtml(c.html())?this.caret.setStart(c):setTimeout(function(){this.selection.restore()}.bind(this),0),g}if(e.length>0)return g=this._replaceBlocks(e),g=this._sendNodes(g),this.selection.isCollapsed()&&1===e.length&&this.utils.isEmpty(e[0])?this.caret.setStart(g[0]):setTimeout(function(){this.selection.restore()}.bind(this),1),g;if(!this.selection.isCollapsed()&&f&&("TD"===f.tagName||"TH"===f.tagName))return b=this._getReplacedTag("set"),c=this._wrapInsideTable(b),this.selection.setAll(c),this._sendNodes([c.get()]);if(this.selection.isCollapsed()&&f&&("TD"===f.tagName||"TH"===f.tagName)){var i=this._getChildTextNodes(f);b=this._getReplacedTag("set");var c=$R.dom("<"+b+">");$R.dom(i.first).before(c);for(var h=0;h<i.nodes.length;h++)c.append(i.nodes[h]);var d=c.get().nextSibling;return d&&"BR"===d.tagName&&$R.dom(d).remove(),this._sendNodes([c.get()])}return g},_wrapInsideTable:function(a){var b=this._getTextNodesData(),c=$R.dom("<"+a+">");$R.dom(b.first).before(c);for(var d=0;d<b.nodes.length;d++)c.append(b.nodes[d]);var e=c.get().nextSibling;return e&&"BR"===e.tagName&&$R.dom(e).remove(),c},_prepareTag:function(a){return void 0===a?this.opts.markup:a},_sendNodes:function(a){return a.length>0&&(a=this.applyArgs(a,!1),a=this._combinePre(a),a=this._cleanBlocks(a)),a},_getTags:function(){return["div","p","blockquote","pre","h1","h2","h3","h4","h5","h6"]},_replaceBlocks:function(a){for(var b=[],c=this._isToggleFormatType(a)?"toggle":"set",d=this._getReplacedTag(c),e=0;e<a.length;e++){var f=this.utils.replaceToTag(a[e],d);b.push(f.get())}return b},_getReplacedTag:function(a){var b="toggle"===a?this.opts.markup:this.tag;return this.opts.breakline&&"p"===b?"div":b},_getChildTextNodes:function(a){for(var b=a.childNodes,c=b[0],d=[],e=0;e<=b.length;e++){var f=b[e];if(f&&3!==f.nodeType&&this.inspector.isBlockTag(f.tagName))break;d.push(f)}return{nodes:d,first:c}},_getTextNodesData:function(){var a=this.selection.getNodes({textnodes:!0,keepbr:!0});if(0===a.length)return!1;for(var b=a[0],c=a[a.length-1],d=c,e=!1;!e;){var f=this.selection.getInline(d);d=f?f.nextSibling:d.nextSibling,d&&(3===d.nodeType||"BR"!==d.tagName&&!this.inspector.isBlockTag(d.tagName))?a.push(d):e=!0}return{nodes:a,first:b,last:c}},_isToggleFormatType:function(a){for(var b=0,c=a.length,d=0;d<c;d++)a[d]&&this.tag===a[d].tagName.toLowerCase()&&b++;return b===c},_combinePre:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c].nextElementSibling;if(d&&"PRE"===a[c].tagName&&"PRE"===d.tagName){var e=$R.dom(a[c]),f=$R.dom(d),g=document.createTextNode("\n");e.append(g),e.append(f),f.unwrap("pre")}b.push(a[c])}return b},_cleanBlocks:function(a){for(var b=["h1","h2","h3","h4","h5","h6"],c=this.opts.inlineTags,d=0;d<a.length;d++){var e=a[d].tagName.toLowerCase(),f=$R.dom(a[d]);-1!==b.indexOf(e)?f.find("span").not(".redactor-component, .non-editable, .redactor-selection-marker").unwrap():"pre"===e&&f.find(c.join(",")).not(".redactor-selection-marker").unwrap(),this.opts.breakline&&"div"===e?f.attr("data-redactor-tag","br"):f.removeAttr("data-redactor-tag"),this.utils.normalizeTextNodes(a[d])}return a}}),$R.add("service","inline",{mixins:["formatter"],init:function(a){this.app=a,this.count=0},format:function(a){if(!this._isFormat())return[];this.type=a.type?a.type:"set",this.tag="string"==typeof a?a:a.tag,this.tag=this.tag.toLowerCase(),this.tag=this.arrangeTag(this.tag),"string"==typeof a?this.args=!1:this.buildArgs(a),this.detector.isIe()||this.editor.disableNonEditables();var b=this.selection.isCollapsed()?this.formatCollapsed():this.formatUncollapsed();return this.detector.isIe()||this.editor.enableNonEditables(),b},_isFormat:function(){var a=this.selection.getCurrent(),b=this.inspector.parse(a),c=b.isComponent()&&!b.isComponentType("table")&&!b.isFigcaption();return!(!1!==a||!this.selection.isAll())||!(!a||b.isPre()||b.isCode()||c)},arrangeTag:function(a){var b=this.opts.replaceTags;for(var c in b)a===c&&(a=b[c]);return a},formatCollapsed:function(){var a,b,c,d,e=[],f=this.selection.getInlineFirst(),g=this.selection.getInlines({all:!0}),h=$R.dom(f);if(f){var i=this.inspector.parse(f);if(this.utils.isEmptyHtml(f.innerHTML))if(f.tagName.toLowerCase()===this.tag)if(this.hasSameArgs(f)){this.caret.setAfter(f),h.remove();var j=this.selection.getElement();this.utils.normalizeTextNodes(j)}else"span"===this.tag?(e=this.applyArgs([f],!1),this.caret.setStart(f)):e=this.insertInline(e);else i.hasParent([this.tag])?(a=h.closest(this.tag),b=a.get(),this.hasSameArgs(b)?(a.unwrap(),this.caret.setStart(f)):e=this.insertInline(e)):e=this.insertInline(e);else if(f.tagName.toLowerCase()===this.tag)this.hasSameArgs(f)?(d=this.utils.extractHtmlFromCaret(f),c=$R.dom("<"+this.tag+" />"),c=this.utils.cloneAttributes(f,c),h.after(c.append(d)),this.caret.setAfter(f)):e=this.insertInline(e);else if(i.hasParent([this.tag]))if(a=h.closest(this.tag),b=a.get(),this.hasSameArgs(b)){d=this.utils.extractHtmlFromCaret(b,b),c=$R.dom("<"+this.tag+" />"),c=this.utils.cloneAttributes(b,c);var k,l,m=0;g=g.reverse();for(var n=0;n<g.length;n++)g[n]!==b&&(l=$R.dom("<"+g[n].tagName.toLowerCase()+">"),0===m?k=l:k.append(l),m++);a.after(c.append(d)),a.after(k),this.caret.setStart(l)}else e=this.insertInline(e);else e=this.insertInline(e)}else e=this.insertInline(e);return e},insertInline:function(a){var b=document.createElement(this.tag);return a=this.insertion.insertNode(b,"start"),this.applyArgs(a,!1)},hasSameArgs:function(a){if(0===a.attributes.length&&!1===this.args)return!0;var b=!0;if(this.args){var c=0;for(var d in this.args){var e=$R.dom(a),f=this.args[d],g=this.utils.toParams(f),h=e.attr(d);if(f)if("style"===d){g=g.trim().replace(/;$/,"");for(var i=this.utils.styleToObj(e.attr("style")),j=g.split(";"),k=0,l=0;l<j.length;l++){var m=j[l].split(":"),n=m[0].trim(),o=m[1].trim();if(-1!==n.search(/color/)){var p=e.css(n);!p||p!==o&&this.utils.rgb2hex(p)!==o||k++}else e.css(n)===o&&k++}k===j.length&&Object.keys(i).length===j.length&&c++}else h===g&&c++;else h&&""!==h||c++}b=c===Object.keys(this.args).length}return b},formatUncollapsed:function(){var a=this.selection.getInlines({all:!0,inside:!0});this.detector.isIe()?this.selection.saveMarkers():this.selection.save(),this._convertTags("u"),this._convertTags("del"),this._convertToStrike(a),this.detector.isIe()?this.selection.restoreMarkers():this.selection.restore(),document.execCommand("strikethrough"),this._clearDecoration(),this.selection.save();var b=this._revertToInlines();b=this.applyArgs(b,!1);for(var c=0;c<b.length;c++){var d=b[c],e=d.tagName.toLowerCase(),f=d.attributes.length;e===this.tag&&0===f&&this.args&&($R.dom(d).unwrap(),b.splice(c,1))}return this.selection.restore(),this._clearEmptyStyle(),b=this._normalizeBlocks(b)},_convertTags:function(a){if(this.tag!==a){this.editor.getElement().find(a).each(function(b){this.utils.replaceToTag(b,"span").addClass("redactor-convertable-"+a)}.bind(this))}},_revertTags:function(a){this.editor.getElement().find("span.redactor-convertable-"+a).each(function(b){var c=this.utils.replaceToTag(b,a);c.removeClass("redactor-convertable-"+a),this.utils.removeEmptyAttr(c,"class")&&c.removeAttr("class")}.bind(this))},_convertToStrike:function(a){for(var b=this.selection.getText().replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),c=0;c<a.length;c++){var d=this.arrangeTag(a[c].tagName.toLowerCase()),e=a[c],f=$R.dom(e),g=this.hasSameArgs(e);d===this.tag&&("span"===this.tag&&this._isTextSelected(e,b)?f.addClass("redactor-convertable-apply"):g&&"a"!==this.tag?this._replaceToStrike(f):"span"===this.tag?f.addClass("redactor-unconvertable-apply"):g||f.addClass("redactor-convertable-apply"))}},_replaceToStrike:function(a){a.replaceWith(function(){return $R.dom("<strike>").append(a.contents())})},_revertToInlines:function(){var a=[],b=this.editor.getElement();return"u"!==this.tag&&b.find("u").unwrap(),b.find(".redactor-convertable-apply").each(function(b){var c=$R.dom(b);c.find("strike").unwrap(),this._forceRemoveClass(c,"redactor-convertable-apply"),a.push(b)}.bind(this)),b.find("span.redactor-unconvertable-apply").each(function(a){var b=$R.dom(a);this._forceRemoveClass(b,"redactor-unconvertable-apply")}.bind(this)),b.find("strike").each(function(b){var c=this.utils.replaceToTag(b,this.tag);a.push(c.get())}.bind(this)),this._revertTags("u"),this._revertTags("del"),a},_normalizeBlocks:function(a){var b=this.opts.inlineTags,c=this.selection.getBlocks();if(c)for(var d=0;d<c.length;d++)if("PRE"===c[d].tagName){var e=$R.dom(c[d]);e.find(b.join(",")).not(".redactor-selection-marker").each(function(b){-1!==a.indexOf(b)&&(a=this.utils.removeFromArrayByValue(a,b)),$R.dom(b).unwrap()}.bind(this))}return a},_clearDecoration:function(){this.editor.getElement().find(this.opts.inlineTags.join(",")).each(function(a){if("line-through"===a.style.textDecoration||"line-through"===a.style.textDecorationLine){var b=$R.dom(a);b.css("textDecorationLine",""),b.css("textDecoration",""),b.wrap("<strike>")}})},_clearEmptyStyle:function(){for(var a=this.getInlines(),b=0;b<a.length;b++){this._clearEmptyStyleAttr(a[b]);var c=a[b].childNodes;if(c)for(var d=0;d<c.length;d++)this._clearEmptyStyleAttr(c[d])}},_clearEmptyStyleAttr:function(a){3!==a.nodeType&&this.utils.removeEmptyAttr(a,"style")&&(a.removeAttribute("style"),a.removeAttribute("data-redactor-style-cache"))},_forceRemoveClass:function(a,b){a.removeClass(b),this.utils.removeEmptyAttr(a,"class")&&a.removeAttr("class")},
_isTextSelected:function(a,b){var c=this.utils.removeInvisibleChars(a.textContent);return b===c||-1!==b.search(new RegExp("^"+this.utils.escapeRegExp(c)+"$"))},getInlines:function(a){return a?this.selection.getInlines({tags:a,all:!0}):this.selection.getInlines({all:!0})},getElements:function(a){return $R.dom(this.getInlines(a))},clearFormat:function(){this.selection.save();for(var a=this.selection.getInlines({all:!0}),b=0;b<a.length;b++){var c=$R.dom(a[b]);this.selection.getInline(a[b])&&c.unwrap()}this.selection.restore()}}),$R.add("service","autoparser",{init:function(a){this.app=a},observe:function(){var a=this.editor.getElement(),b=a.find(".redactor-autoparser-object").each(function(a){var b=$R.dom(a);b.removeClass("redactor-autoparser-object"),""===b.attr("class")&&b.removeAttr("class")});b.length>0&&b.each(function(a){var b,c=!1,d=a.tagName;"A"===d?b="link":"IMG"===d?b="image":"IFRAME"===d&&(b="video"),b&&(c=$R.create(b+".component",this.app,a),this.app.broadcast(b+".inserted",c),this.app.broadcast("autoparse",b,c))}.bind(this))},format:function(a,b){this._isKey(b)&&this._format(b===this.keycodes.ENTER)},parse:function(a){var b=["figure","form","pre","iframe","code","a","img"],c=[],d=0;a=this.cleaner.encodePreCode(a);for(var e=0;e<b.length;e++){var f="img"===b[e]?"<"+b[e]+"[^>]*>":"<"+b[e]+"([\\w\\W]*?)</"+b[e]+">",g=a.match(new RegExp(f,"gi"));if(null!==g)for(var h=0;h<g.length;h++)a=a.replace(g[h],"#####replaceparse"+d+"#####"),c.push(g[h]),d++}if(this.opts.autoparseImages&&a.match(this.opts.regex.imageurl))for(var i=a.match(this.opts.regex.imageurl),e=0;e<i.length;e++)a=a.replace(i[e],'<img class="redactor-autoparser-object" src="'+i[e]+'">');if(this.opts.autoparseVideo&&(a.match(this.opts.regex.youtube)||a.match(this.opts.regex.vimeo))){var j,k;a.match(this.opts.regex.youtube)?(j="https://www.youtube.com/embed/$1$2",k=this.opts.regex.youtube):a.match(this.opts.regex.vimeo)&&(j="https://player.vimeo.com/video/$2",k=this.opts.regex.vimeo);var l=this.component.create("video",'<iframe width="500" height="281" src="'+j+'" frameborder="0" allowfullscreen></iframe>');a=a.replace(k,l.get().outerHTML).replace("?t=","?start=")}return this.opts.autoparseLinks&&a.match(this.opts.regex.url)&&(a=this._formatLinks(a)),a=this._restoreReplaced(c,a),a=this._restoreReplaced(c,a)},_isKey:function(a){return a===this.keycodes.ENTER||a===this.keycodes.SPACE},_format:function(a){var b=this.selection.getParent(),c=$R.dom(b);if((!b||0===c.closest("figure, pre, code, img, a, iframe").length)&&this.selection.isCollapsed()){var d=this.utils.createInvisibleChar();this.selection.getRange().insertNode(d);var e=this.selection.getCurrent(),f=this.inspector.parse(e),g=$R.dom(e);if(d.parentNode.removeChild(d),e&&3===e.nodeType){var h,i=e.textContent;if(this.opts.autoparseImages&&i.match(this._convertToRegExp(this.opts.regex.imageurl))){var j=f.isList(),k=i.match(this.opts.regex.imageurl),l=j?void 0:"<figure><img></figure>",m=this.component.create("image",l);m.setSrc(k[0]),m.addClass("redactor-autoparser-object"),i=i.replace(k[0],m.get().outerHTML),h="image"}else if(this.opts.autoparseVideo&&(i.match(this._convertToRegExp(this.opts.regex.youtube))||i.match(this._convertToRegExp(this.opts.regex.vimeo)))){var n,o;i.match(this.opts.regex.youtube)?(n="https://www.youtube.com/embed/$1$2",o=this.opts.regex.youtube):i.match(this.opts.regex.vimeo)&&(n="https://player.vimeo.com/video/$2",o=this.opts.regex.vimeo);var p=this.component.create("video",'<iframe width="500" height="281" src="'+n+'" frameborder="0" allowfullscreen></iframe>');p.addClass("redactor-autoparser-object"),i=i.replace(o,p.get().outerHTML),h="video"}else this.opts.autoparseLinks&&i.match(this._convertToRegExp(this.opts.regex.url))&&(i=this._formatLinks(i,a),h="link");if(h){a?(this.selection.save(),g.replaceWith(i),this.selection.restore()):g.replaceWith(i);var q=this.editor.getElement(),r=q.find(".redactor-autoparser-object").removeClass("redactor-autoparser-object");if(r="link"===h?$R.create("link.component",this.app,r):r,"link"===h)a||this.caret.setAfter(r),this.app.broadcast("link.inserted",r);else{this.caret.setAfter(r);var s=r.clone();r.remove(),r=this.insertion.insertHtml(s),r=this.component.build(r)}this.app.broadcast("autoparse",h,r)}}}},_formatLinks:function(a,b){for(var c=a.match(this.opts.regex.url),d={},e=0;e<c.length;e++){b&&-1!==c[e].search(/\.$/)&&(c[e]=c[e].replace(/\.$/,""));var f=c[e],g=f,h=null!==f.match(/(https?|ftp):\/\//i)?"":"http://",i=-1!==["/","&","="].indexOf(f.slice(-1))?"":"\\b",j=!1!==this.opts.pasteLinkTarget?' target="'+this.opts.pasteLinkTarget+'"':"";g=g.length>this.opts.linkSize?g.substring(0,this.opts.linkSize)+"...":g,g=-1===g.search("%")?decodeURIComponent(g):g;d["("+f.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+i+")"]='<a href="'+h+f.trim()+'"'+j+' class="redactor-autoparser-object">'+g.trim()+"</a>"}for(var k in d)a=a.replace(new RegExp(k,"g"),d[k]);return a},_restoreReplaced:function(a,b){for(var c=0;c<a.length;c++)b=b.replace("#####replaceparse"+c+"#####",a[c]);return b},_convertToRegExp:function(a){return new RegExp(String(a).replace(/^\//,"").replace(/\/ig$/,"").replace(/\/gi$/,"")+"$","gi")}}),$R.add("service","storage",{init:function(a){this.app=a,this.data=[]},observeImages:function(){this.editor.getElement().find("[data-image]").each(this._addImage.bind(this))},observeFiles:function(){this.editor.getElement().find("[data-file]").each(this._addFile.bind(this))},setStatus:function(a,b){this.data[a].status=b},getChanges:function(){var a=this.editor.getElement();for(var b in this.data){var c=this.data[b],d=a.find("[data-"+c.type+'="'+c.id+'"]');this.setStatus(c.id,0!==d.length)}return this.data},add:function(a,b){var c=$R.dom(b),d=c.attr("data-"+a);this.data[d]={type:a,status:!0,node:c.get(),id:c.attr("data-"+a)}},_addImage:function(a){this.add("image",a)},_addFile:function(a){this.add("file",a)}}),$R.add("service","utils",{init:function(a){this.app=a},isEmpty:function(a){var b=!1;return a=$R.dom(a).get(),a&&(b=3===a.nodeType?""===a.textContent.trim().replace(/\n/,""):""===a.innerHTML),b},isEmptyHtml:function(a,b,c){return a=this.removeInvisibleChars(a),a=a.replace(/&nbsp;/gi,""),a=a.replace(/<\/?br\s?\/?>/g,b?"br":""),a=a.replace(/\s/g,""),a=a.replace(/^<p>[^\W\w\D\d]*?<\/p>$/i,""),a=a.replace(/^<div>[^\W\w\D\d]*?<\/div>$/i,""),c&&(a=a.replace(/<ul(.*?[^>])>$/i,"ul"),a=a.replace(/<ol(.*?[^>])>$/i,"ol")),a=a.replace(/<hr(.*?[^>])>$/i,"hr"),a=a.replace(/<iframe(.*?[^>])>$/i,"iframe"),a=a.replace(/<source(.*?[^>])>$/i,"source"),a=a.replace(/<[^\/>][^>]*><\/[^>]+>/gi,""),a=a.replace(/<[^\/>][^>]*><\/[^>]+>/gi,""),""===(a=a.trim())},trimSpaces:function(a){return a=this.removeInvisibleChars(a.trim())},createInvisibleChar:function(){return document.createTextNode(this.opts.markerChar)},searchInvisibleChars:function(a){return a.search(/^\uFEFF$/g)},removeInvisibleChars:function(a){return a.replace(/\uFEFF/g,"")},trimInvisibleChars:function(a){if(this.selection.isCollapsed()){var b=this.selection.getCurrent(),c="left"===a?this.selection.getTextBeforeCaret():this.selection.getTextAfterCaret();if(b&&3===b.nodeType&&0===this.searchInvisibleChars(c))if("left"===a)$R.dom(b).replaceWith(b.textContent.trim());else{var d=this.offset.get();this.offset.set({start:d.start+1,end:d.end+1})}}},buildWrapper:function(a){return $R.dom("<div>").html(a)},getWrapperHtml:function(a){var b=a.html();return a.remove(),b},createTmpContainer:function(a){var b=$R.dom("<div>");return"string"==typeof a?b.html(a):b.append($R.dom(a).clone(!0)),b.get()},createFragment:function(a){for(var b,c,d,e=this.createTmpContainer(a),f=document.createDocumentFragment(),g=[],h=0;b=e.firstChild;){h++;var i=f.appendChild(b);1===h&&(c=i),g.push(i),d=i}return{frag:f,first:c,last:d,nodes:g}},isFragment:function(a){return"object"==typeof a&&a.frag},parseHtml:function(a){var b=this.createTmpContainer(a);return{html:b.innerHTML,nodes:b.childNodes}},splitNode:function(a,b,c,d){b=this.isFragment(b)?b.frag:b;var e;e=d?this.inspector.isInlineTag(a.tagName)?a:this.selection.getInline(a):this.inspector.isBlockTag(a.tagName)?a:this.selection.getBlock(a);var f=$R.dom(e);if(!d&&this.isEmptyHtml(e.innerHTML,!0))return f.after(b),f.remove(),b;var g=f.get().tagName.toLowerCase(),h=this.caret.isEnd(e),i=this.caret.isStart(e);if(!h&&!i){var j=this.extractHtmlFromCaret(d),k=$R.dom("<"+g+" />");k=this.cloneAttributes(e,k),f.after(k.append(j))}if(i)return f.before(b);if(c)return f.append(b);b=f.after(b);var l=f.html();return l=this.removeInvisibleChars(l),l=l.replace(/&nbsp;/gi,""),""===l&&f.remove(),b},extractHtmlFromCaret:function(a,b){var c=this.selection.getRange();if(c&&(b=b||(a?this.selection.getInline():this.selection.getBlock()))){var d=c.cloneRange();return d.selectNodeContents(b),d.setStart(c.endContainer,c.endOffset),d.extractContents()}},createMarkup:function(a){var b=document.createElement(this.opts.markup);this.opts.breakline&&b.setAttribute("data-redactor-tag","br"),$R.dom(a).after(b),this.caret.setStart(b)},createMarkupBefore:function(a){var b=document.createElement(this.opts.markup);this.opts.breakline&&b.setAttribute("data-redactor-tag","br"),$R.dom(a).before(b),this.caret.setEnd(b)},getNode:function(a){var b=$R.dom(a).get(),c=this.editor.getElement().get();return void 0===a?c:b||!1},findSiblings:function(a,b){for(a=$R.dom(a).get(),b="next"===b?"nextSibling":"previousSibling";a=a[b];)if((3!==a.nodeType||""!==a.textContent.trim())&&"BR"!==a.tagName)return a;return!1},getElementsFromHtml:function(a,b,c){var d=document.createElement("div");d.innerHTML=a;var e=d.querySelectorAll(b);return function(a,b){if("number"==typeof this.length&&"function"==typeof a){var c=[];if("object"==typeof this)for(var d=0;d<this.length;d++){if(!(d in this))return;c[d]=a.call(b||this,this[d],d,this)}return c}}.call(e,function(a){var b=a.getAttribute("data-redactor-type");if(!c||!b||b!==c)return a.outerHTML})},getChildNodes:function(a,b,c){a=a&&a.nodeType&&11===a.nodeType?a:$R.dom(a).get();var d=a.childNodes,e=[];if(d)for(var f=0;f<d.length;f++)if(!(!0===c&&3===d[f].nodeType||3===d[f].nodeType&&this.isEmpty(d[f])||(e.push(d[f]),!1===b))){var g=this.getChildNodes(d[f],c);g.length>0&&(e=e.concat(g))}return e},getChildElements:function(a){return this.getChildNodes(a,!0,!0)},getFirstNode:function(a){return this._getFirst(this.getChildNodes(a,!1))},getLastNode:function(a){return this._getLast(this.getChildNodes(a,!1))},getFirstElement:function(a){return this._getFirst(this.getChildNodes(a,!1,!0))},getLastElement:function(a){return this._getLast(this.getChildNodes(a,!1,!0))},replaceToTag:function(a,b){return $R.dom(a).replaceWith(function(a){var c=$R.dom("<"+b+">").append($R.dom(a).contents());if(a.attributes)for(var d=a.attributes,e=0;e<d.length;e++)c.attr(d[e].nodeName,d[e].value);return c})},ucfirst:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},removeFromArrayByValue:function(a,b){for(var c,d=arguments,e=d.length;e>1&&a.length;)for(b=d[--e];-1!==(c=a.indexOf(b));)a.splice(c,1);return a},removeEmptyAttr:function(a,b){var c=$R.dom(a);return void 0===c.attr(b)||null===c.attr(b)||""===c.attr(b)&&(c.removeAttr(b),!0)},cloneAttributes:function(a,b){a=$R.dom(a).get(),b=$R.dom(b);for(var c=a.attributes,d=c.length;d--;){var e=c[d];b.attr(e.name,e.value)}return b},toParams:function(a){if("object"!=typeof a)return a;var b=Object.keys(a);if(!b.length)return"";for(var c="",d=0;d<b.length;d++){var e=b[d];c+=e+":"+a[e]+";"}return c},styleToObj:function(a){var b={};if(a)for(var c=a.replace(/;$/,"").split(";"),d=0;d<c.length;d++){var e=c[d].split(":");b[e[0].trim()]=e[1].trim()}return b},checkProperty:function(a){for(var b=arguments[1]&&Array.isArray(arguments[1])?arguments[1]:[].slice.call(arguments,1),c=0;c<b.length;c++){if(!a||void 0===a[b[c]])return!1;a=a[b[c]]}return a},extendData:function(a,b){for(var c in b)if("elements"===c){var d=$R.dom(b[c]);d.each(function(b){var c=$R.dom(b);if("FORM"===b.tagName){var d=c.serialize(!0);for(var e in d)a=this._setData(a,e,d[e])}else{var f=c.attr("name")?c.attr("name"):c.attr("id");a=this._setData(a,f,c.val())}}.bind(this))}else a=this._setData(a,c,b[c]);return a},_setData:function(a,b,c){return a instanceof FormData?a.append(b,c):a[b]=c,a},normalizeTextNodes:function(a){(a=$R.dom(a).get())&&a.normalize()},isRgb:function(a){return 0===a.search(/^rgb/i)},rgb2hex:function(a){return a=a.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i),a&&4===a.length?"#"+("0"+parseInt(a[1],10).toString(16)).slice(-2)+("0"+parseInt(a[2],10).toString(16)).slice(-2)+("0"+parseInt(a[3],10).toString(16)).slice(-2):""},hex2long:function(a){return-1!==a.search(/^#/)&&4===a.length&&(a="#"+a[1]+a[1]+a[2]+a[2]+a[3]+a[3]),a},escapeRegExp:function(a){return a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},getRandomId:function(){for(var a="",b="abcdefghijklmnopqrstuvwxyz0123456789",c=0;c<12;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a},_getFirst:function(a){return 0!==a.length&&a[0]},_getLast:function(a){return 0!==a.length&&a[a.length-1]}}),$R.add("service","progress",{init:function(a){this.app=a,this.$box=null,this.$bar=null},show:function(){this._is()||this._build(),this.$box.show()},hide:function(){this._is()&&this.animate.start(this.$box,"fadeOut",this._destroy.bind(this))},update:function(a){this.show(),this.$bar.css("width",a+"%")},_is:function(){return null!==this.$box},_build:function(){this.$bar=$R.dom("<span />"),this.$box=$R.dom('<div id="redactor-progress" />'),this.$box.append(this.$bar),this.$body.append(this.$box)},_destroy:function(){this._is()&&this.$box.remove(),this.$box=null,this.$bar=null}}),$R.add("module","starter",{init:function(a){this.app=a,this.opts=a.opts,this.plugin=a.plugin,this.module=a.module},onstart:function(){var a=["element","container","source","editor","statusbar","toolbar"],b=["element","container","source","editor","statusbar","contextbar","input"];this._startStop("start",this.app,a),this._startStop("start",this.module,b)},onstop:function(){var a=["observer","element","container","source","editor","contextbar"];this._startStop("stop",this.module,a)},onenable:function(){var a=["observer","toolbar"],b=this.opts.plugins;this._startStop("start",this.module,a),this._startStop("start",this.plugin,b)},ondisable:function(){var a=["observer","toolbar"],b=this.opts.plugins;this._startStop("stop",this.module,a),this._startStop("stop",this.plugin,b)},_startStop:function(a,b,c){for(var d=0;d<c.length;d++)void 0!==b[c[d]]&&this.app.callInstanceMethod(b[c[d]],a)}}),$R.add("module","element",{init:function(a){this.app=a,this.uuid=a.uuid,this.opts=a.opts,this.namespace=a.namespace,this.element=a.element,this.rootOpts=$R.extend({},!0,$R.options,a.rootOpts)},start:function(){this._build(),this._buildModes(),this._buildMarkup()},stop:function(){this.element.getElement().removeData(this.namespace+"-uuid")},_build:function(){this.element.getElement().data(this.namespace+"-uuid",this.uuid)},_buildModes:function(){var a=this.element.getType();"inline"===a&&this._redefineOptions(this.opts.modes.inline),"div"===a&&this._redefineOptions(this.opts.modes.original),"inline"!==a&&(this._isRootOption("styles")&&this.rootOpts.styles&&(this.opts.styles=!0),this._isRootOption("source")&&!this.rootOpts.source&&(this.opts.showSource=!1))},_buildMarkup:function(){"inline"===this.element.getType()?this.opts.emptyHtml="":this.opts.breakline?(this.opts.markup="div",this.opts.emptyHtml='<div data-redactor-tag="br">'+this.opts.markerChar+"</div>"):this.opts.emptyHtml="<"+this.opts.markup+"></"+this.opts.markup+">"},_redefineOptions:function(a){for(var b in a)this.opts[b]=a[b]},_isRootOption:function(){return void 0!==this.rootOpts.styles}}),$R.add("module","editor",{init:function(a){this.app=a,this.uuid=a.uuid,this.opts=a.opts,this.editor=a.editor,this.source=a.source,this.element=a.element,this.component=a.component,this.container=a.container,this.inspector=a.inspector,this.autoparser=a.autoparser,this.placeholder=!1,this.events=!1},onenable:function(){this.enable()},ondisable:function(){this.disable()},onenablefocus:function(){this._enableFocus()},oncontextmenu:function(a){this.component.setOnEvent(a,!0)},onclick:function(a){this.component.setOnEvent(a)},onkeyup:function(a){this.inspector.parse(a.target).isComponent()||this.component.clearActive()},onenablereadonly:function(){this._enableReadOnly()},ondisablereadonly:function(){this._disableReadOnly()},onautoparseobserve:function(){this.autoparser.observe()},onplaceholder:{build:function(){this._buildPlaceholder()},toggle:function(){this._togglePlacehodler()}},start:function(){this._build(),this._buildEvents(),this._buildOptions(),this._buildAccesibility()},stop:function(){var a=this.editor.getElement(),b=this.container.getElement(),c=["redactor-in","redactor-in-"+this.uuid,"redactor-structure","redactor-placeholder","notranslate",this.opts.stylesClass],d=["redactor-focus","redactor-blur","redactor-over","redactor-styles-on","redactor-styles-off","redactor-toolbar-on","redactor-text-labeled-on","redactor-source-view"];a.removeAttr("spellcheck"),a.removeAttr("dir"),a.removeAttr("contenteditable"),a.removeAttr("placeholder"),a.removeAttr("data-gramm_editor"),a.removeClass(c.join(" ")),b.removeClass(d.join(" ")),this._destroyEvents(),0===a.get().classList.length&&a.removeAttr("class")},enable:function(){var a=this.editor.getElement(),b=this.container.getElement();a.addClass("redactor-in redactor-in-"+this.uuid),a.attr({contenteditable:!0}),this.opts.structure&&a.addClass("redactor-structure"),!this.opts.toolbar||this.opts.air||this.opts.toolbarExternal||b.addClass("redactor-toolbar-on"),this._disableBrowsersEditing()},disable:function(){var a=this.editor.getElement(),b=this.container.getElement();a.removeClass("redactor-in redactor-in-"+this.uuid),a.removeClass("redactor-structure"),a.removeAttr("contenteditable"),b.addClass("redactor-toolbar-on")},_build:function(){var a=this.editor.getElement(),b=this.element.getElement(),c=this.container.getElement();c.addClass("redactor-blur"),this.opts.grammarly||a.attr("data-gramm_editor",!1),this.opts.notranslate&&a.addClass("notranslate"),this.opts.styles?(a.addClass(this.opts.stylesClass),c.addClass("redactor-styles-on")):c.addClass("redactor-styles-off"),this.opts.buttonsTextLabeled&&c.addClass("redactor-text-labeled-on"),this.element.isType("textarea")&&b.before(a)},_buildEvents:function(){this.events=$R.create("editor.events",this.app)},_buildOptions:function(){var a=this.editor.getElement();a.attr("dir",this.opts.direction),this.opts.tabindex&&a.attr("tabindex",this.opts.tabindex),this.opts.minHeight&&a.css("min-height",this.opts.minHeight),this.opts.maxHeight&&a.css("max-height",this.opts.maxHeight),this.opts.maxWidth&&a.css({"max-width":this.opts.maxWidth,margin:"auto"})},_buildAccesibility:function(){this.editor.getElement().attr({"aria-labelledby":"redactor-voice-"+this.uuid,role:"presentation"})},_buildPlaceholder:function(){this.placeholder=$R.create("editor.placeholder",this.app)},_enableFocus:function(){this.opts.showSource?this._enableFocusSource():this._enableFocusEditor()},_enableFocusSource:function(){var a=this.source.getElement();this.opts.focus?(a.focus(),a.get().setSelectionRange(0,0)):this.opts.focusEnd&&a.focus()},_enableFocusEditor:function(){this.opts.focus?setTimeout(this.editor.startFocus.bind(this.editor),100):this.opts.focusEnd&&setTimeout(this.editor.endFocus.bind(this.editor),100)},_togglePlacehodler:function(){this.placeholder&&this.placeholder.toggle()},_disableBrowsersEditing:function(){try{document.execCommand("enableObjectResizing",!1,!1),document.execCommand("enableInlineTableEditing",!1,!1),document.execCommand("AutoUrlDetect",!1,!1);var a=this.editor.getElement(),b=a.get();b.addEventListener?b.addEventListener("mscontrolselect",function(a){a.preventDefault()}):b.attachEvent("oncontrolselect",function(a){a.returnValue=!1})}catch(a){}},_destroyEvents:function(){this.events&&this.events.destroy()},_enableReadOnly:function(){var a=this.editor.getElement();this._getEditables(a).removeAttr("contenteditable"),a.removeAttr("contenteditable"),a.addClass("redactor-read-only"),this.events&&this.events.destroy()},_disableReadOnly:function(){var a=this.editor.getElement();this._getEditables(a).attr({contenteditable:!0}),a.removeClass("redactor-read-only"),a.attr({contenteditable:!0}),this._buildEvents()},_getEditables:function(a){return a.find("figcaption, td, th")}}),$R.add("class","editor.placeholder",{init:function(a){this.app=a,this.opts=a.opts,this.editor=a.editor,this.element=a.element,this.build()},build:function(){var a=this.element.getElement(),b=this.editor.getElement();if(!1!==this.opts.placeholder||a.attr("placeholder")){var c=!1!==this.opts.placeholder?this.opts.placeholder:a.attr("placeholder");b.attr("placeholder",c),this.toggle()}},toggle:function(){return this.editor.isEmpty(!0)?this.show():this.hide()},show:function(){this.editor.getElement().addClass("redactor-placeholder")},hide:function(){this.editor.getElement().removeClass("redactor-placeholder")}}),$R.add("class","editor.events",{init:function(a){this.app=a,this.opts=a.opts,this.$doc=a.$doc,this.uuid=a.uuid,this.source=a.source,this.editor=a.editor,this.cleaner=a.cleaner,this.container=a.container,this.insertion=a.insertion,this.inspector=a.inspector,this.selection=a.selection,this.component=a.component,this.blurNamespace=".redactor-blur."+this.uuid,this.eventsList=["paste","click","contextmenu","keydown","keyup","mouseup","touchstart","cut","copy","dragenter","dragstart","drop","dragover","dragleave"],this._init()},destroy:function(){this.editor.getElement().off(".redactor-focus"),this.$doc.off("keyup"+this.blurNamespace+" mousedown"+this.blurNamespace),this._loop("off")},focus:function(a){var b=this.container.getElement();this.editor.isPasting()||b.hasClass("redactor-focus")||(b.addClass("redactor-focus"),b.removeClass("redactor-blur"),this.app.broadcast("observe",a),this.app.broadcast("focus",a),this.isFocused=!0,this.isBlured=!1)},blur:function(a){var b=this.container.getElement(),c=$R.dom(a.target),d=[".redactor-in-"+this.uuid,".redactor-toolbar",".redactor-dropdown",".redactor-context-toolbar","#redactor-modal","#redactor-image-resizer"];this.app.broadcast("originalblur",a),this.app.stopBlur||this.app.isStarted()&&!this.editor.isPasting()&&0===c.closest(d.join(",")).length&&(this.isBlured||b.hasClass("redactor-blur")||(b.removeClass("redactor-focus"),b.addClass("redactor-blur"),this.app.broadcast("blur",a),this.isFocused=!1,this.isBlured=!0))},cut:function(a){var b=this.selection.getCurrent(),c=this.inspector.parse(b);this.app.broadcast("state",a),this.component.isNonEditable(b)&&(this._passSelectionToClipboard(a,c,!0),a.preventDefault())},copy:function(a){var b=this.selection.getCurrent(),c=this.inspector.parse(b);this.app.broadcast("state",a),this.component.isNonEditable(b)&&(this._passSelectionToClipboard(a,c,!1),a.preventDefault())},drop:function(a){if(a=a.originalEvent||a,a.stopPropagation(),this._removeOverClass(),!1===this.opts.dragUpload)return void a.preventDefault();if(this.app.isDragComponentInside()){var b=$R.dom(this.app.getDragComponentInside()),c=b.clone(!0);return this.insertion.insertToPoint(a,c),b.remove(),this.app.setDragComponentInside(!1),this.app.broadcast("state",a),this.app.broadcast("drop",a),this.app.broadcast("image.observe",a),void a.preventDefault()}if(this.app.isDragInside()&&this.opts.input){this.insertion.insertPoint(a);var d=a.dataTransfer,e=d.getData("text/html"),f=this.selection.getRange();if(f){var g=this.selection.getBlocks();f.deleteContents();for(var h=0;h<g.length;h++)""===g[h].innerHTML&&$R.dom(g[h]).remove()}return $R.create("input.paste",this.app,a,!0,e,!0),this.app.broadcast("state",a),this.app.broadcast("drop",a),this.app.setDragInside(!1),void a.preventDefault()}this.app.broadcast("state",a),this.app.broadcast("paste",a,a.dataTransfer),this.app.broadcast("drop",a)},dragenter:function(a){a.preventDefault()},dragstart:function(a){this.app.setDragComponentInside(!1),this.app.setDragInside(!1);var b=this.inspector.parse(a.target);!b.isComponent()||b.isComponentEditable()||b.isFigcaption()?this.selection.is()&&!this.selection.isCollapsed()&&(this.app.setDragInside(!0),this._setDragData(a)):this.app.setDragComponentInside(b.getComponent()),this.app.broadcast("dragstart",a)},dragover:function(a){this.app.broadcast("dragover",a)},dragleave:function(a){this.app.broadcast("dragleave",a)},paste:function(a){this.app.broadcast("paste",a)},contextmenu:function(a){this.editor.disableNonEditables(),setTimeout(function(){this.editor.enableNonEditables(),this.app.broadcast("contextmenu",a)}.bind(this),0)},click:function(a){if(3===a.detail){a.preventDefault();var b=this.selection.getBlock(),c=document.createRange();c.selectNodeContents(b),this.selection.setRange(c)}var d=$R.dom(a.target);if(d.hasClass("redactor-in")){var e=d.offset().top,f=parseFloat(d.css("padding-bottom"));e+d.height()-2*f<a.pageY&&this.app.broadcast("bottomclick",a)}this.app.broadcast("state",a),this.app.broadcast("click",a)},keydown:function(a){if(this.app.broadcast("state",a),!1===this.app.broadcast("keydown",a))return a.preventDefault()},keyup:function(a){this.app.broadcast("keyup",a)},mouseup:function(a){this.app.broadcast("observe",a),this.app.broadcast("state",a)},touchstart:function(a){this.app.broadcast("observe",a),this.app.broadcast("state",a)},_init:function(){this.editor.getElement().on("focus.redactor-focus click.redactor-focus",this.focus.bind(this)),this.$doc.on("keyup"+this.blurNamespace+" mousedown"+this.blurNamespace,this.blur.bind(this)),this._loop("on")},_removeOverClass:function(){this.editor.getElement().removeClass("over")},_loop:function(a){for(var b=this.editor.getElement(),c=0;c<this.eventsList.length;c++){var d=this.eventsList[c]+".redactor-events",e=this.eventsList[c];b[a](d,this[e].bind(this))}},_passAllToClipboard:function(a){var b=a.clipboardData,c=this.source.getCode();b.setData("text/html",c),b.setData("text/plain",c.toString().replace(/\n$/,""))},_passSelectionToClipboard:function(a,b,c){var d=a.clipboardData,e=b.getComponent(),f=$R.dom(e),g=f.clone();g.find(".redactor-component-caret").remove(),g.removeClass("redactor-component-active"),g.removeAttr("contenteditable"),g.removeAttr("tabindex");var h=g.get().outerHTML;c&&this.component.remove(e),d.setData("text/html",h),d.setData("text/plain",h.toString().replace(/\n$/,""))},_setDragData:function(a){a=a.originalEvent||a;var b=a.dataTransfer;b.effectAllowed="move",b.setData("text/Html",this.selection.getHtml())}}),$R.add("module","container",{init:function(a){this.app=a,this.uuid=a.uuid,this.opts=a.opts,this.lang=a.lang,this.element=a.element,this.container=a.container},start:function(){this._build(),this._buildAccesibility()},stop:function(){var a=this.element.getElement(),b=this.container.getElement();b.after(a),b.remove(),a.show()},_build:function(){var a=this.element.getElement(),b=this.container.getElement();b.addClass("redactor-box"),b.attr("dir",this.opts.direction),this.element.isType("inline")&&b.addClass("redactor-inline"),a.after(b),b.append(a)},_buildAccesibility:function(){var a=this.container.getElement(),b=$R.dom("<span />");b.addClass("redactor-voice-label"),b.attr({id:"redactor-voice-"+this.uuid,"aria-hidden":!1}),b.html(this.lang.get("accessibility-help-label")),a.prepend(b)}}),$R.add("module","source",{init:function(a){this.app=a,this.uuid=a.uuid,this.opts=a.opts,this.utils=a.utils,this.element=a.element,this.source=a.source,this.editor=a.editor,this.toolbar=a.toolbar,this.cleaner=a.cleaner,this.component=a.component,this.container=a.container,this.autoparser=a.autoparser,this.selection=a.selection,this.syncedHtml=""},onstartcode:function(){var a=this.source.getStartedContent(),b=this.editor.getElement(),c=this.source.getElement();this.opts.autoparse&&this.opts.autoparseStart&&(a=this.autoparser.parse(a));var d=this.cleaner.input(a,!0,!0),e=this.cleaner.output(d);b.html(d),c.val(e),this.syncedHtml=e,this.app.broadcast("placeholder.build"),this.app.broadcast("autoparseobserve"),this.component.executeScripts()},onstartcodeshow:function(){this.show()},ontrytosync:function(){this.sync()},onhardsync:function(){var a=this.editor.getElement(),b=a.html();b=this.app.broadcast("syncBefore",b),b=this.cleaner.output(b),this._syncing(b)},start:function(){this._build(),this._buildClasses()},stop:function(){var a=this.element.getElement(),b=this.source.getElement();a.removeClass("redactor-source redactor-source-open"),b.off("input.redactor-source"),b.removeAttr("data-gramm_editor"),0===b.get().classList.length&&b.removeAttr("class"),this.source.isNameGenerated()||a.removeAttr("name"),this.element.isType("textarea")||b.remove()},getCode:function(){return this.source.getCode()},toggle:function(){if(this.opts.source){return this.source.getElement().hasClass("redactor-source-open")?this.hide():this.show()}},show:function(){if(this.opts.source){var a=this.editor.getElement(),b=this.source.getElement(),c=this.container.getElement(),d=b.val();this.app.isStarted()&&(d=this.app.broadcast("source.open",d));var e=$R.create("source.selection",this.app),f=e.insertMarkersToEditor();f=this.cleaner.output(f,!1),f=f.trim();var g=a.height();a.hide(),b.height(g),b.val(d.trim()),b.show(),b.addClass("redactor-source-open"),b.on("input.redactor-source-events",this._onChangedSource.bind(this)),b.on("keydown.redactor-source-events",this._onTabKey.bind(this)),b.on("focus.redactor-source-events",this._onFocus.bind(this)),c.addClass("redactor-source-view"),e.setSelectionOffsetSource(f),setTimeout(function(){this._disableButtons(),this._setActiveSourceButton()}.bind(this),100),this.app.isStarted()&&this.app.broadcast("source.opened")}},hide:function(){if(this.opts.source){var a=this.editor.getElement(),b=this.source.getElement(),c=this.container.getElement(),d=b.val(),e=$R.create("source.selection",this.app);d=e.insertMarkersToSource(d),d=this.cleaner.input(d,!0),d=this.utils.isEmptyHtml(d)?this.opts.emptyHtml:d,d=this.app.broadcast("source.close",d),this._enableButtons(),this._setInactiveSourceButton(),b.hide(),b.removeClass("redactor-source-open"),b.off(".redactor-source-events"),a.show(),a.html(d),c.removeClass("redactor-source-view"),setTimeout(function(){e.isOffset()?this.selection.restoreMarkers():e.isOffsetEnd()?this.editor.endFocus():this.editor.startFocus(),this.component.executeScripts()}.bind(this),0),this.app.broadcast("source.closed")}},sync:function(){var a=this,b=this.editor.getElement(),c=b.html();c=this.app.broadcast("syncBefore",c),c=this.cleaner.output(c),this._isSync(c)&&(this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(function(){a._syncing(c)},200))},_build:function(){var a=this.source.getElement(),b=this.element.getElement();a.hide(),this.opts.grammarly||a.attr("data-gramm_editor",!1),this.element.isType("textarea")||b.after(a)},_buildClasses:function(){this.source.getElement().addClass("redactor-source")},_syncing:function(a){a=this.app.broadcast("syncing",a),this.source.getElement().val(a),this.app.broadcast("synced",a),this.app.broadcast("changed",a)},_isSync:function(a){return this.syncedHtml!==a&&(this.syncedHtml=a,!0)},_onChangedSource:function(){var a=this.source.getElement(),b=a.val();this.app.broadcast("changed",b),this.app.broadcast("source.changed",b)},_onTabKey:function(a){if(9!==a.keyCode)return!0;a.preventDefault();var b=this.source.getElement(),c=b.get(),d=c.selectionStart;b.val(b.val().substring(0,d)+"    "+b.val().substring(c.selectionEnd)),c.selectionStart=c.selectionEnd=d+4},_onFocus:function(){this.app.broadcast("sourcefocus")},_disableButtons:function(){this.toolbar.disableButtons()},_enableButtons:function(){this.toolbar.enableButtons()},_setActiveSourceButton:function(){var a=this.toolbar.getButton("html");a.enable(),a.setActive()},_setInactiveSourceButton:function(){this.toolbar.getButton("html").setInactive()}}),$R.add("class","source.selection",{init:function(a){this.app=a,this.utils=a.utils,this.source=a.source,
this.editor=a.editor,this.marker=a.marker,this.component=a.component,this.selection=a.selection,this.markersOffset=!1,this.markersOffsetEnd=!1},insertMarkersToEditor:function(){var a=this.editor.getElement(),b=this.marker.build("start"),c=this.marker.build("end"),d=this.component.getActive();if(d){this.marker.remove();var e=$R.dom(d);e.after(c),e.after(b)}else window.getSelection&&this.selection.is()&&this.marker.insert("both");return this._getHtmlAndRemoveMarkers(a)},setSelectionOffsetSource:function(a){var b=0,c=0,d=this.source.getElement();if(""!==a){var e=this.utils.removeInvisibleChars(this.marker.buildHtml("start")),f=this.utils.removeInvisibleChars(this.marker.buildHtml("end"));b=this._strpos(a,e),c=this._strpos(a,f)-f.toString().length-2,!1===b&&(b=0,c=0)}d.get().setSelectionRange(b,c),d.get().scrollTop=0,setTimeout(function(){d.focus()}.bind(this),0)},isOffset:function(){return this.markersOffset},isOffsetEnd:function(){return this.markersOffsetEnd},insertMarkersToSource:function(a){var b=this.source.getElement(),c=this.marker.buildHtml("start"),d=this.marker.buildHtml("end"),e=c.toString().length,f=this._enlargeOffset(a,b.get().selectionStart),g=this._enlargeOffset(a,b.get().selectionEnd);return f===a.length?this.markersOffsetEnd=!0:0!==f&&0!==g?(this.markersOffset=!0,a=a.substr(0,f)+c+a.substr(f),a=a.substr(0,g+e)+d+a.substr(g+e)):this.markersOffset=!1,a},_getHtmlAndRemoveMarkers:function(a){var b=a.html();return a.find(".redactor-selection-marker").remove(),b},_strpos:function(a,b,c){var d=a.indexOf(b,c);return d>=0&&d},_enlargeOffset:function(a,b){var c=a.length,d=0;if(">"===a[b])d++;else for(var e=b;e<=c&&(d++,">"!==a[e]);e++)if("<"===a[e]||e===c){d=0;break}return b+d}}),$R.add("module","observer",{init:function(a){this.app=a,this.editor=a.editor,this.observerUnit=!1},start:function(){if(window.MutationObserver){var a=this.editor.getElement(),b=a.get();this.observerUnit=this._build(b),this.observerUnit.observe(b,{attributes:!0,subtree:!0,childList:!0,characterData:!0,characterDataOldValue:!0})}},stop:function(){this.observerUnit&&this.observerUnit.disconnect()},_build:function(a){var b=this;return new MutationObserver(function(c){b._observe(c[c.length-1],a)})},_observe:function(a,b){this.app.isReadOnly()||"attributes"===a.type&&a.target===b||(this.app.broadcast("observe"),this.app.broadcast("trytosync"),this.app.broadcast("placeholder.toggle"))}}),$R.add("module","clicktoedit",{init:function(a){this.app=a,this.opts=a.opts,this.source=a.source,this.editor=a.editor,this.container=a.container,this.selection=a.selection},onstartclicktoedit:function(){this.start()},onenablereadonly:function(){this._isEnabled()||this.stop()},ondisablereadonly:function(){this._isEnabled()||this.start()},onstop:function(){this.stop()},start:function(){this._build()},stop:function(){this.buttonSave&&this.buttonSave.stop(),this.buttonCancel&&this.buttonCancel.stop(),this._destroy(),this.app.broadcast("disable")},enable:function(){this.app.broadcast("clickStart");var a=this.editor.isEmpty();a||this.selection.saveMarkers(),this._setFocus(),this._destroy(),this.app.broadcast("enable"),this.buttonSave.enable(),this.buttonCancel.enable(),a||this.selection.restoreMarkers(),a&&this.editor.focus(),this.container.getElement().addClass("redactor-clicktoedit-enabled"),this.source.rebuildStartedContent(),this.app.broadcast("startcode"),this.app.broadcast("image.observe")},save:function(a){a&&a.preventDefault();var b=this.source.getCode();this.app.broadcast("disable"),this.app.broadcast("clickSave",b),this.app.broadcast("clickStop"),this._build()},cancel:function(a){a&&a.preventDefault();var b=this.saved;this.editor.getElement().html(b),this.saved="",this.app.broadcast("disable"),this.app.broadcast("clickCancel",b),this.app.broadcast("clickStop"),this._build()},_build:function(){this.buttonSave=$R.create("clicktoedit.button","save",this.app,this),this.buttonCancel=$R.create("clicktoedit.button","cancel",this.app,this),this.buttonSave.stop(),this.buttonCancel.stop();var a=this.editor.getElement(),b=this.container.getElement();a.on("click.redactor-click-to-edit mouseup.redactor-click-to-edit",this.enable.bind(this)),b.addClass("redactor-over"),b.removeClass("redactor-clicktoedit-enabled")},_isEnabled:function(){return this.container.getElement().hasClass("redactor-clicktoedit-enabled")},_destroy:function(){var a=this.editor.getElement(),b=this.container.getElement();a.off(".redactor-click-to-edit"),b.removeClass("redactor-over redactor-clicktoedit-enabled")},_setFocus:function(){this.saved=this.source.getCode(),this.buttonSave.start(),this.buttonCancel.start()}}),$R.add("class","clicktoedit.button",{init:function(a,b,c){this.app=b,this.opts=b.opts,this.toolbar=b.toolbar,this.context=c,this.type=a,this.name="save"===a?"clickToSave":"clickToCancel",this.objected=!1,this.enabled=!1,this.namespace=".redactor-click-to-edit",this._build()},enable:function(){if(this.objected){var a=this.opts[this.name];a.api="module.clicktoedit."+this.type,this.toolbar.addButton(this.type,a),this.enabled=!0}},start:function(){this.objected||(this.$button.off(this.namespace),this.$button.show(),this.$button.on("click"+this.namespace,this.context[this.type].bind(this.context)))},stop:function(){!this.objected&&this.enabled&&this.$button.hide()},_build:function(){this.objected="object"==typeof this.opts[this.name],this.objected||(this.$button=$R.dom(this.opts[this.name]),this.enabled=!0)}}),$R.add("module","statusbar",{init:function(a){this.app=a,this.opts=a.opts,this.element=a.element,this.statusbar=a.statusbar,this.container=a.container},start:function(){if(!this.element.isType("inline")){var a=this.statusbar.getElement(),b=this.container.getElement();a.addClass("redactor-statusbar"),b.append(a)}}}),$R.add("module","contextbar",{init:function(a){this.app=a,this.opts=a.opts,this.uuid=a.uuid,this.$win=a.$win,this.$doc=a.$doc,this.$body=a.$body,this.editor=a.editor,this.toolbar=a.toolbar,this.detector=a.detector,this.$target=this.toolbar.isTarget()?this.toolbar.getTargetElement():this.$body},onenablereadonly:function(){this.stop()},ondisablereadonly:function(){this.start()},oncontextbar:{close:function(){this.close()}},start:function(){if(this.opts.toolbarContext){var a=this.editor.getElement();this._build(),a.on("click.redactor-context mouseup.redactor-context",this.open.bind(this)),this.opts.scrollTarget?$R.dom(this.opts.scrollTarget).on("scroll.redactor-context",this.close.bind(this)):!1!==this.opts.maxHeight&&a.on("scroll.redactor-context",this.close.bind(this))}},stop:function(){this.editor.getElement().off(".redactor-context"),this.$doc.off(".redactor-context"),this.$win.off(".redactor-context"),this.$contextbar&&this.$contextbar.remove(),this.opts.scrollTarget&&$R.dom(this.opts.scrollTarget).off(".redactor-context")},is:function(){return this.$contextbar&&this.$contextbar.hasClass("open")},set:function(a,b,c,d){this.$contextbar.html(""),this.$el=$R.dom(b);for(var e in c){var f=$R.create("contextbar.button",this.app,c[e]);""!==f.html()&&this.$contextbar.append(f)}var g=this._buildPosition(a,this.$el,d);this.$contextbar.css(g),this.$contextbar.show(),this.$contextbar.addClass("open"),this.$doc.on("click.redactor-context mouseup.redactor-context",this.close.bind(this)),this.$win.on("resize.redactor-context",this.close.bind(this))},open:function(a){setTimeout(function(){this.app.broadcast("contextbar",a,this)}.bind(this),0)},close:function(a){if(this.$contextbar){if(a){var b=$R.dom(a.target);if(this.$el&&0!==b.closest(this.$el).length)return}this.$contextbar.hide(),this.$contextbar.removeClass("open"),this.$doc.off(".redactor.context")}},_build:function(){this.$contextbar=$R.dom("<div>"),this.$contextbar.attr("id","redactor-context-toolbar-"+this.uuid),this.$contextbar.attr("dir",this.opts.direction),this.$contextbar.addClass("redactor-context-toolbar"),this.$contextbar.hide(),this.$target.append(this.$contextbar)},_buildPosition:function(a,b,c){var d,e,f=this.toolbar.isTarget(),g=f?b.position():b.offset(),h=b.width(),i=b.height(),j=this.$contextbar.width(),k=this.$contextbar.height(),l=f?this.$target.scrollTop()+this.$doc.scrollTop():this.$doc.scrollTop(),m=this.$target.offset(),n=f?m.left:0,o=f?m.top:0;return c?"top"===c?(d=g.top-k,e=g.left+h/2-j/2):"bottom"===c&&(d=g.top+i,e=g.left+h/2-j/2):(d=a.clientY+l-k,e=a.clientX-j/2),e<0&&(e=0),{top:d-o+"px",left:e-n+"px"}}}),$R.add("class","contextbar.button",{mixins:["dom"],init:function(a,b){this.app=a,this.obj=b,this._init()},_init:function(){this.parse("<a>"),"string"!=typeof this.obj.title?(this.attr("target","_blank"),this.attr("href",this.obj.title.attr("href")),this.html(this.obj.title.attr("href"))):(this.attr("href","#"),this._buildTitle(),this._buildMessage())},_buildTitle:function(){this.html(this.obj.title)},_buildMessage:function(){void 0===this.obj.message&&void 0===this.obj.api||this.on("click",this._toggle.bind(this))},_toggle:function(a){a.preventDefault(),this.obj.message?this.app.broadcast(this.obj.message,this.obj.args):this.obj.api&&this.app.api(this.obj.api,this.obj.args)}}),$R.add("module","toolbar",{init:function(a){this.app=a,this.uuid=a.uuid,this.opts=a.opts,this.utils=a.utils,this.toolbar=a.toolbar,this.buttons=[],this.toolbarModule=!1},onsource:{open:function(){!this.toolbar.isAir()&&this.toolbar.isFixed()&&this.toolbarModule.resetPosition()},opened:function(){this.toolbar.isAir()&&this.toolbarModule&&this.toolbarModule.createSourceHelper(),setTimeout(function(){$R.dom(".re-button-tooltip-"+this.uuid).remove()}.bind(this),100)},close:function(){this.toolbar.isAir()&&this.toolbarModule&&this.toolbarModule.destroySourceHelper()},closed:function(){this.toolbar.is()&&this.opts.air&&this.toolbarModule.openSelected()}},onobserve:function(){this.toolbar.is()&&this.toolbar.observe()},onfocus:function(){this._setExternalOnFocus()},onsourcefocus:function(){this._setExternalOnFocus()},onempty:function(){this.toolbar.isFixed()&&this.toolbarModule.resetPosition()},onenablereadonly:function(){this.toolbar.isAir()&&this.toolbarModule.close()},start:function(){this.toolbar.is()&&(this._buildButtons(),this._initToolbar(),this._initButtons())},stop:function(){this.toolbarModule&&this.toolbarModule.stop(),$R.dom(".redactor-dropdown-"+this.uuid).remove()},_buildButtons:function(){this.buttons=this.opts.buttons.concat(),this._buildImageButton(),this._buildFileButton(),this._buildSourceButton(),this._buildAdditionalButtons(),this._buildHiddenButtons()},_buildImageButton:function(){this.opts.imageUpload||this.utils.removeFromArrayByValue(this.buttons,"image")},_buildFileButton:function(){this.opts.fileUpload||this.utils.removeFromArrayByValue(this.buttons,"file")},_buildSourceButton:function(){this.opts.source||this.utils.removeFromArrayByValue(this.buttons,"html")},_buildAdditionalButtons:function(){0!==this.opts.buttonsAdd.length&&(this.opts.buttonsAdd=this._removeExistButtons(this.opts.buttonsAdd),this.buttons=this.buttons.concat(this.opts.buttonsAdd)),0!==this.opts.buttonsAddFirst.length&&(this.opts.buttonsAddFirst=this._removeExistButtons(this.opts.buttonsAddFirst),this.buttons.unshift(this.opts.buttonsAddFirst));var a,b;if(!1!==this.opts.buttonsAddAfter){a=this.buttons.indexOf(this.opts.buttonsAddAfter.after)+1,b=this.opts.buttonsAddAfter.buttons;for(var c=0;c<b.length;c++)this.buttons.splice(a+c,0,b[c])}if(!1!==this.opts.buttonsAddBefore){a=this.buttons.indexOf(this.opts.buttonsAddBefore.before)+1,b=this.opts.buttonsAddBefore.buttons;for(var c=0;c<b.length;c++)this.buttons.splice(a-(1-c),0,b[c])}},_buildHiddenButtons:function(){if(0!==this.opts.buttonsHide.length)for(var a=this.opts.buttonsHide,b=0;b<a.length;b++)this.utils.removeFromArrayByValue(this.buttons,a[b])},_removeExistButtons:function(a){for(var b=0;b<a.length;b++)-1!==this.opts.buttons.indexOf(a[b])&&this.utils.removeFromArrayByValue(a,a[b]);return a},_setExternalOnFocus:function(){!this.opts.air&&this.opts.toolbarExternal&&this.toolbarModule.setExternal()},_initToolbar:function(){this.toolbarModule=this.opts.air?$R.create("toolbar.air",this.app):$R.create("toolbar.standard",this.app)},_initButtons:function(){this.toolbar.setButtons(this.buttons);for(var a=0;a<this.buttons.length;a++){var b=this.buttons[a];$R.buttons[b]&&this.toolbar.addButton(b,$R.buttons[b],!1,!1,!0)}}}),$R.add("class","toolbar.air",{init:function(a){this.app=a,this.uuid=a.uuid,this.$doc=a.$doc,this.$win=a.$win,this.utils=a.utils,this.editor=a.editor,this.animate=a.animate,this.toolbar=a.toolbar,this.container=a.container,this.inspector=a.inspector,this.selection=a.selection,this.clicks=0,this._init()},stop:function(){this.toolbar.getWrapper().remove(),this.editor.getElement().off(".redactor-air-trigger-"+this.uuid),this.$doc.off(".redactor-air-"+this.uuid),this.$doc.off(".redactor-air-trigger-"+this.uuid),this.toolbar.stopObservers()},createSourceHelper:function(){this.$airHelper=$R.dom("<span>"),this.$airHelper.addClass("redactor-air-helper"),this.$airHelper.html('<i class="re-icon-html"></i>'),this.$airHelper.on("click",function(a){a.preventDefault(),this.app.api("module.source.hide")}.bind(this)),this.container.getElement().append(this.$airHelper)},destroySourceHelper:function(){this.$airHelper&&this.$airHelper.remove()},openSelected:function(){setTimeout(function(){this._isSelection()&&this._open(!1)}.bind(this),0)},close:function(){this.$doc.off(".redactor-air-"+this.uuid);var a=this.toolbar.getElement();a.removeClass("open"),a.hide()},_init:function(){this.toolbar.create();var a=this.toolbar.getWrapper(),b=this.toolbar.getElement(),c=this.editor.getElement(),d=this.container.getElement();a.addClass("redactor-toolbar-wrapper-air"),b.addClass("redactor-air"),b.hide(),a.append(b),d.prepend(a),this.openSelected(),this.$doc.on("mouseup.redactor-air-trigger-"+this.uuid,this._open.bind(this)),c.on("keyup.redactor-air-trigger-"+this.uuid,this._openCmd.bind(this))},_isSelection:function(){return this.selection.is()&&!this.selection.isCollapsed()},_isOpened:function(){return this.toolbar.getElement().hasClass("open")},_open:function(a){var b=!!a&&a.target,c=!!a&&$R.dom(a.target),d=this.inspector.parse(b),e=d.isComponent()&&!d.isComponentType("table"),f=d.isFigcaption(),g=c&&0!==c.closest(".redactor-modal").length,h=a&&0!==c.closest(".re-button").length;if(!(a&&0!==c.closest(".redactor-dropdown").length||h||g||f||e||this.toolbar.isContextBar())&&this._isSelection()){var i=this.selection.getPosition();setTimeout(function(){this.app.isReadOnly()||this._isSelection()&&this._doOpen(i)}.bind(this),1)}},_openCmd:function(){if(this.selection.isAll()){var a=this.toolbar.getElement(),b=this.selection.getPosition();b.top=b.top<20?0:b.top-a.height(),b.height=0,this._doOpen(b)}},_doOpen:function(a){var b=this.toolbar.getWrapper(),c=this.toolbar.getElement(),d=this.container.getElement(),e=d.offset(),f=0,g=this.$win.width(),h=c.width();if(g<a.left+h){f=h-this.selection.getPosition().width}b.css({left:a.left-e.left-f+"px",top:a.top-e.top+a.height+this.$doc.scrollTop()+"px"}),this.app.broadcast("airOpen"),c.addClass("open"),c.show(),this.$doc.on("click.redactor-air-"+this.uuid,this._close.bind(this)),this.$doc.on("keydown.redactor-air-"+this.uuid,this._close.bind(this)),this.app.broadcast("airOpened")},_close:function(a){var b=!!a&&$R.dom(a.target),c=a&&0!==b.closest("[data-dropdown], .redactor-dropdown-not-close").length;(!c&&a&&0!==b.closest(".re-button").length||!c&&this._isOpened())&&(this.app.broadcast("airClose"),this.close(),this.app.broadcast("airClosed"))}}),$R.add("class","toolbar.fixed",{init:function(a){this.app=a,this.uuid=a.uuid,this.opts=a.opts,this.$doc=a.$doc,this.$win=a.$win,this.editor=a.editor,this.toolbar=a.toolbar,this.detector=a.detector,this.container=a.container,this._init()},stop:function(){this.$fixedTarget.off(".redactor-toolbar-"+this.uuid),this.$win.off(".redactor-toolbar-"+this.uuid)},reset:function(){var a=this.toolbar.getElement();this.toolbar.getWrapper().css("height",""),a.removeClass("redactor-toolbar-fixed"),a.css({position:"",top:"",left:"",width:""});var b=this.toolbar.getDropdown();b&&b.updatePosition()},_init:function(){this.$fixedTarget=this.toolbar.isTarget()?this.toolbar.getTargetElement():this.$win,this._doFixed(),this.toolbar.isTarget()&&(this.$win.on("scroll.redactor-toolbar-"+this.uuid,this._doFixed.bind(this)),this.$win.on("resize.redactor-toolbar-"+this.uuid,this._doFixed.bind(this))),this.$fixedTarget.on("scroll.redactor-toolbar-"+this.uuid,this._doFixed.bind(this)),this.$fixedTarget.on("resize.redactor-toolbar-"+this.uuid,this._doFixed.bind(this))},_doFixed:function(){var a=this.editor.getElement(),b=this.container.getElement(),c=this.toolbar.getElement(),d=this.toolbar.getWrapper();if(!this.editor.isSourceMode()){if(0===b.parents().filter(function(a){return"none"===getComputedStyle(a,null).display&&a}).length){var e=a.height()<100,f=this.editor.isEmpty();if(!(e||f||this.editor.isSourceMode())){var g=c.height(),h=this.toolbar.isTarget()?b.position():b.offset(),i=h.top,j=i+b.height()-60,k=this.$fixedTarget.scrollTop()+this.opts.toolbarFixedTopOffset,l=this.toolbar.isTarget()?this.$fixedTarget.offset().top-this.$win.scrollTop():0;if(k>i&&k<j){var m=this.detector.isDesktop()?"fixed":"absolute";l=this.detector.isDesktop()?l:k-i,this.detector.isMobile()&&(this.fixedScrollTimeout&&clearTimeout(this.fixedScrollTimeout),c.hide(),this.fixedScrollTimeout=setTimeout(function(){c.show()},250)),d.height(g),c.addClass("redactor-toolbar-fixed"),b.hasClass("redactor-box-fullscreen")?c.css({position:m,top:"0px",width:b.width()+"px"}):c.css({position:m,top:l+this.opts.toolbarFixedTopOffset+"px",width:b.width()+"px"});var n=this.toolbar.getDropdown();n&&n.updatePosition(),this.app.broadcast("toolbar.fixed")}else this.reset(),this.app.broadcast("toolbar.unfixed")}}}}}),$R.add("class","toolbar.standard",{init:function(a){this.app=a,this.opts=a.opts,this.uuid=a.uuid,this.$body=a.$body,this.toolbar=a.toolbar,this.container=a.container,this.isExternalMultiple=!1,this.toolbarFixed=!1,this._init()},stop:function(){this.toolbar.getWrapper().remove(),this.toolbarFixed&&this.toolbarFixed.stop(),this.opts.toolbarExternal&&this._findToolbars(),this.toolbar.stopObservers(),this.$body.find(".re-button-tooltip-"+this.uuid).remove()},setExternal:function(){if(this._findToolbars(),this.isExternalMultiple){this.$toolbars.hide();this.$external.find(".redactor-toolbar-external-"+this.uuid).show()}},resetPosition:function(){this.toolbarFixed&&this.toolbarFixed.reset()},_init:function(){if(this._build(),this.opts.toolbarExternal)this._buildExternal();else{this._buildFixed();this.toolbar.getElement().show()}},_build:function(){this.toolbar.create();var a=this.toolbar.getWrapper(),b=this.toolbar.getElement();if(a.addClass("redactor-toolbar-wrapper"),b.addClass("redactor-toolbar"),b.hide(),a.append(b),!this.opts.toolbarExternal){this.container.getElement().prepend(a)}},_buildExternal:function(){if(this._initExternal(),this._findToolbars(),this.isExternalMultiple)this._hideToolbarsExceptFirst();else{this.toolbar.getElement().show()}},_buildFixed:function(){this.opts.toolbarFixed&&(this.toolbarFixed=$R.create("toolbar.fixed",this.app))},_initExternal:function(){var a=this.toolbar.getElement(),b=this.toolbar.getElement();a.addClass("redactor-toolbar-external redactor-toolbar-external-"+this.uuid),this.$external=$R.dom(this.opts.toolbarExternal),this.$external.append(b)},_findToolbars:function(){this.$toolbars=this.$external.find(".redactor-toolbar-external"),this.isExternalMultiple=this.$toolbars.length>1},_hideToolbarsExceptFirst:function(){this.$toolbars.hide(),this.$toolbars.first().show()}}),$R.add("module","line",{init:function(a){this.app=a,this.lang=a.lang,this.component=a.component,this.inspector=a.inspector,this.insertion=a.insertion},oncontextbar:function(a,b){var c=this.inspector.parse(a.target);if(c.isComponentType("line")){var d=c.getComponent(),e={remove:{title:this.lang.get("delete"),api:"module.line.remove",args:d}};b.set(a,d,e,"bottom")}},insert:function(){var a=this.component.create("line");this.insertion.insertRaw(a)},remove:function(a){this.component.remove(a)}}),$R.add("class","line.component",{mixins:["dom","component"],init:function(a,b){return this.app=a,b&&void 0!==b.cmnt?b:this._init(b)},_init:function(a){var b,c;if(void 0!==a){var d=$R.dom(a),e=d.get();"HR"===e.tagName?c=e:"FIGURE"===e.tagName&&(b=e,c=d.find("hr").get())}this._buildWrapper(b),this._buildElement(c),this._initWrapper()},_buildElement:function(a){a?this.$element=$R.dom(a):(this.$element=$R.dom("<hr>"),this.append(this.$element))},_buildWrapper:function(a){a=a||"<figure>",this.parse(a)},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"line",tabindex:"-1",contenteditable:!1})}}),$R.add("module","link",{modals:{link:'<form action="">                 <div class="form-item">                     <label for="modal-link-url">URL <span class="req">*</span></label>                     <input type="text" id="modal-link-url" name="url">                 </div>                 <div class="form-item">                     <label for="modal-link-text">## text ##</label>                     <input type="text" id="modal-link-text" name="text">                 </div>                 <div class="form-item form-item-title">                     <label for="modal-link-title">## title ##</label>                     <input type="text" id="modal-link-title" name="title">                 </div>                 <div class="form-item form-item-target">                     <label class="checkbox">                         <input type="checkbox" name="target"> ## link-in-new-tab ##                     </label>                 </div>             </form>'},init:function(a){this.app=a,this.opts=a.opts,this.lang=a.lang,this.caret=a.caret,this.utils=a.utils,this.inline=a.inline,this.editor=a.editor,this.inspector=a.inspector,this.insertion=a.insertion,this.selection=a.selection,this.isCurrentLink=!1,this.currentText=!1},onmodal:{link:{open:function(a,b){this._setFormData(b,a)},opened:function(a,b){this._setFormFocus(b)},update:function(a,b){var c=b.getData();this._validateData(b,c)&&this._update(c)},insert:function(a,b){var c=b.getData();this._validateData(b,c)&&this._insert(c)},unlink:function(){this._unlink()}}},onbutton:{link:{observe:function(a){this._observeButton(a)}}},ondropdown:{link:{observe:function(a){this._observeUnlink(a),this._observeEdit(a)}}},oncontextbar:function(a,b){var c=this._getCurrent(),d=this.inspector.parse(c);if(d.isLink()){var e=d.getLink(),f=$R.dom(e),g=$R.dom("<a>"),h=f.attr("href");g.text(this._truncateText(h)),g.attr("href",h),g.attr("target","_blank");var i={link:{title:g},edit:{title:this.lang.get("edit"),api:"module.link.open"},unlink:{title:this.lang.get("unlink"),api:"module.link.unlink"}};b.set(a,e,i,"bottom")}},open:function(){this.$link=this._buildCurrent(),this.app.api("module.modal.build",this._getModalData())},insert:function(a){this._insert(a)},update:function(a){this._update(a)},unlink:function(){this._unlink()},_observeButton:function(a){var b=this.selection.getCurrent(),c=this.inspector.parse(b);c.isPre()||c.isCode()?a.disable():a.enable()},_observeUnlink:function(a){var b=a.getItem("unlink");0===this._getLinks().length?b.disable():b.enable()},_observeEdit:function(a){var b=this._getCurrent(),c=a.getItem("link"),d=this.inspector.parse(b),e=d.isLink()?this.lang.get("link-edit"):this.lang.get("link-insert");c.setTitle(e)},_unlink:function(){this.app.api("module.modal.close");var a=[],b=this._getLinks();this.selection.save();for(var c=0;c<b.length;c++){var d=$R.create("link.component",this.app,b[c]);a.push(this.selection.getElement(b[c])),d.unwrap(),this.app.broadcast("link.deleted",d)}this.selection.restore();for(var c=0;c<a.length;c++){var e=a[c]?a[c]:this.editor.getElement();this.utils.normalizeTextNodes(e)}this._resetCurrent()},_update:function(a){this.app.api("module.modal.close");var b=this._getLinks();this._setLinkData(b,a,"updated"),this._resetCurrent()},_insert:function(a){this.app.api("module.modal.close");var b=this._getLinks();this._insertSingle(b,a)||(this._removeInSelection(b),this._insertMultiple(a)),this._resetCurrent()},_removeInSelection:function(a){this.selection.save();for(var b=0;b<a.length;b++){var c=$R.create("link.component",this.app,a[b]),d=c.clone();c.unwrap(),this.app.broadcast("link.deleted",d)}this.selection.restore()},_insertMultiple:function(a){var b=this.selection.getRange();b&&this._isCurrentTextChanged(a)&&this._deleteContents(b);var c=this.inline.format({tag:"a"});this._setLinkData(c,a,"inserted")},_insertSingle:function(a,b){var c=this.selection.getInline();if(1===a.length&&a[0].textContext===this.selection.getText()||c&&"A"===c.tagName){var d=$R.create("link.component",this.app,a[0]);return d.setData(b),this.caret.setAfter(d),this.app.broadcast("link.inserted",d),!0}return!1},_setLinkData:function(a,b,c){b.text=""===b.text.trim()?this._truncateText(b.url):b.text;var d=!this.currentText||this.currentText!==b.text;this.selection.save();for(var e=0;e<a.length;e++){var f=$R.create("link.component",this.app,a[e]),g={};b.text&&d&&(g.text=b.text),b.url&&(g.url=b.url),void 0!==b.title&&(g.title=b.title),void 0!==b.target&&(g.target=b.target),f.setData(g),this.app.broadcast("link."+c,f)}setTimeout(this.selection.restore.bind(this.selection),0)},_deleteContents:function(a){var b=this.selection.getHtml(),c=this.utils.parseHtml(b),d=c.nodes[0];if(d&&3!==d.nodeType){var e=d.tagName.toLowerCase(),f=document.createElement(e);this.insertion.insertNode(f,"start")}else a.deleteContents()},_getModalData:function(){var a;return a=this._isLink()?{update:{title:this.lang.get("save")},unlink:{title:this.lang.get("unlink"),type:"danger"},cancel:{title:this.lang.get("cancel")}}:{insert:{title:this.lang.get("insert")},cancel:{title:this.lang.get("cancel")}},{name:"link",title:this._isLink()?this.lang.get("link-edit"):this.lang.get("link-insert"),handle:this._isLink()?"update":"insert",commands:a}},_isLink:function(){return this.currentLink},_isCurrentTextChanged:function(a){return this.currentText&&this.currentText!==a.text},_buildCurrent:function(){var a,b=this._getCurrent(),c=this.inspector.parse(b);if(c.isLink())this.currentLink=!0,a=c.getLink(),a=$R.create("link.component",this.app,a);else{this.currentLink=!1,a=$R.create("link.component",this.app);var d={text:this.selection.getText()};a.setData(d)}return a},_getCurrent:function(){return this.selection.getInlinesAllSelected({tags:["a"]})[0]},_getLinks:function(){for(var a=this.selection.getInlines({all:!0,tags:["a"]}),b=[],c=0;c<a.length;c++){this.inspector.parse(a[c]).isLink()&&b.push(a[c])}return b},_resetCurrent:function(){this.isCurrentLink=!1,this.currentText=!1},_truncateText:function(a){return a&&a.length>this.opts.linkSize?a.substring(0,this.opts.linkSize)+"...":a},_validateData:function(a,b){return""!==b.url.trim()||a.setError("url")},_setFormFocus:function(a){a.getField("url").focus()},_setFormData:function(a,b){var c=this.$link.getData(),d={url:c.url,text:c.text,title:c.title,target:this.opts.linkTarget||c.target};this.opts.linkNewTab||b.find(".form-item-target").hide(),this.opts.linkTitle||b.find(".form-item-title").hide(),a.setData(d),this.currentText=a.getField("text").val()}}),$R.add("class","link.component",{mixins:["dom","component"],init:function(a,b){return this.app=a,this.opts=a.opts,this.reUrl=/^(?:(?:(?:https?|ftp):)?\/\/)?(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:[\/?#]\S*)?$/i,b&&void 0!==b.cmnt?b:this._init(b)},setData:function(a){for(var b in a)this._set(b,a[b])},getData:function(){for(var a=["url","text","target","title"],b={},c=0;c<a.length;c++)b[a[c]]=this._get(a[c]);return b},_init:function(a){var b=$R.dom(a);void 0===a?this.parse("<a>"):this.parse(b)},_set:function(a,b){this["_set_"+a](b)},_get:function(a){return this["_get_"+a]()},_get_target:function(){return!!this.attr("target")&&this.attr("target")},_get_url:function(){return this.attr("href")},_get_title:function(){return this.attr("title")},_get_text:function(){return this._getContext().text()},_getContext:function(){return this._findDeepestChild(this).element},_set_target:function(a){!1===a?this.removeAttr("target"):a&&this.attr("target",!0===a?"_blank":a)},_set_text:function(a){this._getContext().html(a)},_set_title:function(a){a&&""!==a?this.attr("title",a):this.removeAttr("title")},_set_url:function(a){this.opts.linkValidation&&(a=this._cleanUrl(a),this._isMailto(a)?a="mailto:"+a.replace("mailto:",""):this._isUrl(a)&&-1===a.search(/^(ftp|https?)/i)&&(a="http://"+a.replace(/(ftp|https?):\/\//i,""))),this.attr("href",a)},_isMailto:function(a){return-1!==a.search("@")&&!1===/(ftp|https?):\/\//i.test(a)},_isUrl:function(a){return this.reUrl.test(a)},_cleanUrl:function(a){return a.trim().replace(/[^\W\w\D\d+&\'@#\/%?=~_|!:,.;\(\)]/gi,"")},_findDeepestChild:function(a){var b={depth:0,element:a};return a.children().each(function(c){var d=$R.dom(c);if(c.outerHTML===a.html()){var e=this._findDeepestChild(d);e.depth+1>b.depth&&(b={depth:1+e.depth,element:e.element})}}.bind(this)),b}}),$R.add("module","modal",{init:function(a){this.app=a,this.lang=a.lang,this.$doc=a.$doc,this.$win=a.$win,this.$body=a.$body,this.utils=a.utils,this.editor=a.editor,this.animate=a.animate,this.detector=a.detector,this.selection=a.selection,this.$box=!1,this.$modal=!1,this.selectionMarkers=!1,this.defaults={name:!1,url:!1,title:!1,width:"600px",height:!1,handle:!1,commands:!1}},build:function(a){this._open(a)},close:function(){this._close()},stop:function(){this.$box&&(this.$box.remove(),this.$box=!1,this.$modal=!1,this.$doc.off(".redactor.modal"),this.$win.off(".redactor.modal")),this.$overlay&&this.$overlay.remove()},resize:function(){this.$modal.setWidth(this.p.width),this.$modal.updatePosition()},_isOpened:function(){return this.$modal&&this.$modal.hasClass("open")},_open:function(a){this._buildDefaults(a),this.p.url?this._openUrl():this._openTemplate()},_openUrl:function(){$R.ajax.post({url:this.p.url,success:this._doOpen.bind(this)})},_openTemplate:function(){if(void 0!==$R.modals[this.p.name]){var a=this.lang.parse($R.modals[this.p.name]);this._doOpen(a)}},_doOpen:function(a){this.stop(),this.selection.isCollapsed()?(this.selection.save(),this.selectionMarkers=!1):(this.selection.saveMarkers(),this.selectionMarkers=!0),this.detector.isDesktop()||document.activeElement.blur(),this._createModal(a),this._buildModalBox(),this._buildOverlay(),this._buildModal(),this._buildModalForm(),this._buildModalCommands(),this._broadcast("open"),this.$modal.updatePosition(),this._buildModalTabs(),this.animate.start(this.$box,"fadeIn",this._opened.bind(this)),this.animate.start(this.$overlay,"fadeIn")},_opened:function(){this.$modal.addClass("open"),this.$box.on("mousedown.redactor.modal",this._close.bind(this)),this.$doc.on("keyup.redactor.modal",this._handleEscape.bind(this)),this.$win.on("resize.redactor.modal",this.resize.bind(this)),this.$modal.getBody().find("input[type=text],input[type=url],input[type=email]").on("keydown.redactor.modal",this._handleEnter.bind(this)),window.jQuery&&jQuery(document).off("focusin.modal"),this._broadcast("opened")},_close:function(a){if(this.$box&&this._isOpened()){if(a){if(!this._needToClose(a.target))return;a.stopPropagation(),a.preventDefault()}this.selectionMarkers?this.selection.restoreMarkers():this.selection.restore(),this.selectionMarkers=!1,this._broadcast("close"),this.animate.start(this.$box,"fadeOut",this._closed.bind(this)),this.animate.start(this.$overlay,"fadeOut")}},_closed:function(){this.$modal.removeClass("open"),this.$box.off(".redactor.modal"),this.$doc.off(".redactor.modal"),
this.$win.off(".redactor.modal"),this._broadcast("closed")},_createModal:function(a){this.$modal=$R.create("modal.element",this.app,a)},_broadcast:function(a){this.app.broadcast("modal."+a,this.$modal,this.$modalForm),this.app.broadcast("modal."+this.p.name+"."+a,this.$modal,this.$modalForm)},_buildDefaults:function(a){this.p=$R.extend({},this.defaults,a)},_buildModalBox:function(){this.$box=$R.dom("<div>"),this.$box.attr("id","redactor-modal"),this.$box.addClass("redactor-animate-hide"),this.$box.html(""),this.$body.append(this.$box)},_buildOverlay:function(){this.$overlay=$R.dom("#redactor-overlay"),0===this.$overlay.length&&(this.$overlay=$R.dom("<div>"),this.$overlay.attr("id","redactor-overlay"),this.$overlay.addClass("redactor-animate-hide"),this.$body.prepend(this.$overlay))},_buildModal:function(){this.$box.append(this.$modal),this.$modal.setTitle(this.p.title),this.$modal.setHeight(this.p.height),this.$modal.setWidth(this.p.width)},_buildModalCommands:function(){if(this.p.commands){var a=this.p.commands,b=this.$modal.getFooter();for(var c in a){var d=$R.dom("<button>");d.html(a[c].title),d.attr("data-command",c),"cancel"===c&&(d.attr("data-action","close"),d.addClass("redactor-button-unstyled")),void 0!==a[c].type&&"danger"===a[c].type&&d.addClass("redactor-button-danger"),d.on("click",this._handleCommand.bind(this)),b.append(d)}}},_buildModalTabs:function(){var a=this.$modal.getBody(),b=a.find(".redactor-modal-tab"),c=a.find(".redactor-modal-tabs");b.length>1&&(c=0===c.length?$R.dom("<div>"):c.html(""),c.addClass("redactor-modal-tabs"),b.each(function(a,b){var d=$R.dom(a),e=$R.dom("<a>");e.attr("href","#"),e.attr("rel",b),e.text(d.attr("data-title")),e.on("click",this._showTab.bind(this)),0===b&&e.addClass("active"),c.append(e)}.bind(this)),a.prepend(c))},_buildModalForm:function(){this.$modalForm=$R.create("modal.form",this.app,this.$modal.getForm())},_showTab:function(a){a.preventDefault();var b=$R.dom(a.target),c=b.attr("rel"),d=this.$modal.getBody(),e=d.find(".redactor-modal-tab");e.hide(),e.eq(c).show(),d.find(".redactor-modal-tabs a").removeClass("active"),b.addClass("active")},_needToClose:function(a){var b=$R.dom(a);return!("close"!==b.attr("data-action")&&!this.$modal.isCloseNode(a)&&0!==b.closest(".redactor-modal").length)},_handleCommand:function(a){var b=$R.dom(a.target).closest("button"),c=b.attr("data-command");"cancel"!==c&&a.preventDefault(),this._broadcast(c)},_handleEnter:function(a){13===a.which&&this.p.handle&&(a.preventDefault(),this._broadcast(this.p.handle))},_handleEscape:function(a){27===a.which&&this._close()}}),$R.add("class","modal.element",{mixins:["dom"],init:function(a,b){this.app=a,this.opts=a.opts,this.$win=a.$win,this._init(b)},getForm:function(){return this.find("form")},getHeader:function(){return this.$modalHeader},getBody:function(){return this.$modalBody},getFooter:function(){return this.$modalFooter},setTitle:function(a){a&&this.$modalHeader.html(a)},setWidth:function(a){a=parseInt(a)>=this.$win.width()?"96%":a,this.css("max-width",a)},setHeight:function(a){!1!==a&&this.$modalBody.css("height",a)},updatePosition:function(){var a=this.width();this.css({left:"50%","margin-left":"-"+a/2+"px"});var b=this.$win.height(),c=this.height(),d=b/2-c/2;c<b&&0!==d&&this.css("margin-top",d+"px")},isCloseNode:function(a){return a===this.$modalClose.get()},_init:function(a){this._build(),this._buildClose(),this._buildHeader(),this._buildBody(),this._buildFooter(),this._buildTemplate(a)},_build:function(){this.parse("<div>"),this.addClass("redactor-modal"),this.attr("dir",this.opts.direction)},_buildClose:function(){this.$modalClose=$R.dom("<span>"),this.$modalClose.addClass("redactor-close"),this.append(this.$modalClose)},_buildHeader:function(){this.$modalHeader=$R.dom("<div>"),this.$modalHeader.addClass("redactor-modal-header"),this.append(this.$modalHeader)},_buildBody:function(){this.$modalBody=$R.dom("<div>"),this.$modalBody.addClass("redactor-modal-body"),this.append(this.$modalBody)},_buildFooter:function(){this.$modalFooter=$R.dom("<div>"),this.$modalFooter.addClass("redactor-modal-footer"),this.append(this.$modalFooter)},_buildTemplate:function(a){this.$modalBody.html(a)}}),$R.add("class","modal.form",{mixins:["dom"],init:function(a,b){this.app=a,this.build(b)},build:function(a){this.parse(a)},getData:function(){var a={};return this.find("[name]").each(function(b){var c=$R.dom(b);a[c.attr("name")]=c.val()}),a},setData:function(a){this.find("[name]").each(function(b){var c=$R.dom(b),d=c.attr("name");a.hasOwnProperty(d)&&(b.type&&"checkbox"===b.type?b.checked=a[d]:c.val(a[d]))})},getField:function(a){return this.find("[name="+a+"]")},setError:function(a){var b=this.getField(a);return b.addClass("error"),b.one(this._getFieldEventName(b.get()),this._clearError),!1},_clearError:function(){return $R.dom(this).removeClass("error")},_getFieldEventName:function(a){return"SELECT"===a.tagName||"checkbox"===a.type||"radio"===a.type?"change":"keyup"}}),$R.add("module","block",{init:function(a){this.app=a,this.block=a.block},format:function(a){var b=this.block.format(a);this.app.broadcast("format","block",b)},clearformat:function(){this.block.clearFormat()},clearstyle:function(){this.block.clearStyle()},clearclass:function(){this.block.clearClass()},clearattr:function(){this.block.clearAttr()},add:function(a,b){this.block.add(a,b)},toggle:function(a,b){this.block.toggle(a,b)},set:function(a,b){this.block.set(a,b)},remove:function(a,b){this.block.remove(a,b)}}),$R.add("module","inline",{init:function(a){this.app=a,this.inline=a.inline},format:function(a){var b=this.inline.format(a);this.app.broadcast("format","inline",b)},clearformat:function(){this.inline.clearFormat()},clearstyle:function(){this.inline.clearStyle()},clearclass:function(){this.inline.clearClass()},clearattr:function(){this.inline.clearAttr()},add:function(a,b){this.inline.add(a,b)},toggle:function(a,b){this.inline.toggle(a,b)},set:function(a,b){this.inline.set(a,b)},remove:function(a,b){this.inline.remove(a,b)}}),$R.add("module","autosave",{init:function(a){this.app=a,this.opts=a.opts,this.utils=a.utils,this.source=a.source},onsynced:function(){this.opts.autosave&&this._send()},_send:function(){var a=this.opts.autosaveName?this.opts.autosaveName:this.source.getName(),b={};b[a]=this.source.getCode(),b=this.utils.extendData(b,this.opts.autosaveData),$R.ajax.post({url:this.opts.autosave,data:b,success:function(c){this._complete(c,a,b)}.bind(this)})},_complete:function(a,b,c){var d=a&&a.error?"autosaveError":"autosave";this.app.broadcast(d,b,c,a)}}),$R.add("module","input",{init:function(a){this.app=a,this.opts=a.opts,this.utils=a.utils,this.editor=a.editor,this.keycodes=a.keycodes,this.element=a.element,this.selection=a.selection,this.insertion=a.insertion,this.inspector=a.inspector,this.autoparser=a.autoparser,this.lastShiftKey=!1},onpaste:function(a,b){if(this.opts.input)return $R.create("input.paste",this.app,a,b)},onkeydown:function(a){if(this.opts.input){var b=a.which;if(!$R.create("input.shortcut",this.app,a).is()){if((a.ctrlKey||a.metaKey)&&!a.altKey&&65===b)return a.preventDefault(),this._selectAll();var c=[this.keycodes.ENTER,this.keycodes.SPACE,this.keycodes.BACKSPACE,this.keycodes.DELETE],d=[this.keycodes.UP,this.keycodes.DOWN,this.keycodes.LEFT,this.keycodes.RIGHT],e=-1!==c.indexOf(b),f=-1!==d.indexOf(b),g=(a.ctrlKey||a.metaKey)&&88===b,h=!a.ctrlKey&&!a.metaKey&&(b>=48&&b<=57||b>=65&&b<=90);if(this.selection.isAll()&&f&&(g||!a.ctrlKey&&!a.metaKey&&!a.altKey&&!a.shiftKey)){if(g)return this.editor.disableNonEditables(),void this.app.broadcast("empty");if(this._isArrowKey(b))return!0;if(e&&a.preventDefault(),this.element.isType("inline")){this.editor.getElement().html(""),this.editor.startFocus()}else this.insertion.set(this.opts.emptyHtml);if(e)return;this.app.broadcast("empty")}return this.opts.autoparse&&this.autoparser.format(a,b),h&&this.selection.hasNonEditable()?void a.preventDefault():b===this.keycodes.ENTER?$R.create("input.enter",this.app,a,b):a.metaKey&&219===b?(a.preventDefault(),void this.app.api("module.list.outdent")):b===this.keycodes.TAB||a.metaKey&&221===b?$R.create("input.tab",this.app,a,b):b===this.keycodes.SPACE?$R.create("input.space",this.app,a,b,this.lastShiftKey):this._isDeleteKey(b)?$R.create("input.delete",this.app,a,b):this._isArrowKey(b)?$R.create("input.arrow",this.app,a,b):void 0}}},onkeyup:function(a){if(this.opts.input){var b=a.which;this.lastShiftKey=a.shiftKey,this.app.broadcast("contextbar.close");if(!$R.create("input.shortcode",this.app,a,b).is()){if(b===this.keycodes.BACKSPACE){var c=this.editor.getElement(),d=this.utils.trimSpaces(c.html());if(d=d.replace(/<br\s?\/?>/g,""),""===(d=d.replace(/<div><\/div>/,"")))return a.preventDefault(),this.editor.setEmpty(),void this.editor.startFocus()}this.editor.isEmpty()&&this.app.broadcast("empty")}}},start:function(){this.opts.shortcutsAdd&&(this.opts.shortcuts=$R.extend({},!0,this.opts.shortcuts,this.opts.shortcutsAdd))},_selectAll:function(){var a,b=this.selection.getCurrent(),c=this.inspector.parse(b);return c.isComponentType("table")?(a=c.getTable(),void this.selection.setAll(a)):c.isComponentType("code")?(a=c.getComponentCodeElement(),void this.selection.setAll(a)):void this.selection.setAll()},_isArrowKey:function(a){return-1!==[this.keycodes.UP,this.keycodes.DOWN,this.keycodes.RIGHT,this.keycodes.LEFT].indexOf(a)},_isDeleteKey:function(a){return a===this.keycodes.BACKSPACE||a===this.keycodes.DELETE}}),$R.add("class","input.arrow",{init:function(a,b,c){this.app=a,this.opts=a.opts,this.utils=a.utils,this.caret=a.caret,this.offset=a.offset,this.marker=a.marker,this.editor=a.editor,this.keycodes=a.keycodes,this.component=a.component,this.inspector=a.inspector,this.selection=a.selection,this.key=c,this._init(b)},_init:function(a){if(!this._isRightLeftKey()||!this._isExitVariable(a)){if(this._isRightDownKey()){if(this._isExitOnDownRight(a))return;if(this._selectComponent(a,"End","next"))return}if(this._isLeftUpKey()){if(this._isExitOnUpLeft(a))return;if(this._selectComponent(a,"Start","prev"))return}this.key===this.keycodes.LEFT?this.utils.trimInvisibleChars("left"):this.key===this.keycodes.RIGHT&&this.utils.trimInvisibleChars("right")}},_isRightDownKey:function(){return-1!==[this.keycodes.DOWN,this.keycodes.RIGHT].indexOf(this.key)},_isLeftUpKey:function(){return-1!==[this.keycodes.UP,this.keycodes.LEFT].indexOf(this.key)},_isRightLeftKey:function(){return-1!==[this.keycodes.RIGHT,this.keycodes.LEFT].indexOf(this.key)},_isExitVariable:function(a){var b=this.selection.getCurrent(),c=this.inspector.parse(b),d=c.getComponent();if(c.isComponentType("variable")&&c.isComponentActive()){a.preventDefault();var e=this.key===this.keycodes.LEFT?"setBefore":"setAfter";return void this.caret[e](d)}},_isExitOnUpLeft:function(a){var b=this.selection.getCurrent(),c=this.selection.getBlock(b),d=this.inspector.parse(b),e=c.previousElementSibling,f=this.caret.isStart(c);if(f&&e&&"TABLE"===e.tagName)return a.preventDefault(),this.caret.setEnd(e),!0;if(d.isFigcaption()){c=d.getFigcaption(),f=this.caret.isStart(c);var g=$R.dom(c).closest(".redactor-component");if(f&&0!==g.length)return a.preventDefault(),this.caret.setEnd(g),!0}else{if(d.isTable()&&f)return a.preventDefault(),this.caret.setEnd(c.previousElementSibling),!0;if(!d.isComponentEditable()&&d.isComponent()&&!d.isComponentType("variable")){var h=d.getComponent();if(!h.previousElementSibling)return a.preventDefault(),this.component.clearActive(),this._exitPrevElement(a,d.getComponent());if(h.previousElementSibling)return a.preventDefault(),this.component.clearActive(),this.caret.setEnd(h.previousElementSibling),!0}}},_isExitOnDownRight:function(a){var b,c,d=this.editor.getElement(),e=this.selection.getCurrent(),f=this.inspector.parse(e),g=this.caret.isEnd();if(f.isTable()){if(c||g)return this._exitNextElement(a,f.getComponent())}else if(f.isFigcaption()){if(b=f.getFigcaption(),(c=this.caret.isEnd(b))||g)return this._exitNextElement(a,f.getComponent())}else if(f.isComponentType("code")){var h=f.getComponent(),i=$R.dom(f.getComponentCodeElement()).closest("pre");c=this.caret.isEnd(b);var j=i&&i.get().nextElementSibling;if(c&&!j)return this._exitNextElement(a,h)}else if(f.isPre()||f.isBlockquote()||f.isDl()){if(g){if(f.isPre())return this._exitNextElement(a,f.getPre());if(f.isBlockquote())return this._exitNextElement(a,f.getBlockquote());if(f.isDl())return this._exitNextElement(a,f.getDl())}}else if(f.isList()){var k=$R.dom(e).parents("ul, ol",d).last();if((c=this.caret.isEnd(k))||g)return this._exitNextElement(a,k.get())}else if(f.isComponent()&&!f.isComponentType("variable")&&"span"!==f.getTag())return this.component.clearActive(),this._exitNextElement(a,f.getComponent())},_exitPrevElement:function(a,b){return a.preventDefault(),b.previousElementSibling?this.caret.setEnd(b.previousElementSibling):this.utils.createMarkupBefore(b),!0},_exitNextElement:function(a,b){return a.preventDefault(),b.nextElementSibling?this.caret.setStart(b.nextElementSibling):this.utils.createMarkup(b),!0},_selectComponent:function(a,b,c){var d=this.selection.getCurrent(),e=this.selection.getBlock(d),f=this.utils.findSiblings(d,c),g=this.utils.findSiblings(e,c);f&&this.caret["is"+b](d)?this._selectComponentItem(a,f,b):g&&this.caret["is"+b](e)&&this._selectComponentItem(a,g,b)},_selectComponentItem:function(a,b,c){if(this.component.isNonEditable(b))return a.preventDefault(),this.caret["set"+c](b),!0}}),$R.add("class","input.delete",{init:function(a,b,c){this.app=a,this.opts=a.opts,this.caret=a.caret,this.utils=a.utils,this.editor=a.editor,this.marker=a.marker,this.keycodes=a.keycodes,this.component=a.component,this.inspector=a.inspector,this.selection=a.selection,this.insertion=a.insertion,this.key=c,this._init(b)},_init:function(a){if(!this._removeActiveComponent(a)&&!this._removeAllSelectedTable(a)){if(this.key===this.keycodes.BACKSPACE){var b=this.editor.getElement();if(this.utils.trimSpaces(b.html())===this.opts.emptyHtml)return void a.preventDefault()}if(this._detectVariableOrNonEditable()||this.selection.hasNonEditable())return void a.preventDefault();if(this.selection.isAll())return a.preventDefault(),void this.insertion.set(this.opts.emptyHtml);this.selection.isCollapsed()&&(this.key===this.keycodes.BACKSPACE?this._traverseBackspace(a):this.key===this.keycodes.DELETE&&this._traverseDelete(a)),this.key===this.keycodes.BACKSPACE&&this.utils.trimInvisibleChars("left"),this._removeUnwantedStyles(),this._removeEmptySpans(),this._removeSpanTagsInHeadings(),this._removeInlineTagsInPre()}},_detectVariableOrNonEditable:function(){var a,b=this.selection.getBlock(),c=this.caret.isStart(b),d=this.caret.isEnd(b);if(this.key===this.keycodes.BACKSPACE&&c){if(a=b.previousSibling,this._isNonEditable(a))return!0}else if(this.key===this.keycodes.DELETE&&d&&(a=b.nextSibling,this._isNonEditable(a)))return!0;var e=this.selection.getCurrent(),f=this.caret.isStart(e),g=this.caret.isEnd(e),h=""===this.selection.getTextBeforeCaret().trim(),i=""===this.selection.getTextAfterCaret().trim();if(this.key===this.keycodes.BACKSPACE&&f&&!h){if(a=e.previousSibling,this._isVariable(a))return this.caret.setEnd(a),!0;if(this._isNonEditable(a))return!0}else if(this.key===this.keycodes.DELETE&&g&&!i){if(a=e.nextSibling,this._isVariable(a))return this.caret.setStart(a),!0;if(this._isNonEditable(a))return!0}},_isVariable:function(a){return 0!==$R.dom(a).closest('[data-redactor-type="variable"]').length},_isNonEditable:function(a){return 0!==$R.dom(a).closest(".non-editable").length},_getBlock:function(){var a=this.editor.getElement(),b=this.selection.getBlock(),c=this.inspector.parse(b);return b=c.isList()?$R.dom(b).parents("ul, ol",a).last().get():b,b=c.isDl()?c.getDl():b,b=c.isTable()?c.getTable():b},_traverseDelete:function(a){var b,c,d,e=this.selection.getCurrent(),f=this.inspector.parse(e);if(f.isFigcaption()){if(b=f.getFigcaption(),c=this.caret.isEnd(b))return void a.preventDefault()}else if(f.isComponentType("code")&&(b=f.getComponent(),c=this.caret.isEnd(b)))return void a.preventDefault();b=this._getBlock();var g=this.utils.findSiblings(b,"next");if(g){c=this.caret.isEnd(b);var h=this.inspector.parse(g),i="P"===g.tagName||"DIV"===g.tagName;if(c&&h.isComponentEditable())return a.preventDefault(),void this.component.remove(g,!1);if(c&&h.isComponent())return a.preventDefault(),this.caret.setStart(g),void(this.utils.isEmptyHtml(b.innerHTML)&&$R.dom(b).remove());if(c&&h.isList()){var j=$R.dom(b);if(d=$R.dom(g),f.isList())return a.preventDefault(),j.append(d),void d.unwrap();var k=d.children("li").first(),l=k.find("ul, ol");if(0!==l.length)return a.preventDefault(),d.prepend(l),l.unwrap(),j.append(k),void k.unwrap()}else if(c&&!f.isList()&&!f.isTable()&&i&&!this.utils.isEmptyHtml(b.innerHTML)){a.preventDefault();var m=$R.dom(b);return d=$R.dom(g),m.append(d),void d.unwrap()}}},_traverseBackspace:function(a){var b,c,d,e,f=this.selection.getCurrent(),g=this.inspector.parse(f);if(g.isFigcaption()){if(b=g.getFigcaption(),c=this.caret.isStart(b))return void a.preventDefault()}else if(g.isComponentType("code")&&(b=g.getComponent(),(c=this.caret.isStart(b))&&b.previousElementSibling))return a.preventDefault(),this.caret.setEnd(b.previousElementSibling),!0;b=this._getBlock();var h=this.utils.findSiblings(b,"prev");if(!h)return void setTimeout(this._replaceBlock.bind(this),1);c=this.caret.isStart(b);var i=this.inspector.parse(h),j="P"===h.tagName||"DIV"===h.tagName;if(c&&i.isComponentEditable())return a.preventDefault(),void this.component.remove(h,!1);if(c&&i.isComponent())return a.preventDefault(),this.caret.setStart(h),void(this.utils.isEmptyHtml(b.innerHTML)&&$R.dom(b).remove());if(c&&g.isList())if(a.preventDefault(),e=$R.dom(b),d=$R.dom(h),i.isList())e.children("li").first().prepend(this.marker.build("start")),d.append(e),e.unwrap(),this.selection.restoreMarkers();else{var k=e.children("li").first(),l=k.get(),m=k.find("ul, ol"),n=this.utils.replaceToTag(l,this.opts.markup);this.opts.breakline&&n.attr("data-redactor-tag","br"),e.before(n),this.caret.setStart(n),0!==m.length&&(e.prepend(m),m.unwrap())}else if(c&&j){a.preventDefault();var o=this.utils.createInvisibleChar(),p=$R.dom(b);return d=$R.dom(h),this.caret.setEnd(d),p.prepend(o),d.append(p.contents()),void p.remove()}},_replaceBlock:function(){var a=this.selection.getBlock(),b=$R.dom(a);if("p"===this.opts.markup&&a&&this._isNeedToReplaceBlock(a)){var c=document.createElement(this.opts.markup);b.replaceWith(c),this.caret.setStart(c)}this.opts.breakline&&a&&"DIV"===a.tagName&&b.attr("data-redactor-tag","br")},_isNeedToReplaceBlock:function(a){return"DIV"===a.tagName&&this.utils.isEmptyHtml(a.innerHTML)},_removeActiveComponent:function(a){var b=this.selection.getCurrent(),c=this.inspector.parse(b),d=c.getComponent();if(c.isComponent()&&this.component.isActive(d))return a.preventDefault(),this.component.remove(d),!0},_removeAllSelectedTable:function(a){var b=this.selection.getCurrent(),c=this.inspector.parse(b),d=c.getTable();if(d&&this.selection.isAll(d))return a.preventDefault(),this.component.remove(d),!0},_removeUnwantedStyles:function(){var a=this.editor.getElement();setTimeout(function(){a.find("*[style]").not("img, figure, iframe, [data-redactor-style-cache], [data-redactor-span]").removeAttr("style")},0)},_removeEmptySpans:function(){var a=this.editor.getElement();setTimeout(function(){a.find("span").each(function(a){0===a.attributes.length&&$R.dom(a).replaceWith(a.childNodes)})},0)},_removeSpanTagsInHeadings:function(){var a=this.editor.getElement();setTimeout(function(){a.find("h1, h2, h3, h4, h5, h6").each(function(a){var b=$R.dom(a);0===b.closest("figure").length&&b.find("span").not(".redactor-component, .non-editable, .redactor-selection-marker, [data-redactor-style-cache], [data-redactor-span]").unwrap()})},1)},_removeInlineTagsInPre:function(){var a=this.editor.getElement(),b=this.opts.inlineTags;setTimeout(function(){a.find("pre").each(function(a){var c=$R.dom(a);0===c.closest("figure").length&&c.find(b.join(",")).not("code, .redactor-selection-marker").unwrap()})},1)}}),$R.add("class","input.enter",{init:function(a,b){this.app=a,this.opts=a.opts,this.utils=a.utils,this.caret=a.caret,this.editor=a.editor,this.insertion=a.insertion,this.selection=a.selection,this.inspector=a.inspector,this._init(b)},_init:function(a){return this.opts.enterKey?!1===this.app.broadcast("enter",a)?a.preventDefault():this.selection.hasNonEditable()?void a.preventDefault():a.ctrlKey||a.shiftKey?this._insertBreak(a):void(this._isExit(a)||this._traverse(a)):this._disable(a)},_disable:function(a){a.preventDefault();var b=this.selection.getRange();b&&!b.collapsed&&b.deleteContents()},_insertBreak:function(a){a.preventDefault();var b=this.selection.getCurrent(),c=this.inspector.parse(b);c.isComponent()&&!c.isComponentEditable()||c.isCode()||(c.isPre()?this.insertion.insertNewline():this.insertion.insertBreakLine())},_isExit:function(a){var b=this.editor.getElement(),c=this.selection.getBlock(),d=this.inspector.parse(c),e=this.caret.isEnd(c),f=this.selection.getCurrent(),g=f.previousSibling;if(d.isBlockquote()){var h=e&&this._isExitableBlock(c,"P"),i=e&&this._isExitableDblBreak(g);if(h||i)return this._exitFromElement(a,i?g:c,d.getBlockquote())}else if(!d.isComponentType("code")&&d.isPre()){if(e){var j=c.innerHTML;if(j=this.utils.removeInvisibleChars(j),null!==j.match(/(\n\n\n)$/))return $R.dom(g.previousSibling.previousSibling).remove(),this._exitFromElement(a,g,c)}}else if(d.isDl()){if(e&&this._isExitableBlock(c,"DT"))return this._exitFromElement(a,c,d.getDl())}else if(d.isList()){var k=$R.dom(f).parents("ul, ol",b).last();if((e=this.caret.isEnd(k))&&this._isExitableBlock(c,"LI"))return this._exitFromElement(a,c,k)}else if(d.isComponent()&&d.isComponentActive()&&!d.isFigcaption()&&!d.isComponentEditable())return this._exitFromElement(a,!1,d.getComponent())},_isExitableDblBreak:function(a){var b=!!a&&a.nextSibling;if(b){var c=this.utils.removeInvisibleChars(b.textContent);return 3===b.nodeType&&""===c.trim()}},_isExitableBlock:function(a,b){return a&&a.tagName===b&&this.utils.isEmptyHtml(a.innerHTML)},_exitFromElement:function(a,b,c){return a.preventDefault(),b&&$R.dom(b).remove(),this.utils.createMarkup(c),!0},_exitNextElement:function(a,b){return a.preventDefault(),b.nextSibling?this.caret.setStart(b.nextSibling):this.utils.createMarkup(b),!0},_traverse:function(a){var b=this.selection.getCurrent(),c=this.selection.isText(),d=this.selection.getBlock(),e=this.inspector.parse(b),f=!!d&&d.tagName.toLowerCase();if(e.isPre())return a.preventDefault(),this.insertion.insertNewline();if(!e.isBlockquote()){if(e.isFigcaption()){d=e.getFigcaption();var g=this.caret.isEnd(d),h=this.caret.isEnd();return g||h?this._exitNextElement(a,e.getComponent()):void a.preventDefault()}return e.isDl()?(a.preventDefault(),this._traverseDl(b)):c||this.opts.breakline&&"div"===f?(a.preventDefault(),this.insertion.insertBreakLine()):void setTimeout(this._replaceBlock.bind(this),1)}return(d=this.selection.getBlock(b))&&"BLOCKQUOTE"===d.tagName?(a.preventDefault(),this.insertion.insertBreakLine()):void 0},_traverseDl:function(a){var b=this.selection.getBlock(a),c=this.inspector.parse(b),d=c.getTag(),e=$R.dom(b),f=e.get().nextSibling||!1,g=$R.dom(f),h=f&&g.is("dd"),i=f&&g.is("dt"),j=this.caret.isEnd(b);if("dt"===d&&!h&&j){var k=document.createElement("dd");return e.after(k),void this.caret.setStart(k)}if("dd"===d&&!i&&j){var l=document.createElement("dt");return e.after(l),void this.caret.setStart(l)}return this.insertion.insertBreakLine()},_replaceBlock:function(){var a=this.selection.getBlock(),b=$R.dom(a);if("p"===this.opts.markup&&a&&this._isNeedToReplaceBlock(a)){var c=document.createElement(this.opts.markup);b.replaceWith(c),this.caret.setStart(c)}else if(a)if(this.utils.isEmptyHtml(a.innerHTML))this._clearBlock(b,a);else{var d=this.utils.getFirstNode(a);d&&"BR"===d.tagName&&($R.dom(d).remove(),this.caret.setStart(a))}a&&this._isNeedToCleanBlockStyle(a)&&this.opts.cleanOnEnter&&b.removeAttr("class style"),this.opts.breakline&&a&&"DIV"===a.tagName&&b.attr("data-redactor-tag","br")},_clearBlock:function(a,b){(this.opts.cleanInlineOnEnter||"<br>"===b.innerHTML)&&a.html(""),this.caret.setStart(b)},_isNeedToReplaceBlock:function(a){return"DIV"===a.tagName&&this.utils.isEmptyHtml(a.innerHTML)},_isNeedToCleanBlockStyle:function(a){return"P"===a.tagName&&this.utils.isEmptyHtml(a.innerHTML)}}),$R.add("class","input.paste",{init:function(a,b,c,d,e){this.app=a,this.opts=a.opts,this.editor=a.editor,this.cleaner=a.cleaner,this.container=a.container,this.inspector=a.inspector,this.insertion=a.insertion,this.selection=a.selection,this.autoparser=a.autoparser,this.pasteHtml=d,this.pointInserted=e,this.dataTransfer=c,this._init(b)},_init:function(a){var b=this.dataTransfer||a.clipboardData,c=this.selection.getCurrent(),d=this.inspector.parse(c);if(this.dropPasted=this.dataTransfer,this.isRawCode=d.isPre()||d.isCode(),this.editor.enablePasting(),this.editor.saveScroll(),this.dropPasted||this.selection.saveMarkers(),this.isRawCode||!b){var e;return e=this.isRawCode||b||!window.clipboardData?b.getData("text/plain"):window.clipboardData.getData("text"),a.preventDefault(),void this._insert(a,e)}if(this.pasteHtml)a.preventDefault(),this._insert(a,this.pasteHtml);else{var f=b.getData("URL"),g=this._isPlainText(b)?b.getData("text/plain"):b.getData("text/html");if(g=f&&""!==f?f:g,null!==b.files&&b.files.length>0&&""===g){for(var h=[],i=0;i<b.files.length;i++){var j=b.files[i]||b.items[i].getAsFile();j&&h.push(j)}if(h.length>0)return a.preventDefault(),void this._insertFiles(a,h)}a.preventDefault(),this._insert(a,g)}},_isPlainText:function(a){var b=a.getData("text/plain"),c=a.getData("text/html");if(!b||!c)return null!==b;var d=document.createElement("div");return d.innerHTML=c,d.textContent===b?!d.querySelector(":not(meta)"):void 0},_restoreSelection:function(){this.editor.restoreScroll(),this.editor.disablePasting(),this.dropPasted||this.selection.restoreMarkers()},_insert:function(a,b){var c=this.app.broadcast("pasteBefore",b);if(b=void 0===c?b:c,b=b.trim(),b=this.isRawCode?b:this.cleaner.paste(b),b=this.isRawCode?this.cleaner.encodePhpCode(b):b,c=this.app.broadcast("pasting",b),b=void 0===c?b:c,this._restoreSelection(),this.opts.input){this.opts.autoparse&&this.opts.autoparsePaste&&(b=this.autoparser.parse(b));var d=this.dropPasted?this.insertion.insertToPoint(a,b,this.pointInserted):this.insertion.insertHtml(b);this.app.broadcast("pasted",d),this.app.broadcast("autoparseobserve")}},_insertFiles:function(a,b){this._restoreSelection();var c=-1!==this.opts.imageTypes.indexOf(b[0].type),d=void 0===this.dropPasted;c?this.app.broadcast("dropimage",a,b,d):this.app.broadcast("dropfile",a,b,d)}}),$R.add("class","input.shortcode",{init:function(a,b,c){this.app=a,this.opts=a.opts,this.utils=a.utils,this.marker=a.marker,this.keycodes=a.keycodes,this.selection=a.selection,this.worked=!1,c===this.keycodes.SPACE&&this._init()},is:function(){return this.worked},_init:function(){var a=this.selection.getCurrent();if(a&&3===a.nodeType){var b=this.utils.removeInvisibleChars(a.textContent),c=this.opts.shortcodes;for(var d in c){var e=new RegExp("^"+this.utils.escapeRegExp(d));if(null!==b.match(e)&&void 0!==c[d].format)return this._format(c[d].format,a,e)}}},_format:function(a,b,c){b=this.marker.insert("start").previousSibling;var d=b.textContent;d=this.utils.trimSpaces(d),d=d.replace(c,""),b.textContent=d;var e="ul"===a||"ol"===a?"module.list.toggle":"module.block.format";this.app.api(e,a),this.selection.restoreMarkers(),this.worked=!0}}),$R.add("class","input.shortcut",{init:function(a,b){this.app=a,this.opts=a.opts,this.worked=!1,this.hotkeys={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},this.hotkeysShiftNums={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"},this._init(b)},is:function(){return this.worked},_init:function(a){if(!1===this.opts.shortcuts)return void(!a.ctrlKey&&!a.metaKey||66!==a.which&&73!==a.which||a.preventDefault());for(var b in this.opts.shortcuts)this._build(a,b,this.opts.shortcuts[b])},_build:function(a,b,c){for(var d=b.split(","),e=d.length,f=0;f<e;f++)"string"==typeof d[f]&&this._handler(a,d[f].trim(),c)},_handler:function(a,b,c){b=b.toLowerCase().split(" ");for(var d=this.hotkeys[a.keyCode],e=String.fromCharCode(a.which).toLowerCase(),f="",g={},h=["meta","ctrl","alt","shift"],i=0;i<h.length;i++){var j=h[i];a[j+"Key"]&&d!==j&&(f+=j+"+")}d&&(g[f+d]=!0),e&&(g[f+e]=!0,g[f+this.hotkeysShiftNums[e]]=!0,"shift+"===f&&(g[this.hotkeysShiftNums[e]]=!0));for(var k=b.length,i=0;i<k;i++)if(g[b[i]])return a.preventDefault(),this.worked=!0,void(c.message?(this.app.broadcast(c.message,c.args),this.app.broadcast("buffer.trigger")):c.api&&(this.app.api(c.api,c.args),this.app.broadcast("buffer.trigger")))}}),$R.add("class","input.space",{init:function(a,b,c,d){this.app=a,this.keycodes=a.keycodes,this.insertion=a.insertion,this.selection=a.selection,this.key=c,this.lastShiftKey=d,this._init(b)},_init:function(a){return this.selection.hasNonEditable()?void a.preventDefault():this.lastShiftKey||this.key!==this.keycodes.SPACE||!a.ctrlKey&&!a.shiftKey||a.metaKey?void 0:(a.preventDefault(),void this.insertion.insertChar("&nbsp;"))}}),$R.add("class","input.tab",{init:function(a,b){this.app=a,this.opts=a.opts,this.inspector=a.inspector,this.insertion=a.insertion,this.selection=a.selection,this._init(b)},_init:function(a){if(this.opts.tabKey){if(!1===this.app.broadcast("tab",a))return a.preventDefault();this._traverse(a)}},_traverse:function(a){var b=this.selection.getCurrent(),c=this.inspector.parse(b);return!c.isComponent()&&a.shiftKey?this._insertHardTab(a,4):c.isList()?(a.preventDefault(),this.app.api("module.list.indent")):c.isPre()||c.isComponentType("code")&&!c.isFigcaption()?this._tabCode(a):!1!==this.opts.tabAsSpaces?this._insertHardTab(a,this.opts.tabAsSpaces):void 0},_insertHardTab:function(a,b){a.preventDefault();var c=document.createTextNode(Array(b+1).join(" "));return this.insertion.insertNode(c,"end")},_tabCode:function(a){a.preventDefault();var b=this.opts.preSpaces?document.createTextNode(Array(this.opts.preSpaces+1).join(" ")):document.createTextNode("\t");return this.insertion.insertNode(b,"end")}}),$R.add("module","upload",{init:function(a){this.app=a,this.opts=a.opts,this.lang=a.lang,this.utils=a.utils,this.editor=a.editor,this.progress=a.progress,this.defaults={event:!1,element:!1,name:!1,files:!1,url:!1,data:!1,paramName:!1}},build:function(a){this.p=$R.extend(this.defaults,a),this.$el=$R.dom(this.p.element),"INPUT"===this.$el.get().tagName?this._buildInput():this._buildBox()},send:function(a){this.p=$R.extend(this.defaults,a),this.$uploadbox=this.editor.getElement(),this._send(this.p.event,this.p.files)},complete:function(a,b){this._complete(a,b)},_buildInput:function(){this.box=!1,this.prefix="",this.$uploadbox=$R.dom('<div class="upload-redactor-box" />'),this.$el.hide(),this.$el.after(this.$uploadbox),this.opts.multipleUpload?this.$el.attr("multiple","multiple"):this.$el.removeAttr("multiple"),"file"!==this.p.name&&this.$el.attr("accept","image/*"),this._buildPlaceholder(),this._buildEvents()},_buildBox:function(){this.box=!0,this.prefix="box-",this.$uploadbox=this.$el,this.$uploadbox.attr("ondragstart","return false;"),this.$uploadbox.on("drop.redactor.upload",this._onDropBox.bind(this)),
this.$uploadbox.on("dragover.redactor.upload",this._onDragOver.bind(this)),this.$uploadbox.on("dragleave.redactor.upload",this._onDragLeave.bind(this))},_buildPlaceholder:function(){this.$placeholder=$R.dom('<div class="upload-redactor-placeholder" />'),this.$placeholder.html(this.lang.get("upload-label")),this.$uploadbox.append(this.$placeholder)},_buildEvents:function(){this.$el.on("change.redactor.upload",this._onChange.bind(this)),this.$uploadbox.on("click.redactor.upload",this._onClick.bind(this)),this.$uploadbox.on("drop.redactor.upload",this._onDrop.bind(this)),this.$uploadbox.on("dragover.redactor.upload",this._onDragOver.bind(this)),this.$uploadbox.on("dragleave.redactor.upload",this._onDragLeave.bind(this))},_onClick:function(a){this.$el.click()},_onChange:function(a){this._send(a,this.$el.get().files)},_onDrop:function(a){a.preventDefault(),this._clear(),this._setStatusDrop(),this._send(a)},_onDragOver:function(a){return a.preventDefault(),this._setStatusHover(),!1},_onDragLeave:function(a){return a.preventDefault(),this._removeStatusHover(),!1},_onDropBox:function(a){a.preventDefault(),this._clear(),this._setStatusDrop(),this._send(a)},_removeStatusHover:function(){this.$uploadbox.removeClass("upload-redactor-"+this.prefix+"hover")},_setStatusDrop:function(){this.$uploadbox.addClass("upload-redactor-"+this.prefix+"drop")},_setStatusHover:function(){this.$uploadbox.addClass("upload-redactor-"+this.prefix+"hover")},_setStatusError:function(){this.$uploadbox.addClass("upload-redactor-"+this.prefix+"error")},_setStatusSuccess:function(){this.$uploadbox.addClass("upload-redactor-"+this.prefix+"success")},_clear:function(){for(var a=["drop","hover","error","success"],b=0;b<a.length;b++)this.$uploadbox.removeClass("upload-redactor-"+this.prefix+a[b]);this.$uploadbox.removeAttr("ondragstart")},_send:function(a,b){a=a.originalEvent||a,b=b||a.dataTransfer.files;var c=new FormData,d=this._getUploadParam();c=this._buildData(d,b,c),c=this.utils.extendData(c,this.p.data),!1!==this.app.broadcast("upload.start",a,c,b)&&this._sendData(c,b,a)},_sendData:function(a,b,c){if(this.progress.show(),"function"==typeof this.p.url){var d=this.p.url(a,b,c,this);d instanceof Promise||this._complete(d,c)}else $R.ajax.post({url:this.p.url,data:a,before:function(a){return this.app.broadcast("upload.beforeSend",a)}.bind(this),success:function(a){this._complete(a,c)}.bind(this)})},_getUploadParam:function(){return this.p.paramName?this.p.paramName:"file"},_buildData:function(a,b,c){if(1===b.length)c.append(a+"[]",b[0]);else if(b.length>1&&!1!==this.opts.multipleUpload)for(var d=0;d<b.length;d++)c.append(a+"[]",b[d]);return c},_complete:function(a,b){this._clear(),this.progress.hide(),a&&a.error?(this._setStatusError(),this.app.broadcast("upload."+this.p.name+".error",a,b),this.app.broadcast("upload.error",a)):(this._setStatusSuccess(),this.app.broadcast("upload."+this.p.name+".complete",a,b),this.app.broadcast("upload.complete",a),setTimeout(this._clear.bind(this),500))}}),$R.add("class","code.component",{mixins:["dom","component"],init:function(a,b){return this.app=a,b&&void 0!==b.cmnt?b:this._init(b)},_init:function(a){var b;if(void 0!==a){var c=$R.dom(a),d=c.closest("figure");0!==d.length?this.parse(d):(this.parse("<figure>"),this.append(a)),b=this.find("pre code, pre").last()}else b=$R.dom("<pre>"),this.parse("<figure>"),this.append(b);this._initElement(b),this._initWrapper()},_initElement:function(a){a.attr({tabindex:"-1",contenteditable:!0})},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"code",tabindex:"-1",contenteditable:!1})}}),$R.add("module","form",{init:function(a){this.app=a,this.lang=a.lang,this.component=a.component,this.inspector=a.inspector},onform:{remove:function(a){this._remove(a)}},oncontextbar:function(a,b){var c=this.inspector.parse(a.target);if(c.isComponentType("form")){var d=c.getComponent(),e={remove:{title:this.lang.get("delete"),api:"module.form.remove",args:d}};b.set(a,d,e,"top")}},_remove:function(a){this.component.remove(a)}}),$R.add("class","form.component",{mixins:["dom","component"],init:function(a,b){return this.app=a,this.utils=a.utils,b&&void 0!==b.cmnt?b:this._init(b)},_init:function(a){if(void 0!==a){if(0!==$R.dom(a).closest("form").length){var b=this.utils.replaceToTag(a,"figure");this.parse(b)}else this.parse("<figure>"),this.append(a)}else this.parse("<figure>");this._initWrapper()},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"form",tabindex:"-1",contenteditable:!1})}}),$R.add("module","image",{modals:{image:'<div class="redactor-modal-tab" data-title="## upload ##"><form action="">                 <input type="file" name="file">             </form></div>',imageedit:'<div class="redactor-modal-group">                 <div id="redactor-modal-image-preview" class="redactor-modal-side"></div>                 <form action="" class="redactor-modal-area">                     <div class="form-item">                         <label for="modal-image-title"> ## title ##</label>                         <input type="text" id="modal-image-title" name="title" />                     </div>                     <div class="form-item form-item-caption">                         <label for="modal-image-caption">## caption ##</label>                         <input type="text" id="modal-image-caption" name="caption" aria-label="## caption ##" />                     </div>                     <div class="form-item form-item-align">                         <label>## image-position ##</label>                         <select name="align" aria-label="## image-position ##">                             <option value="none">## none ##</option>                             <option value="left">## left ##</option>                             <option value="center">## center ##</option>                             <option value="right">## right ##</option>                         </select>                     </div>                     <div class="form-item form-item-link">                         <label for="modal-image-url">## link ##</label>                         <input type="text" id="modal-image-url" name="url" aria-label="## link ##" />                     </div>                     <div class="form-item form-item-link">                         <label class="checkbox"><input type="checkbox" name="target" aria-label="## link-in-new-tab ##"> ## link-in-new-tab ##</label>                     </div>                 </form>             </div>'},init:function(a){this.app=a,this.opts=a.opts,this.lang=a.lang,this.caret=a.caret,this.utils=a.utils,this.editor=a.editor,this.storage=a.storage,this.component=a.component,this.inspector=a.inspector,this.insertion=a.insertion,this.selection=a.selection,this.justResized=!1},oninsert:function(){this._observeImages()},onstarted:function(){this.storage.observeImages(),this.opts.imageResizable&&(this.resizer=$R.create("image.resize",this.app)),this._observeImages()},ondropimage:function(a,b,c){if(this.opts.imageUpload){var d={url:this.opts.imageUpload,event:!c&&a,files:b,name:"imagedrop",data:this.opts.imageData,paramName:this.opts.imageUploadParam};this.app.api("module.upload.send",d)}},onstop:function(){this.resizer&&this.resizer.stop()},onbottomclick:function(){this.insertion.insertToEnd(this.editor.getLastNode(),"image")},onimageresizer:{stop:function(){this.resizer&&this.resizer.hide()}},onsource:{open:function(){this.resizer&&this.resizer.hide()},closed:function(){this._observeImages(),this.resizer&&this.resizer.rebuild()}},onupload:{complete:function(){this._observeImages()},image:{complete:function(a){this._insert(a)},error:function(a){this._uploadError(a)}},imageedit:{complete:function(a){this._change(a)},error:function(a){this._uploadError(a)}},imagedrop:{complete:function(a,b){this._insert(a,b)},error:function(a){this._uploadError(a)}},imagereplace:{complete:function(a){this._change(a,!1)},error:function(a){this._uploadError(a)}}},onmodal:{image:{open:function(a,b){this._setUpload(b)}},imageedit:{open:function(a,b){this._setFormData(a,b)},opened:function(a,b){this._setFormFocus(b)},remove:function(){this._remove(this.$image)},save:function(a,b){this._save(a,b)}}},onimage:{observe:function(){this._observeImages()},resized:function(){this.justResized=!0}},oncontextbar:function(a,b){if(this.justResized)return void(this.justResized=!1);var c=this.selection.getCurrent(),d=this.inspector.parse(c);if(!d.isFigcaption()&&d.isComponentType("image")){var e=d.getComponent(),f={edit:{title:this.lang.get("edit"),api:"module.image.open"},remove:{title:this.lang.get("delete"),api:"module.image.remove",args:e}};b.set(a,e,f)}},open:function(){this.$image=this._getCurrent(),this.app.api("module.modal.build",this._getModalData())},insert:function(a){this._insert(a)},remove:function(a){this._remove(a)},_getModalData:function(){return this._isImage()&&this.opts.imageEditable?{name:"imageedit",width:"800px",title:this.lang.get("edit"),handle:"save",commands:{save:{title:this.lang.get("save")},remove:{title:this.lang.get("delete"),type:"danger"},cancel:{title:this.lang.get("cancel")}}}:{name:"image",title:this.lang.get("image")}},_isImage:function(){return this.$image},_getCurrent:function(){var a=this.selection.getCurrent(),b=this.inspector.parse(a);return!(!b.isComponentType("image")||!b.isComponentActive())&&this.component.create("image",b.getComponent())},_insert:function(a,b){if(this.app.api("module.modal.close"),Array.isArray(a)){for(var c={},d=0;d<a.length;d++)c=$R.extend(c,a[d]);a=c}else"string"==typeof a&&(a={file:{url:a}});if("object"==typeof a){var e=0;for(var f in a)"object"==typeof a[f]&&e++;e>1?this._insertMultiple(a,b):this._insertSingle(a,b)}},_insertSingle:function(a,b){for(var c in a)if("object"==typeof a[c]){var d=this._createImageAndStore(a[c]),e=b?this.insertion.insertToPoint(b,d):this.insertion.insertHtml(d);this._removeSpaceBeforeFigure(e[0]),this.component.setActive(e[0]),this.app.broadcast("image.uploaded",e[0],a)}},_insertMultiple:function(a,b){var c,d=0,e=[];for(var f in a)if("object"==typeof a[f]){d++;var g=this._createImageAndStore(a[f]);if(1===d)e=b?this.insertion.insertToPoint(b,g):this.insertion.insertHtml(g);else{var h=$R.dom(e[0]);h.after(g),e=[g.get()],this.app.broadcast("image.inserted",g)}c=e[0],this._removeSpaceBeforeFigure(e[0]),this.app.broadcast("image.uploaded",e[0],a)}this.component.setActive(c)},_createImageAndStore:function(a){var b=this.component.create("image");return b.addClass("redactor-uploaded-figure"),b.setData({src:a.url,id:a.id?a.id:this.utils.getRandomId()}),this.storage.add("image",b.getElement()),b},_removeSpaceBeforeFigure:function(a){if(a){var b=a.previousSibling;b&&(this._removeInvisibleSpace(b),this._removeInvisibleSpace(b.previousSibling))}},_removeInvisibleSpace:function(a){a&&3===a.nodeType&&-1!==this.utils.searchInvisibleChars(a.textContent)&&a.parentNode.removeChild(a)},_save:function(a,b){var c=b.getData(),d={title:c.title};this.opts.imageLink&&(d.link={url:c.url,target:c.target}),this.opts.imageCaption&&(d.caption=c.caption),this.opts.imagePosition&&(d.align=c.align),this.$image.setData(d),this.resizer&&this.resizer.rebuild(),this.app.broadcast("image.changed",this.$image),this.app.api("module.modal.close")},_change:function(a,b){if("string"==typeof a&&(a={file:{url:a}}),"object"==typeof a){var c;for(var d in a)if("object"==typeof a[d]){c=$R.dom("<img>"),c.attr("src",a[d].url),this.$image.changeImage(a[d]),this.app.broadcast("image.changed",this.$image,a),this.app.broadcast("image.uploaded",this.$image,a),this.app.broadcast("hardsync");break}!1!==b&&c.on("load",function(){this.$previewBox.html(c)}.bind(this))}},_uploadError:function(a){this.app.broadcast("image.uploadError",a)},_remove:function(a){this.app.api("module.modal.close"),this.component.remove(a)},_observeImages:function(){var a=this.editor.getElement(),b=this;a.find("img").each(function(a){var c=$R.dom(a);c.off(".drop-to-replace"),c.on("dragover.drop-to-replace dragenter.drop-to-replace",function(a){a.preventDefault()}),c.on("drop.drop-to-replace",function(a){if(!b.app.isDragComponentInside())return b._setReplaceUpload(a,c)})})},_setFormData:function(a,b){this._buildPreview(),this._buildPreviewUpload();var c=this.$image.getData(),d={title:c.title};this.opts.imageCaption?d.caption=c.caption:a.find(".form-item-caption").hide(),this.opts.imagePosition?d.align=c.align:a.find(".form-item-align").hide(),this.opts.imageLink?c.link&&(d.url=c.link.url,c.link.target&&(d.target=!0)):a.find(".form-item-link").hide(),b.setData(d)},_setFormFocus:function(a){a.getField("title").focus()},_setReplaceUpload:function(a,b){if(a=a.originalEvent||a,a.stopPropagation(),a.preventDefault(),this.opts.imageUpload){this.$image=this.component.create("image",b);var c={url:this.opts.imageUpload,files:a.dataTransfer.files,name:"imagereplace",data:this.opts.imageData,paramName:this.opts.imageUploadParam};this.app.api("module.upload.send",c)}},_setUpload:function(a){var b={url:this.opts.imageUpload,element:a.getField("file"),name:"image",data:this.opts.imageData,paramName:this.opts.imageUploadParam};this.app.api("module.upload.build",b)},_buildPreview:function(){this.$preview=$R.dom("#redactor-modal-image-preview");var a=this.$image.getData(),b=$R.dom("<img>");b.attr("src",a.src),this.$previewBox=$R.dom("<div>"),this.$previewBox.append(b),this.$preview.html(""),this.$preview.append(this.$previewBox)},_buildPreviewUpload:function(){if(this.opts.imageUpload){var a=$R.dom('<div class="desc">');a.html(this.lang.get("upload-change-label")),this.$preview.append(a);var b={url:this.opts.imageUpload,element:this.$previewBox,name:"imageedit",paramName:this.opts.imageUploadParam};this.app.api("module.upload.build",b)}}}),$R.add("class","image.component",{mixins:["dom","component"],init:function(a,b){return this.app=a,this.opts=a.opts,this.selection=a.selection,b&&void 0!==b.cmnt?b:this._init(b)},setData:function(a){for(var b in a)this._set(b,a[b])},getData:function(){for(var a=["src","title","caption","align","link","id"],b={},c=0;c<a.length;c++)b[a[c]]=this._get(a[c]);return b},getElement:function(){return this.$element},changeImage:function(a){this.$element.attr("src",a.url)},_init:function(a){var b=$R.dom(a),c=b.closest("figure");void 0===a?(this.$element=$R.dom("<img>"),this.parse("<figure>"),this.append(this.$element)):0===c.length?(this.parse("<figure>"),this.$element=b,this.$element.wrap(this)):(this.parse(c),this.$element=this.find("img")),this._initWrapper()},_set:function(a,b){this["_set_"+a](b)},_get:function(a){return this["_get_"+a]()},_set_src:function(a){this.$element.attr("src",a)},_set_id:function(a){this.$element.attr("data-image",a)},_set_title:function(a){a=a.trim().replace(/(<([^>]+)>)/gi,""),""===a?this.$element.removeAttr("alt"):this.$element.attr("alt",a)},_set_caption:function(a){var b=this.find("figcaption");return 0===b.length&&(b=$R.dom("<figcaption>"),b.attr("contenteditable","true"),this.append(b)),""===a?b.remove():b.html(a),b},_set_align:function(a){var b="",c="",d="",e=this,f=this.find("figcaption");if("object"==typeof this.opts.imagePosition){var g=this.opts.imagePosition;for(var h in g)e.removeClass(g[h]);var i=void 0!==g[a]&&g[a];i&&e.addClass(i)}else{switch(a){case"left":b="left",c="0 "+this.opts.imageFloatMargin+" "+this.opts.imageFloatMargin+" 0";break;case"right":b="right",c="0 0 "+this.opts.imageFloatMargin+" "+this.opts.imageFloatMargin;break;case"center":d="center"}e.css({float:b,margin:c,"text-align":d}),e.attr("rel",e.attr("style")),"center"===a?f.css("text-align","center"):f.css("text-align","")}},_set_link:function(a){var b=this._findLink();return""===a.url?void(b&&b.unwrap()):(b||(b=$R.dom("<a>"),this.$element.wrap(b)),b.attr("href",a.url),a.target?b.attr("target",!0===a.target?"_blank":a.target):b.removeAttr("target"),b)},_get_src:function(){return this.$element.attr("src")},_get_id:function(){return this.$element.attr("data-image")},_get_title:function(){var a=this.$element.attr("alt");return a||""},_get_caption:function(){var a=this.find("figcaption");return 0===a.length?"":a.html()},_get_align:function(){var a="";if("object"==typeof this.opts.imagePosition){a="none";var b=this.opts.imagePosition;for(var c in b)if(this.hasClass(b[c])){a=c;break}}else a="center"===this.css("text-align")?"center":this.css("float");return a},_get_link:function(){var a=this._findLink();if(a){var b=!!a.attr("target");return{url:a.attr("href"),target:b}}},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"image",tabindex:"-1",contenteditable:!1})},_findLink:function(){var a=this.find("a").filter(function(a){return 0===$R.dom(a).closest("figcaption").length});return 0!==a.length&&a}}),$R.add("class","image.resize",{init:function(a){this.app=a,this.$doc=a.$doc,this.$win=a.$win,this.$body=a.$body,this.editor=a.editor,this.toolbar=a.toolbar,this.inspector=a.inspector,this.$target=this.toolbar.isTarget()?this.toolbar.getTargetElement():this.$body,this._init()},rebuild:function(){this._setResizerPosition()},hide:function(){this.$target.find("#redactor-image-resizer").remove()},stop:function(){this.editor.getElement().off(".redactor.image-resize"),this.$doc.off(".redactor.image-resize"),this.$win.off("resize.redactor.image-resize"),this.hide()},_init:function(){this.editor.getElement().on("click.redactor.image-resize",this._build.bind(this)),this.$win.on("resize.redactor.image-resize",this._setResizerPosition.bind(this))},_build:function(a){this.$target.find("#redactor-image-resizer").remove();var b=this.inspector.parse(a.target),c=this.editor.getElement();b.isComponentType("image")&&(this.$resizableBox=c,this.$resizableImage=$R.dom(b.getImageElement()),this.$resizer=$R.dom("<span>"),this.$resizer.attr("id","redactor-image-resizer"),this.$target.append(this.$resizer),this._setResizerPosition(),this.$resizer.on("mousedown touchstart",this._set.bind(this)))},_setResizerPosition:function(){if(this.$resizer){var a=this.toolbar.isTarget(),b=this.$target.offset(),c=a?7-b.top+this.$target.scrollTop():7,d=a?7-b.left:7,e=this.$resizableImage.offset(),f=this.$resizableImage.width(),g=this.$resizableImage.height(),h=this.$resizer.width(),i=this.$resizer.height();this.$resizer.css({top:e.top+g-i+c+"px",left:e.left+f-h+d+"px"})}},_set:function(a){a.preventDefault(),this.resizeHandle={x:a.pageX,y:a.pageY,el:this.$resizableImage,ratio:this.$resizableImage.width()/this.$resizableImage.height(),h:this.$resizableImage.height()},a=a.originalEvent||a,a.targetTouches&&(this.resizeHandle.x=a.targetTouches[0].pageX,this.resizeHandle.y=a.targetTouches[0].pageY),this.app.broadcast("contextbar.close"),this.app.broadcast("image.resize",this.$resizableImage),this._start()},_start:function(){this.$doc.on("mousemove.redactor.image-resize touchmove.redactor.image-resize",this._move.bind(this)),this.$doc.on("mouseup.redactor.image-resize touchend.redactor.image-resize",this._stop.bind(this))},_stop:function(){this.$doc.off(".redactor.image-resize"),this.app.broadcast("image.resized",this.$resizableImage)},_move:function(a){a.preventDefault(),a=a.originalEvent||a;var b=this.resizeHandle.h;a.targetTouches?b+=a.targetTouches[0].pageY-this.resizeHandle.y:b+=a.pageY-this.resizeHandle.y;var c=b*this.resizeHandle.ratio;b<20||c<100||this._getResizableBoxWidth()<=c||(this.resizeHandle.el.attr({width:c,height:b}),this.resizeHandle.el.width(c),this.resizeHandle.el.height(b),this._setResizerPosition())},_getResizableBoxWidth:function(){return this.$resizableBox.width()-parseInt(this.$resizableBox.css("padding-left"))-parseInt(this.$resizableBox.css("padding-right"))}}),$R.add("module","file",{modals:{file:'<div class="redactor-modal-tab" data-title="## upload ##"><form action="">                 <div class="form-item form-item-title">                     <label for="modal-file-title"> ## filename ## <span class="desc">(## optional ##)</span></label>                     <input type="text" id="modal-file-title" name="title" />                 </div>                 <input type="file" name="file">             </form></div>'},init:function(a){this.app=a,this.opts=a.opts,this.lang=a.lang,this.caret=a.caret,this.utils=a.utils,this.storage=a.storage,this.component=a.component,this.inspector=a.inspector,this.insertion=a.insertion,this.selection=a.selection},onstarted:function(){this.storage.observeFiles()},ondropfile:function(a,b,c){if(this.opts.fileUpload){var d={url:this.opts.fileUpload,event:!c&&a,files:b,name:"filedrop",data:this.opts.fileData};this.app.api("module.upload.send",d)}},onmodal:{file:{open:function(a,b){this._setFormData(a,b),this._setUpload(b)},opened:function(a,b){this._setFormFocus(b),this.$form=b}}},onupload:{file:{complete:function(a){this._insert(a)},error:function(a){this._uploadError(a)}},filedrop:{complete:function(a,b){this._insert(a,b)},error:function(a){this._uploadError(a)}}},oncontextbar:function(a,b){var c=this.selection.getCurrent(),d=this.inspector.parse(c);if(d.isFile()){var e=d.getFile(),f={remove:{title:this.lang.get("delete"),api:"module.file.remove",args:e}};b.set(a,e,f,"bottom")}},open:function(){this._open()},insert:function(a){this._insert(a)},remove:function(a){this._remove(a)},_open:function(){this.app.api("module.modal.build",this._getModalData())},_getModalData:function(){return{name:"file",title:this.lang.get("file")}},_insert:function(a,b){if(this.app.api("module.modal.close"),"object"==typeof a){if(Array.isArray(a)){for(var c={},d=0;d<a.length;d++)c=$R.extend(c,a[d]);a=c}Object.keys(a).length>1?this._insertMultiple(a,b):this._insertSingle(a,b),this.$form=!1}},_insertSingle:function(a,b){var c=[];for(var d in a){var e=this._createFileAndStore(a[d]);c=this.opts.fileAttachment?this._insertAsAttachment(e):b?this.insertion.insertToPoint(b,e):this.insertion.insertRaw(e),this.app.broadcast("file.uploaded",c[0],a)}},_insertMultiple:function(a,b){var c,d=0,e=[];for(var f in a){d++;var g=this._createFileAndStore(a[f]);if(this.opts.fileAttachment)e=this._insertAsAttachment(g,a);else if(1===d)e=b?this.insertion.insertToPoint(b,g):this.insertion.insertRaw(g);else{var h=$R.dom(e[0]);h.after(g).after(" "),e=[g.get()],this.app.broadcast("file.inserted",g)}c=g,this.app.broadcast("file.uploaded",e[0],a)}this.opts.fileAttachment||this.caret.setAfter(c)},_insertAsAttachment:function(a,b){var c=$R.dom(this.opts.fileAttachment),d=a.wrapAttachment();c.append(d);var e=[d.get()];return this.app.broadcast("file.appended",e[0],b),e},_createFileAndStore:function(a){var b=!!this.$form&&this.$form.getData(),c=a.name?a.name:a.url,d=!this.opts.fileAttachment&&b&&""!==b.title?b.title:this._truncateUrl(c),e=this.component.create("file");return e.attr("href",a.url),e.attr("data-file",a.id?a.id:this.utils.getRandomId()),e.attr("data-name",a.name),e.html(d),this.storage.add("file",e),e},_remove:function(a){this.selection.save();var b=this.component.create("file",a);!1!==this.app.broadcast("file.delete",b)?(b.unwrap(),this.selection.restore(),this.app.broadcast("file.deleted",b)):this.selection.restore()},_truncateUrl:function(a){return-1!==a.search(/^http/)&&a.length>20?a.substring(0,20)+"...":a},_setUpload:function(a){var b={url:this.opts.fileUpload,element:a.getField("file"),name:"file",data:this.opts.fileData,paramName:this.opts.fileUploadParam};this.app.api("module.upload.build",b)},_setFormData:function(a,b){this.opts.fileAttachment?a.find(".form-item-title").hide():b.setData({title:this.selection.getText()})},_setFormFocus:function(a){a.getField("title").focus()},_uploadError:function(a){this.app.broadcast("file.uploadError",a)}}),$R.add("class","file.component",{mixins:["dom","component"],init:function(a,b){return this.app=a,this.opts=a.opts,b&&void 0!==b.cmnt?b:this._init(b)},wrapAttachment:function(){return this.$wrapper=$R.dom('<span class="redactor-file-item">'),this.$remover=$R.dom('<span class="redactor-file-remover">'),this.$remover.html("&times;"),this.$remover.on("click",this.removeAttachment.bind(this)),this.$wrapper.append(this),this.$wrapper.append(this.$remover),this.$wrapper},removeAttachment:function(a){a.preventDefault(),!1!==this.app.broadcast("file.delete",this,this.$wrapper)&&(this.$wrapper.remove(),this.app.broadcast("file.deleted",this),this.app.broadcast("file.removeAttachment",this))},_init:function(a){if(void 0===a)this.parse("<a>");else{var b=$R.dom(a).closest("a");this.parse(b)}}}),$R.add("module","buffer",{init:function(a){this.app=a,this.opts=a.opts,this.editor=a.editor,this.offset=a.offset,this.keycodes=a.keycodes,this.selection=a.selection,this.state=!1,this.passed=!1,this.keyPressed=!1,this.savedHtml=!1,this.savedOffset=!1,this.undoStorage=[],this.redoStorage=[]},onkeydown:function(a){this._listen(a)},onsyncing:function(){this.keyPressed||this.trigger(),this.keyPressed=!1},onbuffer:{trigger:function(){this.trigger()}},onstate:function(a,b,c){a&&(a.ctrlKey||a.metaKey)||a&&(this._isUndo(a)||this._isRedo(a))||(this.passed=!1,this._saveState(b,c))},onenable:function(){this.clear()},clear:function(){this.state=!1,this.undoStorage=[],this.redoStorage=[]},undo:function(){this._getUndo()},redo:function(){this._getRedo()},trigger:function(){this.state&&!1===this.passed&&this._setUndo()},_saveState:function(a,b){var c=this.editor.getElement();this.state={html:a||c.html(),offset:b||this.offset.get()}},_listen:function(a){var b=a.which,c=a.ctrlKey||a.metaKey,d=c||a.shiftKey||a.altKey,e=[this.keycodes.SPACE,this.keycodes.ENTER,this.keycodes.BACKSPACE,this.keycodes.DELETE,this.keycodes.TAB,this.keycodes.LEFT,this.keycodes.RIGHT,this.keycodes.UP,this.keycodes.DOWN];return this._isUndo(a)?(a.preventDefault(),void this.undo()):this._isRedo(a)?(a.preventDefault(),void this.redo()):(c||-1===e.indexOf(b)?!c||88!==b&&67!==b||(d=!0,this.trigger()):(d=!0,this.trigger()),d||this._hasUndo()||this.trigger(),void(this.keyPressed=!0))},_isUndo:function(a){var b=a.which;return(a.ctrlKey||a.metaKey)&&90===b&&!a.shiftKey&&!a.altKey},_isRedo:function(a){var b=a.which;return(a.ctrlKey||a.metaKey)&&(90===b&&a.shiftKey||89===b&&!a.shiftKey)&&!a.altKey},_setUndo:function(){var a=this.undoStorage[this.undoStorage.length-1];void 0!==a&&a[0]===this.state.html||(this.undoStorage.push([this.state.html,this.state.offset]),this._removeOverStorage())},_setRedo:function(){var a=this.editor.getElement(),b=this.offset.get(),c=a.html();this.redoStorage.push([c,b]),this.redoStorage=this.redoStorage.slice(0,this.opts.bufferLimit)},_getUndo:function(){if(this._hasUndo()){this.passed=!0;var a=this.editor.getElement(),b=this.undoStorage.pop();this._setRedo(),a.html(b[0]),this.offset.set(b[1]),this.selection.restore(),this.app.broadcast("undo",b[0],b[1])}},_getRedo:function(){if(this._hasRedo()){this.passed=!0;var a=this.editor.getElement(),b=this.redoStorage.pop();this._setUndo(),a.html(b[0]),this.offset.set(b[1]),this.app.broadcast("redo",b[0],b[1])}},_removeOverStorage:function(){this.undoStorage.length>this.opts.bufferLimit&&(this.undoStorage=this.undoStorage.slice(0,this.undoStorage.length-this.opts.bufferLimit))},_hasUndo:function(){return 0!==this.undoStorage.length},_hasRedo:function(){return 0!==this.redoStorage.length}}),$R.add("module","list",{init:function(a){this.app=a,this.opts=a.opts,this.utils=a.utils,this.block=a.block,this.toolbar=a.toolbar,this.inspector=a.inspector,this.selection=a.selection},onbutton:{list:{observe:function(a){this._observeButton(a)}}},ondropdown:{list:{observe:function(a){this._observeDropdown(a)}}},toggle:function(a){var b=this._getBlocks(),c=this.selection.getBlock(),d=$R.dom(c).parents("ul, ol",".redactor-in").last();return 0===b.length&&0!==d.length&&(b=[d.get()]),!c||"TD"!==c.tagName&&"TH"!==c.tagName||(b=this.block.format("div")),this.selection.saveMarkers(),b=0!==b.length&&this._isUnformat(a,b)?this._unformat(a,b):this._format(a,b),this.selection.restoreMarkers(),b},indent:function(){var a=this.selection.isCollapsed(),b=this.selection.getCurrent(),c=this.inspector.parse(b),d=!!c.isList()&&c.getListItem(),e=$R.dom(d),f=e.prevElement(),g=f.get();if(a&&d&&g&&"LI"===g.tagName){this.selection.saveMarkers(),f=$R.dom(g);var h=f.children("ul, ol"),i=e.closest("ul, ol");if(0!==h.length)h.append(e);else{var j=i.get().tagName.toLowerCase(),k=$R.dom("<"+j+">");k.append(e),f.append(k)}this.selection.restoreMarkers()}},outdent:function(){var a=this.selection.isCollapsed(),b=this.selection.getCurrent(),c=this.inspector.parse(b),d=!!c.isList()&&c.getListItem(),e=$R.dom(d);if(a&&d){var f,g,h,i,j=e.parent(),k=j.closest("li",".redactor-in"),l=e.prevElement(),m=e.nextElement(),n=l.get(),o=m.get(),p=!1===n,q=!1!==n&&!1!==o,r=!p&&!1===o;if(this.selection.saveMarkers(),0!==k.length)if(q){f=this._getAllNext(e.get()),h=$R.dom("<"+j.get().tagName.toLowerCase()+">");for(var s=0;s<f.length;s++)h.append(f[s]);k.after(e),e.append(h)}else k.after(e),0===j.children().length?j.remove():p&&e.append(j);else{var t=this._createUnformatContainer(e),u=t.find("ul, ol").first();if(p)j.before(t);else if(r)j.after(t);else if(q){h=$R.dom("<"+j.get().tagName.toLowerCase()+">"),f=this._getAllNext(e.get());for(var s=0;s<f.length;s++)h.append(f[s]);j.after(t),t.after(h)}0!==u.length&&(i=t.nextElement(),g=i.get(),g&&g.tagName===j.get().tagName?($R.dom(g).prepend(u),u.unwrap()):t.after(u)),e.remove()}this.selection.restoreMarkers()}},_getAllNext:function(a){for(var b=[];a;){if(!(a=$R.dom(a).nextElement().get()))return b;b.push(a)}return b},_isUnformat:function(a,b){for(var c=0,d=0;d<b.length;d++)if(3!==b[d].nodeType){var e=b[d].tagName.toLowerCase();e!==a&&"figure"!==e||c++}return c===b.length},_format:function(a,b){var c=["p","div","blockquote","pre","h1","h2","h3","h4","h5","h6","ul","ol"],d=this._uniteBlocks(b,c),e=[];for(var f in d){for(var g=d[f],h=this._createList(a,d[f]),i=0;i<g.length;i++){var j;if(3===g[i].nodeType||"UL"!==g[i].tagName&&"OL"!==g[i].tagName)j=this._createListItem(g[i]),this.utils.normalizeTextNodes(j),h.append(j);else{var k=$R.dom(g[i]);j=k.contents(),h.append(j),this.utils.isEmpty(k)&&k.remove()}}e.push(h.get())}return e},_uniteBlocks:function(a,b){for(var c=0,d={0:[]},e=!1,f=0;f<a.length;f++){var g=$R.dom(a[f]),h=g.closest("th, td");0!==h.length?(h.get()!==e&&(c++,d[c]=[]),this._isUniteBlock(a[f],b)&&d[c].push(a[f])):this._isUniteBlock(a[f],b)?d[c].push(a[f]):(c++,d[c]=[]),e=h.get()}return d},_isUniteBlock:function(a,b){return 3===a.nodeType||-1!==b.indexOf(a.tagName.toLowerCase())},_createList:function(a,b){var c=b[b.length-1],d=$R.dom(c),e=$R.dom("<"+a+">");return d.after(e),e},_createListItem:function(a){var b=$R.dom("<li>");if(3===a.nodeType)b.append(a);else{var c=$R.dom(a);b.append(c.contents()),c.remove()}return b},_unformat:function(a,b){if(1===b.length){var c=$R.dom(b[0]),d=c.find("li"),e=this.selection.getNodes({tags:["li"]}),f=this.selection.getBlock(),g=$R.dom(f).closest("li");if(0===e.length&&0!==g.length&&(e=[g.get()]),e.length===d.length)return this._unformatEntire(b[0]);var h=this._getItemsPosition(d,e);if("Top"===h)return this._unformatAtSide("before",e,c);if("Bottom"===h)return e.reverse(),this._unformatAtSide("after",e,c);if("Middle"===h){var i=$R.dom(e[e.length-1]),j=!1,k=!1,l=$R.dom("<"+c.get().tagName.toLowerCase()+">");d.each(function(a){if(j){var b=$R.dom(a);0!==b.closest(".redactor-split-item").length||!1!==k&&0!==b.closest(k).length||b.addClass("redactor-split-item"),k=b}a===i.get()&&(j=!0)}),d.filter(".redactor-split-item").each(function(a){$R.dom(a).removeClass("redactor-split-item"),l.append(a)}),c.after(l),e.reverse();for(var m=0;m<e.length;m++){var n=$R.dom(e[m]),o=this._createUnformatContainer(n);c.after(o),o.find("ul, ol").remove(),n.remove()}return}}else for(var m=0;m<b.length;m++)3!==b[m].nodeType&&b[m].tagName.toLowerCase()===a&&this._unformatEntire(b[m])},_unformatEntire:function(a){var b=$R.dom(a);b.find("li").each(function(a){var c=$R.dom(a),d=this._createUnformatContainer(c);c.remove(),b.before(d)}.bind(this)),b.remove()},_unformatAtSide:function(a,b,c){for(var d=0;d<b.length;d++){
var e=$R.dom(b[d]),f=this._createUnformatContainer(e);c[a](f);var g=f.find("ul, ol").first();e.append(g),g.each(function(a){var c=$R.dom(a),e=c.closest("li");e.get()===b[d]&&(c.unwrap(),e.addClass("r-unwrapped"))}),this.utils.isEmptyHtml(e.html())&&e.remove()}c.find(".r-unwrapped").each(function(a){var b=$R.dom(a);""===b.html().trim()?b.remove():b.removeClass("r-unwrapped")})},_getItemsPosition:function(a,b){var c="Middle",d=b[0],e=b[b.length-1],f=a.first().get(),g=a.last().get();return f===d&&g!==e?c="Top":f!==d&&g===e&&(c="Bottom"),c},_createUnformatContainer:function(a){var b=$R.dom("<"+this.opts.markup+">");return this.opts.breakline&&b.attr("data-redactor-tag","br"),b.append(a.contents()),b},_getBlocks:function(){return this.selection.getBlocks({first:!0})},_observeButton:function(){var a=this.selection.getCurrent(),b=this.inspector.parse(a),c=b.isPre()||b.isCode()||b.isFigcaption();this._observeButtonsList(c,["lists","ul","ol","outdent","indent"]);var d=this.toolbar.getButton("outdent"),e=this.toolbar.getButton("indent");this._observeIndent(e,d)},_observeDropdown:function(a){var b=a.getItem("outdent"),c=a.getItem("indent");this._observeIndent(c,b)},_observeIndent:function(a,b){var c=this.selection.isCollapsed(),d=this.selection.getCurrent(),e=this.inspector.parse(d),f=!!e.isList()&&e.getListItem(),g=$R.dom(f),h=g.prevElement(),i=h.get(),j=c&&f&&i&&"LI"===i.tagName;b&&(f&&c?b.enable():b.disable()),a&&(f&&j?a.enable():a.disable())},_observeButtonsList:function(a,b){for(var c=0;c<b.length;c++){var d=this.toolbar.getButton(b[c]);d&&(a?d.disable():d.enable())}}}),$R.add("class","video.component",{mixins:["dom","component"],init:function(a,b){return this.app=a,b&&void 0!==b.cmnt?b:this._init(b)},_init:function(a){if(void 0!==a){var b=$R.dom(a),c=b.closest("figure");0!==c.length?this.parse(c):(this.parse("<figure>"),this.append(a))}else this.parse("<figure>");this._initWrapper()},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"video",tabindex:"-1",contenteditable:!1})}}),$R.add("class","widget.component",{mixins:["dom","component"],init:function(a,b){return this.app=a,b&&void 0!==b.cmnt?b:this._init(b)},getData:function(){return{html:this._getHtml()}},_init:function(a){if(void 0!==a){var b=$R.dom(a),c=b.closest("figure");0!==c.length?this.parse(c):(this.parse("<figure>"),this.html(a))}else this.parse("<figure>");this._initWrapper()},_getHtml:function(){var a=$R.dom("<div>");return a.html(this.html()),a.find(".redactor-component-caret").remove(),a.html()},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"widget",tabindex:"-1",contenteditable:!1})}}),window.Redactor=window.$R=$R,window.addEventListener("load",function(){$R("[data-redactor]")})}(),Redactor.add("plugin","alignment",{translations:{en:{align:"Align","align-left":"Align Left","align-center":"Align Center","align-right":"Align Right","align-justify":"Align Justify"}},init:function(a){this.app=a,this.opts=a.opts,this.lang=a.lang,this.block=a.block,this.toolbar=a.toolbar},start:function(){var a={};a.left={title:this.lang.get("align-left"),api:"plugin.alignment.set",args:"left"},a.center={title:this.lang.get("align-center"),api:"plugin.alignment.set",args:"center"},a.right={title:this.lang.get("align-right"),api:"plugin.alignment.set",args:"right"},a.justify={title:this.lang.get("align-justify"),api:"plugin.alignment.set",args:"justify"};var b=this.toolbar.addButton("alignment",{title:this.lang.get("align")});b.setIcon('<i class="re-icon-alignment"></i>'),b.setDropdown(a)},set:function(a){if("left"===a&&"ltr"===this.opts.direction)return this._remove();var b={style:{"text-align":a}};this.block.toggle(b)},_remove:function(){this.block.remove({style:"text-align"})}}),Redactor.add("plugin","counter",{translations:{en:{words:"words",chars:"chars"}},init:function(a){this.app=a,this.lang=a.lang,this.utils=a.utils,this.editor=a.editor,this.statusbar=a.statusbar},start:function(){this.editor.getElement().on("keyup.redactor-plugin-counter",this.count.bind(this)),this.count()},stop:function(){this.editor.getElement().off(".redactor-plugin-counter"),this.statusbar.remove("words"),this.statusbar.remove("chars")},count:function(){var a=0,b=0,c=0,d=this.editor.getElement().html();if(""!==(d=this._clean(d))){var e=d.split(/\s+/),f=d.match(/\s/g);a=e?e.length:0,c=f?f.length:0,b=d.length}var g={words:a,characters:b,spaces:c};this.app.broadcast("counter",g),this.statusbar.add("words",this.lang.get("words")+": "+g.words),this.statusbar.add("chars",this.lang.get("chars")+": "+g.characters)},_clean:function(a){return a=(a=(a=(a=(a=(a=(a=a.replace(/<\/(.*?)>/gi," ")).replace(/<(.*?)>/gi,"")).replace(/\t/gi,"")).replace(/\n/gi," ")).replace(/\r/gi," ")).replace(/&nbsp;/g,"1")).trim(),a=this.utils.removeInvisibleChars(a)}}),function(a){a.add("plugin","filesafe",{modals:{filesafe:'<div id="filesafe-react-client">                  </div>'},translations:{en:{filesafe:"FileSafe","filesafe-label":"Please, type some text"}},init:function(a){this.app=a,this.filesafe=window.filesafe_params,this.lang=a.lang,this.toolbar=a.toolbar,this.insertion=a.insertion},onmodal:{filesafe:{opened:function(a,b){const c=document.getElementById("filesafe-react-client");this.filesafe.embed.FilesafeEmbed.renderInElement(c,this.filesafe.client)},closed:function(){const a=document.getElementById("filesafe-react-client");this.filesafe.embed.FilesafeEmbed.unload(a)}}},start:function(){var a={title:"FileSafe",api:"plugin.filesafe.open"};this.toolbar.addButton("filesafe",a).setIcon('<i class="re-icon-clips"></i>')},open:function(){var a={title:this.lang.get("filesafe"),width:"600px",height:"500px",name:"filesafe",commands:{}};this.app.api("module.modal.build",a)}})}(Redactor),function(a){a.add("plugin","fontcolor",{translations:{en:{fontcolor:"Text Color",text:"Text",highlight:"Highlight"}},init:function(a){this.app=a,this.opts=a.opts,this.lang=a.lang,this.inline=a.inline,this.toolbar=a.toolbar,this.selection=a.selection,this.colors=this.opts.fontcolors?this.opts.fontcolors:["#ffffff","#000000","#eeece1","#1f497d","#4f81bd","#c0504d","#9bbb59","#8064a2","#4bacc6","#f79646","#ffff00","#f2f2f2","#7f7f7f","#ddd9c3","#c6d9f0","#dbe5f1","#f2dcdb","#ebf1dd","#e5e0ec","#dbeef3","#fdeada","#fff2ca","#d8d8d8","#595959","#c4bd97","#8db3e2","#b8cce4","#e5b9b7","#d7e3bc","#ccc1d9","#b7dde8","#fbd5b5","#ffe694","#bfbfbf","#3f3f3f","#938953","#548dd4","#95b3d7","#d99694","#c3d69b","#b2a2c7","#b7dde8","#fac08f","#f2c314","#a5a5a5","#262626","#494429","#17365d","#366092","#953734","#76923c","#5f497a","#92cddc","#e36c09","#c09100","#7f7f7f","#0c0c0c","#1d1b10","#0f243e","#244061","#632423","#4f6128","#3f3151","#31859b","#974806","#7f6000"]},onfontcolor:{set:function(a,b){this._set(a,b)},remove:function(a){this._remove(a)}},start:function(){var a={title:this.lang.get("fontcolor")},b=this._buildDropdown();this.$button=this.toolbar.addButton("fontcolor",a),this.$button.setIcon('<i class="re-icon-fontcolor"></i>'),this.$button.setDropdown(b)},_buildDropdown:function(){var b=a.dom('<div class="redactor-dropdown-cells">');return this.$selector=this._buildSelector(),this.$selectorText=this._buildSelectorItem("text",this.lang.get("text")),this.$selectorText.addClass("active"),this.$selectorBack=this._buildSelectorItem("back",this.lang.get("highlight")),this.$selector.append(this.$selectorText),this.$selector.append(this.$selectorBack),this.$pickerText=this._buildPicker("textcolor"),this.$pickerBack=this._buildPicker("backcolor"),b.append(this.$selector),b.append(this.$pickerText),b.append(this.$pickerBack),this._buildSelectorEvents(),b.width(242),b},_buildSelector:function(){var b=a.dom("<div>");return b.addClass("redactor-dropdown-selector"),b},_buildSelectorItem:function(b,c){var d=a.dom("<span>");return d.attr("rel",b).html(c),d.addClass("redactor-dropdown-not-close"),d},_buildSelectorEvents:function(){this.$selectorText.on("mousedown",function(a){a.preventDefault(),this.$selector.find("span").removeClass("active"),this.$pickerBack.hide(),this.$pickerText.show(),this.$selectorText.addClass("active")}.bind(this)),this.$selectorBack.on("mousedown",function(a){a.preventDefault(),this.$selector.find("span").removeClass("active"),this.$pickerText.hide(),this.$pickerBack.show(),this.$selectorBack.addClass("active")}.bind(this))},_buildPicker:function(b){for(var c=a.dom('<div class="re-dropdown-box-'+b+'">'),d="backcolor"==b?"background-color":"color",e=this.colors.length,f=this,g=function(b){b.preventDefault();var c=a.dom(b.target);f._set(c.data("rule"),c.attr("rel"))},h=0;h<e;h++){var i=this.colors[h],j=a.dom("<span>");j.attr({rel:i,"data-rule":d}),j.css({"background-color":i,"font-size":0,border:"2px solid #fff",width:"22px",height:"22px"}),j.on("mousedown",g),c.append(j)}var k=a.dom("<a>");return k.attr({href:"#"}),k.css({display:"block",clear:"both",padding:"8px 5px","font-size":"12px","line-height":1}),k.html(this.lang.get("none")),k.on("click",function(a){a.preventDefault(),f._remove(d)}),c.append(k),"backcolor"==b&&c.hide(),c},_set:function(a,b){var c={};c[a]=b;var d={tag:"span",style:c,type:"toggle"};this.inline.format(d)},_remove:function(a){this.inline.remove({style:a})}})}(Redactor),Redactor.add("plugin","fontfamily",{translations:{en:{fontfamily:"Font","remove-font-family":"Remove Font Family"}},init:function(a){this.app=a,this.opts=a.opts,this.lang=a.lang,this.inline=a.inline,this.toolbar=a.toolbar,this.fonts=this.opts.fontfamily?this.opts.fontfamily:["Arial","Helvetica","Georgia","Times New Roman","Monospace"]},start:function(){for(var a={},b=0;b<this.fonts.length;b++){var c=this.fonts[b];a[b]={title:c.replace(/'/g,""),api:"plugin.fontfamily.set",args:c}}a.remove={title:this.lang.get("remove-font-family"),api:"plugin.fontfamily.remove"};var d=this.toolbar.addButton("fontfamily",{title:this.lang.get("fontfamily")});d.setIcon('<i class="re-icon-fontfamily"></i>'),d.setDropdown(a)},set:function(a){var b={tag:"span",style:{"font-family":a},type:"toggle"};this.inline.format(b)},remove:function(){this.inline.remove({style:"font-family"})}}),function(a){a.add("plugin","fontsize",{translations:{en:{size:"Size","remove-size":"Remove Font Size"}},init:function(a){this.app=a,this.lang=a.lang,this.inline=a.inline,this.toolbar=a.toolbar,this.sizes=[10,11,12,14,16,18,20,24,28,30]},start:function(){for(var a={},b=0;b<this.sizes.length;b++){var c=this.sizes[b];a[b]={title:c+"px",api:"plugin.fontsize.set",args:c}}a.remove={title:this.lang.get("remove-size"),api:"plugin.fontsize.remove"};var d=this.toolbar.addButton("fontsize",{title:this.lang.get("size")});d.setIcon('<i class="re-icon-fontsize"></i>'),d.setDropdown(a)},set:function(a){var b={tag:"span",style:{"font-size":a+"px"},type:"toggle"};this.inline.format(b)},remove:function(){this.inline.remove({style:"font-size"})}})}(Redactor),function(a){a.add("plugin","imagemanager",{translations:{en:{choose:"Choose"}},init:function(a){this.app=a,this.lang=a.lang,this.opts=a.opts},onmodal:{image:{open:function(a,b){this.opts.imageManagerJson&&this._load(a)}}},_load:function(b){var c=b.getBody();this.$box=a.dom("<div>"),this.$box.attr("data-title",this.lang.get("choose")),this.$box.addClass("redactor-modal-tab"),this.$box.hide(),this.$box.css({overflow:"auto",height:"300px","line-height":1}),c.append(this.$box),a.ajax.get({url:this.opts.imageManagerJson,success:this._parse.bind(this)})},_parse:function(b){for(var c in b){var d=b[c];if("object"==typeof d){var e=a.dom("<img>"),f=d.thumb?d.thumb:d.url;e.attr("src",f),e.attr("data-params",encodeURI(JSON.stringify(d))),e.css({width:"96px",height:"72px",margin:"0 4px 2px 0",cursor:"pointer"}),e.on("click",this._insert.bind(this)),this.$box.append(e)}}},_insert:function(b){b.preventDefault();var c=a.dom(b.target),d=JSON.parse(decodeURI(c.attr("data-params")));this.app.api("module.image.insert",{image:d})}})}(Redactor),function(a){a.add("plugin","inlinestyle",{translations:{en:{style:"Style"}},init:function(a){this.app=a,this.lang=a.lang,this.toolbar=a.toolbar,this.styles={marked:{title:"Marked",args:"mark"},code:{title:"Code",args:"code"},variable:{title:"Variable",args:"var"},shortcut:{title:"Shortcut",args:"kbd"},sup:{title:"Superscript",args:"sup"},sub:{title:"Subscript",args:"sub"}}},start:function(){var a={};for(var b in this.styles){var c=this.styles[b];a[b]={title:c.title,api:"module.inline.format",args:c.args}}var d=this.toolbar.addButtonAfter("format","inline",{title:this.lang.get("style")});d.setIcon('<i class="re-icon-inline"></i>'),d.setDropdown(a)}})}(Redactor),function(a){a.add("plugin","specialchars",{translations:{en:{specialchars:"Special Characters"}},init:function(a){this.app=a,this.lang=a.lang,this.toolbar=a.toolbar,this.insertion=a.insertion,this.chars=["&lsquo;","&rsquo;","&ldquo;","&rdquo;","&ndash;","&mdash;","&divide;","&hellip;","&trade;","&bull;","&rarr;","&asymp;","$","&euro;","&cent;","&pound;","&yen;","&iexcl;","&curren;","&brvbar;","&sect;","&uml;","&copy;","&ordf;","&laquo;","&raquo;","&not;","&reg;","&macr;","&deg;","&sup1;","&sup2;","&sup3;","&acute;","&micro;","&para;","&middot;","&cedil;","&ordm;","&frac14;","&frac12;","&frac34;","&iquest;","&Agrave;","&Aacute;","&Acirc;","&Atilde;","&Auml;","&Aring;","&AElig;","&Ccedil;","&Egrave;","&Eacute;","&Ecirc;","&Euml;","&Igrave;","&Iacute;","&Icirc;","&Iuml;","&ETH;","&Ntilde;","&Ograve;","&Oacute;","&Ocirc;","&Otilde;","&Ouml;","&times;","&Oslash;","&Ugrave;","&Uacute;","&Ucirc;","&Uuml;","&Yacute;","&THORN;","&szlig;","&agrave;","&aacute;","&acirc;","&atilde;","&auml;","&aring;","&aelig;","&ccedil;","&egrave;","&eacute;","&ecirc;","&euml;","&igrave;","&iacute;","&icirc;","&iuml;","&eth;","&ntilde;","&ograve;","&oacute;","&ocirc;","&otilde;","&ouml;","&oslash;","&ugrave;","&uacute;","&ucirc;","&uuml;","&yacute;","&thorn;","&yuml;","&OElig;","&oelig;","&#372;","&#374","&#373","&#375;"]},start:function(){var a={title:this.lang.get("specialchars")},b=this._buildDropdown();this.$button=this.toolbar.addButton("specialchars",a),this.$button.setIcon('<i class="re-icon-specialcharacters"></i>'),this.$button.setDropdown(b)},_set:function(a){this.insertion.insertChar(a)},_buildDropdown:function(){for(var b=this,c=a.dom('<div class="redactor-dropdown-cells">'),d=function(c){c.preventDefault();var d=a.dom(c.target);b._set(d.data("char"))},e=0;e<this.chars.length;e++){var f=a.dom("<a>");f.attr({href:"#","data-char":this.chars[e]}),f.css({"line-height":"32px",width:"32px",height:"32px"}),f.html(this.chars[e]),f.on("click",d),c.append(f)}return c}})}(Redactor),function(a){a.add("plugin","table",{translations:{en:{table:"Table","insert-table":"Insert table","insert-row-above":"Insert row above","insert-row-below":"Insert row below","insert-column-left":"Insert column left","insert-column-right":"Insert column right","add-head":"Add head","delete-head":"Delete head","delete-column":"Delete column","delete-row":"Delete row","delete-table":"Delete table"}},init:function(a){this.app=a,this.lang=a.lang,this.opts=a.opts,this.caret=a.caret,this.editor=a.editor,this.toolbar=a.toolbar,this.component=a.component,this.inspector=a.inspector,this.insertion=a.insertion,this.selection=a.selection},ondropdown:{table:{observe:function(a){this._observeDropdown(a)}}},onbottomclick:function(){this.insertion.insertToEnd(this.editor.getLastNode(),"table")},start:function(){var a={observe:"table","insert-table":{title:this.lang.get("insert-table"),api:"plugin.table.insert"},"insert-row-above":{title:this.lang.get("insert-row-above"),classname:"redactor-table-item-observable",api:"plugin.table.addRowAbove"},"insert-row-below":{title:this.lang.get("insert-row-below"),classname:"redactor-table-item-observable",api:"plugin.table.addRowBelow"},"insert-column-left":{title:this.lang.get("insert-column-left"),classname:"redactor-table-item-observable",api:"plugin.table.addColumnLeft"},"insert-column-right":{title:this.lang.get("insert-column-right"),classname:"redactor-table-item-observable",api:"plugin.table.addColumnRight"},"add-head":{title:this.lang.get("add-head"),classname:"redactor-table-item-observable",api:"plugin.table.addHead"},"delete-head":{title:this.lang.get("delete-head"),classname:"redactor-table-item-observable",api:"plugin.table.deleteHead"},"delete-column":{title:this.lang.get("delete-column"),classname:"redactor-table-item-observable",api:"plugin.table.deleteColumn"},"delete-row":{title:this.lang.get("delete-row"),classname:"redactor-table-item-observable",api:"plugin.table.deleteRow"},"delete-table":{title:this.lang.get("delete-table"),classname:"redactor-table-item-observable",api:"plugin.table.deleteTable"}},b={title:this.lang.get("table")},c=this.toolbar.addButtonBefore("link","table",b);c.setIcon('<i class="re-icon-table"></i>'),c.setDropdown(a)},insert:function(){for(var a=this.component.create("table"),b=0;b<2;b++)a.addRow(3);a=this.insertion.insertHtml(a),this.caret.setStart(a)},addRowAbove:function(){var a=this._getComponent();if(a){var b=this.selection.getCurrent(),c=a.addRowTo(b,"before");this.caret.setStart(c)}},addRowBelow:function(){var a=this._getComponent();if(a){var b=this.selection.getCurrent(),c=a.addRowTo(b,"after");this.caret.setStart(c)}},addColumnLeft:function(){var a=this._getComponent();if(a){var b=this.selection.getCurrent();this.selection.save(),a.addColumnTo(b,"left"),this.selection.restore()}},addColumnRight:function(){var a=this._getComponent();if(a){var b=this.selection.getCurrent();this.selection.save(),a.addColumnTo(b,"right"),this.selection.restore()}},addHead:function(){var a=this._getComponent();a&&(this.selection.save(),a.addHead(),this.selection.restore())},deleteHead:function(){var b=this._getComponent();if(b){var c=this.selection.getCurrent();0!==a.dom(c).closest("thead").length?(b.removeHead(),this.caret.setStart(b)):(this.selection.save(),b.removeHead(),this.selection.restore())}},deleteColumn:function(){var b=this._getComponent();if(b){var c=this.selection.getCurrent(),d=a.dom(c).closest("td, th"),e=d.nextElement().get(),f=d.prevElement().get();b.removeColumn(c),e?this.caret.setStart(e):f?this.caret.setEnd(f):this.deleteTable()}},deleteRow:function(){var b=this._getComponent();if(b){var c=this.selection.getCurrent(),d=a.dom(c).closest("tr"),e=d.nextElement().get(),f=d.prevElement().get();b.removeRow(c),e?this.caret.setStart(e):f?this.caret.setEnd(f):this.deleteTable()}},deleteTable:function(){var a=this._getTable();a&&this.component.remove(a)},_getTable:function(){var a=this.selection.getCurrent(),b=this.inspector.parse(a);if(b.isTable())return b.getTable()},_getComponent:function(){var a=this.selection.getCurrent(),b=this.inspector.parse(a);if(b.isTable()){var c=b.getTable();return this.component.create("table",c)}},_observeDropdown:function(a){var b=this._getTable(),c=a.getItemsByClass("redactor-table-item-observable"),d=a.getItem("insert-table");b?(this._observeItems(c,"enable"),d.disable()):(this._observeItems(c,"disable"),d.enable())},_observeItems:function(a,b){for(var c=0;c<a.length;c++)a[c][b]()}})}(Redactor),function(a){a.add("class","table.component",{mixins:["dom","component"],init:function(a,b){return this.app=a,b&&void 0!==b.cmnt?b:this._init(b)},addHead:function(){this.removeHead();var b=this.$element.find("tr").first().children("td, th").length,c=a.dom("<thead>"),d=this._buildRow(b,"<th>");c.append(d),this.$element.prepend(c)},addRow:function(a){var b=this._buildRow(a);return this.$element.append(b),b},addRowTo:function(a,b){return this._addRowTo(a,b)},addColumnTo:function(b,c){var d=a.dom(b),e=d.closest("tr"),f=d.closest("td, th"),g=0;e.find("td, th").each(function(a,b){a===f.get()&&(g=b)}),this.$element.find("tr").each(function(b){var d=a.dom(b).find("td, th").get(g),e=a.dom(d),f=e.clone();f.html(""),"right"===c?e.after(f):e.before(f)})},removeHead:function(){var a=this.$element.find("thead");0!==a.length&&a.remove()},removeRow:function(b){a.dom(b).closest("tr").remove()},removeColumn:function(b){var c=a.dom(b),d=c.closest("tr"),e=c.closest("td, th"),f=0;d.find("td, th").each(function(a,b){a===e.get()&&(f=b)}),this.$element.find("tr").each(function(b){var c=a.dom(b).find("td, th").get(f);a.dom(c).remove()})},_init:function(b){var c,d;if(void 0!==b){var e=a.dom(b),f=e.get(),g=e.closest("figure");0!==g.length?(c=g,d=g.find("table").get()):"TABLE"===f.tagName&&(d=f)}this._buildWrapper(c),this._buildElement(d),this._initWrapper()},_addRowTo:function(b,c){var d=a.dom(b).closest("tr");if(0!==d.length){var e=d.children("td, th").length,f=this._buildRow(e);return d[c](f),f}},_buildRow:function(b,c){c=c||"<td>";for(var d=a.dom("<tr>"),e=0;e<b;e++){var f=a.dom(c);f.attr("contenteditable",!0),d.append(f)}return d},_buildElement:function(b){b?this.$element=a.dom(b):(this.$element=a.dom("<table>"),this.append(this.$element))},_buildWrapper:function(a){a=a||"<figure>",this.parse(a)},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"table",tabindex:"-1",contenteditable:!1}),this.app.detector.isIe()&&this.removeAttr("contenteditable")}})}(Redactor),Redactor.add("plugin","textdirection",{translations:{en:{"change-text-direction":"RTL-LTR","left-to-right":"Left to Right","right-to-left":"Right to Left"}},init:function(a){this.app=a,this.lang=a.lang,this.block=a.block,this.toolbar=a.toolbar},start:function(){var a={};a.ltr={title:this.lang.get("left-to-right"),api:"plugin.textdirection.set",args:"ltr"},a.rtl={title:this.lang.get("right-to-left"),api:"plugin.textdirection.set",args:"rtl"};var b=this.toolbar.addButton("textdirection",{title:this.lang.get("change-text-direction")});b.setIcon('<i class="re-icon-textdirection"></i>'),b.setDropdown(a)},set:function(a){this.block.add({attr:{dir:a}})}}),Redactor.add("plugin","textexpander",{init:function(a){this.app=a,this.opts=a.opts,this.utils=a.utils,this.editor=a.editor,this.marker=a.marker,this.keycodes=a.keycodes,this.selection=a.selection},start:function(){this.opts.textexpander&&this.editor.getElement().on("keyup.redactor-plugin-textexpander",this._expand.bind(this))},stop:function(){this.editor.getElement().off(".redactor-plugin-textexpander")},_expand:function(a){if(a.which===this.keycodes.SPACE)for(var b=this.opts.textexpander.length,c=0;c<b;c++){var d=this.opts.textexpander[c],e=new RegExp(this.utils.escapeRegExp(d[0])+"\\s$"),f=this.selection.getTextBeforeCaret(d[0].length+1).replace(/\s$/,"");if(d[0]===f)return this._replaceSelection(e,d[1])}},_replaceSelection:function(a,b){var c=this.marker.insert("start").previousSibling,d=c.textContent;d=(d=d.replace(/&nbsp;/," ")).replace(a,b),c.textContent=d,this.selection.restoreMarkers()}}),function(a){a.add("plugin","variable",{translations:{en:{change:"Change",variable:"Variable","variable-select":"Please, select a variable"}},modals:{variable:""},init:function(a){this.app=a,this.lang=a.lang,this.opts=a.opts,this.toolbar=a.toolbar,this.component=a.component,this.insertion=a.insertion,this.inspector=a.inspector,this.selection=a.selection},onmodal:{variable:{open:function(a,b){this._build(a)}}},oncontextbar:function(a,b){var c=this.inspector.parse(a.target);if(c.isComponentType("variable")){var d=c.getComponent(),e={change:{title:this.lang.get("change"),api:"plugin.variable.open",args:d},remove:{title:this.lang.get("delete"),api:"plugin.variable.remove",args:d}};b.set(a,d,e,"bottom")}},start:function(){if(this.opts.variables){var a={title:this.lang.get("variable"),api:"plugin.variable.open"};this.toolbar.addButton("variable",a).setIcon('<i class="re-icon-variable"></i>')}},open:function(){var a={title:this.lang.get("variable"),width:"600px",name:"variable"};this.$currentItem=this._getCurrent(),this.app.api("module.modal.build",a)},insert:function(a){this.app.api("module.modal.close");var b=a.attr("data-type"),c=this.component.create("variable");c.html(b),this.insertion.insertRaw(c)},remove:function(a){this.component.remove(a)},_getCurrent:function(){var a=this.selection.getCurrent(),b=this.inspector.parse(a);return b.isComponentType("variable")?this.component.build(b.getComponent()):void 0},_build:function(a){var b=a.getBody(),c=this._buildLabel(),d=this._buildList();this._buildItems(d),b.html(""),b.append(c),b.append(d)},_buildLabel:function(){var b=a.dom("<label>");return b.html(this.lang.parse("## variable-select ##:")),b},_buildList:function(){var b=a.dom("<ul>");return b.addClass("redactor-variables-list"),b},_buildItems:function(b){for(var c=this._getCurrentType(),d=this.opts.variables,e=0;e<d.length;e++){var f=d[e].trim(),g=a.dom("<li>"),h=a.dom("<span>");h.attr("data-type",f),h.html(f),h.on("click",this._toggle.bind(this)),c===f&&h.addClass("redactor-variables-item-selected"),g.append(h),b.append(g)}},_getCurrentType:function(){if(this.$currentItem){return this.$currentItem.getData().type}return!1},_toggle:function(b){var c=a.dom(b.target);this.app.api("plugin.variable.insert",c)}})}(Redactor),function(a){a.add("class","variable.component",{mixins:["dom","component"],init:function(a,b){return this.app=a,this.utils=a.utils,b&&void 0!==b.cmnt?b:this._init(b)},getData:function(){return{type:this._getType()}},_init:function(a){a=a||"<span>",this.parse(a),this._initWrapper()},_getType:function(){var a=this.text().trim();return this.utils.removeInvisibleChars(a)},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"variable",tabindex:"-1",contenteditable:!1})}})}(Redactor);